<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Beacon - Details</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Toast assets (single source of truth) -->
  <link rel="stylesheet" href="./assets/toast.css">
  <script src="./assets/toast.js" defer></script>

  <!-- REMOVE OR COMMENT OUT THIS LINE: -->
  <script src="./assets/notifications.js"></script>
  <link rel="stylesheet" href="./assets/theme.css">
  <link rel="stylesheet" href="./assets/loading.css">
  <script src="./assets/loading.js" defer></script>

  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Inter, Arial, sans-serif; }
    .table-fixed { table-layout: fixed; } td, th { white-space: nowrap; }

    /* Fixed table row height to prevent resizing during edit mode */
    .adgroup-details-table tbody tr {
      height: 2rem; /* Fixed height for consistent table dimensions */
    }
    
    .adgroup-details-table tbody td {
      vertical-align: middle;
      padding-top: 0.25rem !important;
      padding-bottom: 0.25rem !important;
    }

    /* Read-only inputs look like text */
    input[aria-readonly="true"] {
      border: none !important;
      outline: none !important;
      box-shadow: none !important;
      background: transparent !important;
      caret-color: transparent;
    }
    input[aria-readonly="true"]:focus { border: none !important; outline: none !important; box-shadow: none !important; }
    input[aria-readonly="true"]::-moz-focus-inner { border: 0 !important; }
    
    /* Read-only select styling */
    select[aria-readonly="true"] {
      border: none !important;
      outline: none !important;
      box-shadow: none !important;
      background: transparent !important;
      caret-color: transparent;
      appearance: none;
      pointer-events: none;
    }
    select[aria-readonly="true"]:focus { border: none !important; outline: none !important; box-shadow: none !important; }
    
    /* Seamless input styling to match spans - minimal size */
    .adgroup-details-input {
      background: white !important;
      border: 1px solid #d1d5db !important;
      outline: none !important;
      box-shadow: none !important;
      padding: 0.125rem 0.5rem !important;
      margin: 0 !important;
      height: auto !important;
      line-height: 1.25rem;
      font-size: 0.875rem;
      color: #374151;
      width: 100% !important;
      box-sizing: border-box;
      border-radius: 0.25rem;
    }
    
    /* Enhanced focus state for better UX */
    .adgroup-details-input:focus {
      border: 1px solid #3b82f6 !important;
      box-shadow: 0 0 0 1px #3b82f6 !important;
    }
    
    /* Select specific styling for edit mode */
    select.adgroup-details-input {
      appearance: auto;
      cursor: pointer;
    }

    /* Ellipsis dropdown styles */
    .ellipsis-dropdown {
      position: relative;
      display: inline-block;
    }
    .ellipsis-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      background-color: white;
      cursor: pointer;
      transition: background-color 0.15s ease;
    }
    .ellipsis-btn:hover {
      background-color: #f3f4f6;
    }
    .ellipsis-menu {
      position: absolute;
      right: 0;
      top: 100%;
      margin-top: 4px;
      min-width: 120px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 0.375rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      z-index: 50;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: opacity 0.15s ease, transform 0.15s ease, visibility 0.15s;
    }
    .ellipsis-menu.open {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    .ellipsis-menu-item {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      padding: 8px 12px;
      font-size: 14px;
      text-align: left;
      border: none;
      background: none;
      cursor: pointer;
      transition: background-color 0.1s ease;
    }
    .ellipsis-menu-item:first-child {
      border-radius: 0.375rem 0.375rem 0 0;
    }
    .ellipsis-menu-item:last-child {
      border-radius: 0 0 0.375rem 0.375rem;
    }
    .ellipsis-menu-item:hover {
      background-color: #f3f4f6;
    }
    .ellipsis-menu-item.delete-item {
      color: #dc2626;
    }
    .ellipsis-menu-item.delete-item:hover {
      background-color: #fef2f2;
    }
  </style>
</head>

<body class="bg-gray-100">
  <div class="flex h-screen flex-col">
    <!-- Header -->
    <header class="border-b border-gray-200 shadow-sm" style="background-color: #004E8B;">
      <div class="flex items-center justify-between px-4 py-2">
        <div class="flex items-center gap-3">
          <img src="./assets/Beaconlogo.svg" alt="Beacon Logo" class="h-12 w-auto" />
        </div>

        <nav class="flex items-center gap-3 ml-auto">
            <a href="./index.html" class="text-base text-white hover:text-blue-100" style="font-size: 1.5rem; padding-right: 15px;" onmouseover="this.style.color='#48A9FE'" onmouseout="this.style.color='white'">
            Advertisers
            </a>
          <span class="text-white select-none">|</span>

          <!-- Notifications -->
          <div class="relative">
            <button id="notificationButton" class="p-2 rounded-md  text-white relative" title="Notifications" aria-label="View notifications" onmouseover="this.style.backgroundColor=''" onmouseout="this.style.backgroundColor=''" >
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
              </svg>
              <span id="notificationDot" class="absolute top-2 right-2 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></span>
            </button>

            <!-- Dropdown -->
            <div id="notificationDropdown" class="hidden absolute right-0 mt-2 w-80 bg-white border border-gray-200 rounded-md shadow-lg z-50 max-h-96 overflow-hidden">
              <div class="p-3 border-b border-gray-200 bg-gray-50">
                <div class="flex items-center justify-between">
                  <h3 class="text-sm font-semibold text-gray-900">Notifications</h3>
                  <button id="markAllReadBtn" class="text-xs text-blue-600 hover:text-blue-800">Mark all read</button>
                </div>
              </div>

              <div class="max-h-80 overflow-y-auto">
                <div id="notificationList">
                  <!-- Sample items -->
                  <div class="p-3 border-b border-gray-100 hover:bg-gray-50 cursor-pointer notification-item" data-read="false">
                    <div class="flex items-start gap-3">
                      <div class="flex-shrink-0 w-2 h-2 bg-blue-500 rounded-full mt-2"></div>
                      <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900">Campaign Performance Alert</p>
                        <p class="text-xs text-gray-500 mt-1">"Summer Sale" exceeded budget by 15%</p>
                        <p class="text-xs text-gray-400 mt-1">2 minutes ago</p>
                      </div>
                    </div>
                  </div>

                  <div class="p-3 border-b border-gray-100 hover:bg-gray-50 cursor-pointer notification-item" data-read="false">
                    <div class="flex items-start gap-3">
                      <div class="flex-shrink-0 w-2 h-2 bg-green-500 rounded-full mt-2"></div>
                      <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900">New Advertiser Added</p>
                        <p class="text-xs text-gray-500 mt-1">Stallion Services LLC onboarded</p>
                        <p class="text-xs text-gray-400 mt-1">1 hour ago</p>
                      </div>
                    </div>
                  </div>

                  <div class="p-3 border-b border-gray-100 hover:bg-gray-50 cursor-pointer notification-item" data-read="true">
                    <div class="flex items-start gap-3">
                      <div class="flex-shrink-0 w-2 h-2 bg-gray-300 rounded-full mt-2"></div>
                      <div class="flex-1 min-w-0">
                        <p class="text-sm text-gray-700">Account Sync Complete</p>
                        <p class="text-xs text-gray-500 mt-1">CRM sync finished for 12 accounts</p>
                        <p class="text-xs text-gray-400 mt-1">3 hours ago</p>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="p-3 text-center border-t border-gray-200">
                  <a href="#" class="text-sm text-blue-600 hover:text-blue-800 font-medium">View all notifications</a>
                </div>
              </div>
            </div>
          </div>

          <!-- Waffle Menu -->
          <div class="relative">
            <button class="p-0 rounded-md text-white" id="menuButton" title="Menu" aria-label="Open navigation menu">
              <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                <path d="M4 4h3v3H4V4zM8.5 4h3v3h-3V4zM13 4h3v3h-3V4zM4 8.5h3v3H4v-3zM8.5 8.5h3v3h-3V8.5zM13 8.5h3v3h-3V8.5zM4 13h3v3H4v-3zM8.5 13h3v3h-3V13zM13 13h3v3h-3V13z"></path>
              </svg>
            </button>
            <div id="menuDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-md shadow-lg">
              <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Advertisers</a>
              <a href="#" id="menuProfile" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Profile</a>
              <a href="./Admin_Users.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Admin</a>
              <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Sign Out</a>
            </div>
          </div>
        </nav>
      </div>
    </header>

    <!-- Breadcrumb Bar -->
    <div class="bg-white border-b border-gray-200 px-6 py-2">
      <nav class="flex items-center text-sm text-gray-600">
        <a href="./index.html" class="hover:text-blue-600 transition-colors">Advertisers</a>
        <svg class="w-4 h-4 mx-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
        <span class="font-semibold text-gray-900" id="breadcrumbAdvertiser">—</span>
      </nav>
    </div>

    <!-- Body -->
    <div class="flex flex-1 overflow-hidden">
      <!-- Sidebar -->
      <nav id="sidebar" class="bg-white w-64 p-4 border-r border-gray-200 overflow-y-auto transition-all duration-200 ease-in-out">
  <div class="flex items-center justify-between pb-4 border-b border-gray-200">
    <div class="flex items-center gap-3">
      <img src="./assets/advertiser.png" alt="Advertiser" class="w-9 h-9 rounded-full" data-sidebar-avatar />
      <h2 data-sidebar-header class="text-base text-lg font-semibold text-gray-800">Advertiser</h2>
    </div>
    <button id="sidebarToggle" class="p-1 rounded hover:bg-gray-100" aria-label="Toggle sidebar" aria-expanded="true" title="Collapse/Expand">
      <svg id="iconCollapse" class="w-5 h-5 text-gray-900" viewBox="0 0 26 26" fill="currentColor">
        <path fill="#000000" d="M21.5 11.5h-8.793l3.035-3.035a.5.5 0 10-.707-.707l-3.888 3.888a.518.518 0 00-.109.163.505.505 0 000 .382.518.518 0 00.109.163l3.888 3.888a.5.5 0 00.707-.707L12.707 12.5H21.5a.5.5 0 000-1zM7.5 2h-5a.5.5 0 000 1h5a.5.5 0 000-1zM7.5 7h-5a.5.5 0 000 1h5a.5.5 0 000-1zM7.5 11.5h-5a.5.5 0 000 1h5a.5.5 0 000-1zM7.5 16h-5a.5.5 0 000 1h5a.5.5 0 000-1zM7.5 21h-5a.5.5 0 000 1h5a.5.5 0 000-1z"></path>
      </svg>
      <svg id="iconExpand" class="w-5 h-5 text-gray-900 hidden" viewBox="0 0 26 26" fill="currentColor">
        <path fill="#000000" d="M21.962 12.191a.505.505 0 000-.382.518.518 0 00-.109-.163l-3.888-3.888a.5.5 0 10-.707.707l3.035 3.035H11.5a.5.5 0 000 1h8.793l-3.035 3.035a.5.5 0 10.707.707l3.888-3.888a.518.518 0 00.109-.163zM7.5 2h-5a.5.5 0 000 1h5a.5.5 0 000-1zM7.5 7h-5a.5.5 0 000 1h5a.5.5 0 000-1zM7.5 11.5h-5a.5.5 0 000 1h5a.5.5 0 000-1zM7.5 16h-5a.5.5 0 000 1h5a.5.5 0 000-1zM7.5 21h-5a.5.5 0 000 1h5a.5.5 0 000-1z"></path>
      </svg>
    </button>
  </div>

  <ul class="space-y-1 mt-4">
    <li>
      <a href="./WFAdvertiserDetails.html" data-nav-link class="flex items-center px-1 py-2 text-sm font-medium text-blue-700 bg-blue-50 rounded-md">
        <img src="./assets/svgs/Details.svg" alt="Details" class="w-6 h-6 mr-2" />
        <span data-link-label>Overview</span>
      </a>
    
    <!-- <li>
      <a href="./AdvertiserSalesOrder.html" data-nav-link class="flex items-center px-1 py-2 text-sm text-gray-700 hover:bg-blue-50 rounded-md">
        <img src="./assets/svgs/SalesOrderExpense.svg" alt="Sales Orders" class="w-6 h-6 mr-2" />
        <span data-link-label>Sales Orders</span>
      </a>
    </li> -->
     <li>
      <a href="./WFAdvertiserConnections.html" data-nav-link class="flex items-center px-1 py-2 text-sm text-gray-700 hover:bg-blue-50 rounded-md">
        <img src="./assets/svgs/Blueprint.svg" alt="Connections" class="w-6 h-6 mr-2" />
        <span data-link-label>Connections</span>
      </a>
    </li>
    <li>
      <a href="./AdvertiserCampaigns.html" data-nav-link class="flex items-center px-1 py-2 text-sm text-gray-700 hover:bg-blue-50 rounded-md">
        <img src="./assets/svgs/CampaignsSchedules.svg" alt="Campaigns" class="w-6 h-6 mr-2" />
        <span data-link-label>Campaigns</span>
      </a>
    </li>
    <li>
      <a href="./AdvertiserChangeOrders.html" data-nav-link
         class="flex items-center px-1 py-2 text-sm text-gray-700 hover:bg-blue-50 rounded-md">
        <svg class="w-6 h-6 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
        </svg>
        <span data-link-label>Change Orders</span>
      </a>
    </li>
    <li>
      <a href="./AdvertiserAdGroup.html" data-nav-link class="flex items-center px-1 py-2 text-sm text-gray-700 hover:bg-blue-50 rounded-md">
        <img src="./assets/svgs/AdGroups.svg" class="w-6 h-6 mr-2" alt="">
        <span data-link-label>Ad Groups</span>
      </a>
    </li>
  
  </ul>
</nav>

      <!-- Main -->
      <main class="flex-1 overflow-y-auto p-6">
        <div class="bg-white rounded-lg shadow-sm">
          <div class="p-4 border-b border-gray-200">
            <div class="flex items-start justify-between gap-4 mb-3">
              <!-- Left Column: Advertiser Name & Account # -->
              <div>
                <h1 data-bind="adv.name" class="md:text-2xl font-semibold text-gray-900">Loading…</h1>
                <h3 class="text-sm font-semibold text-gray-600">Account #: <span data-bind="adv.account" class="text-sm text-gray-500">—</span></h3>
              </div>
              <!-- Right Column: IDs -->
              <div class="text-right">
                <div class="flex justify-end gap-2">
                  <span class="text-sm font-semibold text-gray-600">Delivery ID:</span>
                  <a id="deliveryIdLink" href="https://www.thetradedesk.com/" target="_blank" class="text-sm text-blue-600 hover:text-blue-800 hover:underline w-28 text-left" data-bind="adv.deliveryId">—</a>
                </div>
                <div class="flex justify-end gap-2">
                  <span class="text-sm font-semibold text-gray-600">Reporting ID:</span>
                  <a id="reportingIdLink" href="https://campaignmanager.google.com/" target="_blank" class="text-sm text-blue-600 hover:text-blue-800 hover:underline w-28 text-left" data-bind="adv.reportingId">—</a>
                </div>
                <div class="flex justify-end gap-2">
                  <span class="text-sm font-semibold text-gray-600">ID:</span>
                  <span data-bind="adv.id" class="text-sm text-gray-500 w-28 text-left">—</span>
                </div>
              </div>
            </div>

            <hr class="border-gray-300 mp-4 p-2">

            <!-- Advertiser Details Section -->
            <section>
              <div class="flex items-center justify-between mb-6">
                <h1 class="text-2xl font-semibold text-gray-900 mx-2">ADVERTISER OVERVIEW</h1>
                <div class="flex items-center gap-2">
              <!-- New Change Order Button -->
              <button id="newChangeOrderBtn" 
                class="flex items-center gap-1.5 h-8 px-3 rounded-md text-sm font-medium text-white bg-green-600 hover:bg-green-700 transition-colors"
                onclick="document.getElementById('coPickerModal').classList.remove('hidden')"
                title="Create New Change Order">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                New Change Order
              </button>
              <!-- Ellipsis Dropdown Menu -->
              <div class="ellipsis-dropdown">
                <button id="ellipsisBtn" class="ellipsis-btn" title="More options" aria-haspopup="true" aria-expanded="false">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                    <circle cx="5" cy="12" r="2"/>
                    <circle cx="12" cy="12" r="2"/>
                    <circle cx="19" cy="12" r="2"/>
                  </svg>
                </button>
                <div id="ellipsisMenu" class="ellipsis-menu">
                  <button id="editGeneralBtn" class="ellipsis-menu-item">
                    <svg viewBox="0 0 24 24" height="16" width="16">
                      <path fill="currentColor" d="M21.53 4.11l-1.64-1.64a1.57 1.57 0 00-2.22 0L4.74 15.4a2.41 2.41 0 00-.55.83L2 21.58a.32.32 0 00.3.43h.11l5.35-2.18a2.41 2.41 0 00.83-.55l4.14-4.14 8.79-8.79a1.56 1.56 0 00.01-2.24zM5 17l2 2-3.43 1.4zm7-2.59l-4.11 4.14-2.44-2.44L16 5.53 18.47 8zm8.79-8.79l-1.62 1.65-2.44-2.44 1.65-1.66a.59.59 0 01.4-.16.58.58 0 01.4.16l1.65 1.65a.58.58 0 01.16.4.59.59 0 01-.16.4z"></path>
                    </svg>
                    Edit
                  </button>
                  <button id="deleteAdvertiserBtn" class="ellipsis-menu-item delete-item">
                    <svg viewBox="0 0 24 24" height="16" width="16">
                      <path fill="currentColor" d="M19 6h-3.5l-1-1h-5l-1 1H5v2h14V6zM6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V9H6v10zM8 11h8v8H8v-8z"/>
                    </svg>
                    Delete
                  </button>
                </div>
              </div>
              <button id="saveGeneralBtn" class="hidden text-sm px-3 py-1 bg-blue-600 text-white border border-blue-600 rounded-md hover:bg-blue-700">Save</button>
              <button id="cancelGeneralBtn" class="hidden text-sm px-3 py-1 bg-white text-gray-700 border border-gray-300 rounded-md hover:bg-gray-50">Cancel</button>
            </div>
              </div>
            </section>

            <!-- Two-column layout -->
            <div class="grid grid-cols-2 gap-6">
              
              <!-- LEFT COLUMN -->
              <div class="space-y-6">
                
                <!-- Beacon Fields -->
                <section class="space-y-2">
                  <div class="overflow-x-auto border border-default rounded-md">
                    <table class="w-full tbl tbl-row-hover table-fixed adgroup-details-table">
                      <colgroup>
                        <col class="w-1/3">
                        <col class="w-2/3">
                      </colgroup>
                      <thead class="tbl-head">
                        <tr>
                          <th colspan="2" class="px-6 py-2 text-left text-sm font-medium text-gray-700 uppercase tracking-wider">
                            BEACON FIELDS
                          </th>
                        </tr>
                      </thead>
                      <tbody class="divide-y border-default">
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">ID</td>
                          <td class="px-6 py-1 text-sm">
                            <span id="displayAdvertiserId" data-bind="adv.id" class="text-gray-800 break-words">—</span>
                          </td>
                        </tr>
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">Account #</td>
                          <td class="px-6 py-1 text-sm">
                            <span id="accountDisplay" data-bind="adv.account" class="hidden text-gray-800 break-words">—</span>
                            <button id="accountLookupBtn" class="text-sm text-blue-600 hover:text-blue-800 underline">Select Account</button>
                          </td>
                        </tr>
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">Name</td>
                          <td class="px-6 py-1 text-sm">
                            <span id="displayAdvertiserName" data-bind="adv.name" class="text-gray-800 break-words">—</span>
                            <input id="inputAdvertiserName" type="text" data-bind="adv.name" class="hidden adgroup-details-input" aria-label="Advertiser Name" title="Advertiser Name">
                          </td>
                        </tr>
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">State</td>
                          <td class="px-6 py-1 text-sm">
                            <span id="displayState" data-bind="adv.state" class="text-gray-800 break-words">—</span>
                            <select id="inputState" data-bind="adv.state" class="hidden adgroup-details-input" aria-label="Advertiser State" title="Advertiser State">
                              <option value="Active">Active</option>
                              <option value="Inactive">Inactive</option>
                            </select>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </section>

                <!-- Team Table -->
                <section class="space-y-2">
                  <div class="overflow-x-auto border border-default rounded-md">
                    <table class="w-full tbl tbl-row-hover table-fixed">
                      <colgroup>
                        <col style="width:44%">
                        <col style="width:36%">
                        <col style="width:20%">
                      </colgroup>
                      <thead class="tbl-head">
                        <tr>
                          <th colspan="3" class="px-6 py-2 text-left text-sm font-medium text-gray-700 uppercase tracking-wider">
                            <div class="flex items-center justify-between">
                              <span>TEAM</span>
                              <div class="relative">
                                <button id="teamStateChip" class="flex items-center h-8 px-3 rounded-md text-sm text-gray-700 bg-white border border-gray-300 hover:bg-gray-100 transition" data-filter="state" aria-haspopup="menu" aria-expanded="false">
                                  <span id="teamStateChipLabel">Active</span>
                                  <svg class="w-4 h-4 text-gray-500 ml-2" viewBox="0 0 20 20" fill="currentColor"><path d="M5.23 7.21a.75.75 0 011.06 0L10 10.92l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.23 8.27a.75.75 0 010-1.06z"/></svg>
                                </button>
                                <div id="teamStateMenu" class="hidden absolute right-0 mt-2 min-w-40 bg-white border border-gray-200 rounded-md shadow-lg z-20 max-h-56 overflow-auto" role="menu" tabindex="-1">
                                  <button class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-value="All" role="menuitem">All</button>
                                  <button class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-value="Active" role="menuitem">Active</button>
                                  <button class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-value="Inactive" role="menuitem">Inactive</button>
                                </div>
                              </div>
                            </div>
                          </th>
                        </tr>
                        <tr class="bg-gray-50">
                          <th class="px-3 py-2 text-left text-sm font-medium text-gray-700 uppercase tracking-wider border-r border-gray-200">Name</th>
                          <th class="px-3 py-2 text-left text-sm font-medium text-gray-700 uppercase tracking-wider border-r border-gray-200">Role</th>
                          <th class="px-3 py-2 text-left text-sm font-medium text-gray-700 uppercase tracking-wider">State</th>
                        </tr>
                      </thead>
                      <tbody id="teamTableBody" class="bg-white divide-y divide-gray-200">
                        <tr class="border-b border-default" data-state="active">
                          <td class="px-3 py-1 text-sm border-r border-default">Matt Hunter</td>
                          <td class="px-3 py-1 text-sm text-gray-700 border-r border-default">Account Manager</td>
                          <td class="px-3 py-1 text-sm"><span class="px-2 py-1 text-xs">Active</span></td>
                        </tr>
                        <tr class="border-b border-default" data-state="active">
                          <td class="px-3 py-1 text-sm border-r border-default">David DeHerrera</td>
                          <td class="px-3 py-1 text-sm text-gray-700 border-r border-default">Campaign Specialist</td>
                          <td class="px-3 py-1 text-sm"><span class="px-2 py-1 text-xs">Active</span></td>
                        </tr>
                        <tr class="border-b border-default" data-state="inactive">
                          <td class="px-3 py-1 text-sm border-r border-default">Hailey Golden</td>
                          <td class="px-3 py-1 text-sm text-gray-700 border-r border-default">Campaign Manager</td>
                          <td class="px-3 py-1 text-sm"><span class="px-2 py-1 text-xs">Inactive</span></td>
                        </tr>
                        <tr class="border-b border-default" data-state="active">
                          <td class="px-3 py-1 text-sm border-r border-default">Sam Ahn</td>
                          <td class="px-3 py-1 text-sm text-gray-700 border-r border-default">Sales Representative</td>
                          <td class="px-3 py-1 text-sm"><span class="px-2 py-1 text-xs">Active</span></td>
                        </tr>
                        <tr class="border-b border-default" data-state="inactive">
                          <td class="px-3 py-1 text-sm border-r border-default">Trevor White</td>
                          <td class="px-3 py-1 text-sm text-gray-700 border-r border-default">Partnership Sales</td>
                          <td class="px-3 py-1 text-sm"><span class="px-2 py-1 text-xs">Inactive</span></td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </section>

              </div>

              <!-- RIGHT COLUMN -->
              <div class="space-y-6">

                <!-- DSP Fields Table -->
                <section id="dspFieldsSection" class="space-y-2 hidden">
                  <div class="overflow-x-auto border border-default rounded-md">
                    <table class="w-full tbl tbl-row-hover table-fixed advertiser-details-table">
                      <colgroup>
                        <col class="w-1/3">
                        <col class="w-2/3">
                      </colgroup>
                      <thead style="background-color: #dbeafe;">
                        <tr>
                          <th colspan="2" class="px-6 py-2 text-left text-sm font-medium text-blue-900 uppercase tracking-wider">
                            DSP FIELDS • The Trade Desk
                          </th>
                        </tr>
                      </thead>
                      <tbody class="divide-y border-default">
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">Name</td>
                          <td class="px-6 py-1 text-sm">
                            <span id="displayDspName" class="text-gray-800 break-words">—</span>
                            <input id="inputDspName" type="text" class="hidden adgroup-details-input" aria-label="DSP Name" title="DSP Name">
                          </td>
                        </tr>
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">Partner</td>
                          <td class="px-6 py-1 text-sm">
                            <span id="displayDspPartner" class="text-gray-800 break-words">—</span>
                            <select id="inputDspPartner" class="hidden adgroup-details-input" aria-label="DSP Partner" title="DSP Partner">
                              <option value="">-- Select Partner --</option>
                              <option value="Multiview">Multiview</option>
                            </select>
                          </td>
                        </tr>
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">Domain Address</td>
                          <td class="px-6 py-1 text-sm">
                            <span id="displayDspDomain" class="text-gray-800 break-words">—</span>
                            <input id="inputDspDomain" type="text" class="hidden adgroup-details-input" aria-label="DSP Domain" title="DSP Domain" placeholder="https://example.com">
                          </td>
                        </tr>
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">Country</td>
                          <td class="px-6 py-1 text-sm">
                            <span id="displayDspCountry" class="text-gray-800 break-words">—</span>
                            <select id="inputDspCountry" class="hidden adgroup-details-input" aria-label="DSP Country" title="DSP Country">
                              <option value="">-- Select Country --</option>
                              <option value="United States">United States</option>
                              <option value="Canada">Canada</option>
                              <option value="United Kingdom">United Kingdom</option>
                              <option value="Australia">Australia</option>
                              <option value="Germany">Germany</option>
                              <option value="France">France</option>
                              <option value="Other">Other</option>
                            </select>
                          </td>
                        </tr>
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">Targeting EU?</td>
                          <td class="px-6 py-1 text-sm">
                            <span id="displayDspEuTargeting" class="text-gray-800 break-words">—</span>
                            <select id="inputDspEuTargeting" class="hidden adgroup-details-input" aria-label="DSP EU Targeting" title="DSP EU Targeting">
                              <option value="">-- Select --</option>
                              <option value="No">No</option>
                              <option value="Yes">Yes</option>
                            </select>
                          </td>
                        </tr>
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">Industry Category</td>
                          <td class="px-6 py-1 text-sm">
                            <span id="displayDspIndustry" class="text-gray-800 break-words">—</span>
                            <select id="inputDspIndustry" class="hidden adgroup-details-input" aria-label="DSP Industry" title="DSP Industry">
                              <option value="">-- Select Industry --</option>
                              <option value="Technology">Technology</option>
                              <option value="Healthcare">Healthcare</option>
                              <option value="Finance">Finance</option>
                              <option value="Retail">Retail</option>
                              <option value="Automotive">Automotive</option>
                              <option value="Travel">Travel</option>
                              <option value="Education">Education</option>
                              <option value="Entertainment">Entertainment</option>
                            </select>
                          </td>
                        </tr>
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">Attribution Click Window</td>
                          <td class="px-6 py-1 text-sm">
                            <span id="displayDspAttrClick" class="text-gray-800 break-words">—</span>
                            <input id="inputDspAttrClick" type="text" class="hidden adgroup-details-input" aria-label="Attribution Click Window" title="Attribution Click Window" placeholder="e.g., 90 Days">
                          </td>
                        </tr>
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">Attribution Impression Window</td>
                          <td class="px-6 py-1 text-sm">
                            <span id="displayDspAttrImpression" class="text-gray-800 break-words">—</span>
                            <input id="inputDspAttrImpression" type="text" class="hidden adgroup-details-input" aria-label="Attribution Impression Window" title="Attribution Impression Window" placeholder="e.g., 90 Days">
                          </td>
                        </tr>
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">Dedup Click Window</td>
                          <td class="px-6 py-1 text-sm">
                            <span id="displayDspDedupClick" class="text-gray-800 break-words">—</span>
                            <input id="inputDspDedupClick" type="text" class="hidden adgroup-details-input" aria-label="Dedup Click Window" title="Dedup Click Window" placeholder="e.g., 7 Seconds">
                          </td>
                        </tr>
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">Dedup Conversion Window</td>
                          <td class="px-6 py-1 text-sm">
                            <span id="displayDspDedupConversion" class="text-gray-800 break-words">—</span>
                            <input id="inputDspDedupConversion" type="text" class="hidden adgroup-details-input" aria-label="Dedup Conversion Window" title="Dedup Conversion Window" placeholder="e.g., 60 Seconds">
                          </td>
                        </tr>
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">Yahoo Integration</td>
                          <td class="px-6 py-1 text-sm">
                            <span id="displayDspYahoo" class="text-gray-800 break-words">—</span>
                            <select id="inputDspYahoo" class="hidden adgroup-details-input" aria-label="Yahoo Integration" title="Yahoo Integration">
                              <option value="">-- Select --</option>
                              <option value="Enabled">Enabled</option>
                              <option value="Disabled">Disabled</option>
                            </select>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </section>

                <!-- Ad Server Fields Table -->
                <section id="adServerFieldsSection" class="space-y-2 hidden">
                  <div class="overflow-x-auto border border-default rounded-md">
                    <table class="w-full tbl tbl-row-hover table-fixed advertiser-details-table">
                      <colgroup>
                        <col class="w-1/3">
                        <col class="w-2/3">
                      </colgroup>
                      <thead style="background-color: #d1fae5;">
                        <tr>
                          <th colspan="2" class="px-6 py-2 text-left text-sm font-medium text-green-900 uppercase tracking-wider">
                            AD SERVER FIELDS • Google Campaign Manager
                          </th>
                        </tr>
                      </thead>
                      <tbody class="divide-y border-default">
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">Advertiser Name</td>
                          <td class="px-6 py-1 text-sm">
                            <span id="displayAdServerName" class="text-gray-800 break-words">—</span>
                            <input id="inputAdServerName" type="text" class="hidden adgroup-details-input" aria-label="Ad Server Advertiser Name" title="Ad Server Advertiser Name">
                          </td>
                        </tr>
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">Advertiser Vertical</td>
                          <td class="px-6 py-1 text-sm">
                            <span id="displayAdServerVertical" class="text-gray-800 break-words">—</span>
                            <select id="inputAdServerVertical" class="hidden adgroup-details-input" aria-label="Ad Server Vertical" title="Ad Server Vertical">
                              <option value="">-- Select Vertical --</option>
                              <option value="Technology">Technology</option>
                              <option value="Healthcare">Healthcare</option>
                              <option value="Finance">Finance</option>
                              <option value="Retail">Retail</option>
                              <option value="Automotive">Automotive</option>
                              <option value="Travel">Travel</option>
                              <option value="Education">Education</option>
                              <option value="Entertainment">Entertainment</option>
                            </select>
                          </td>
                        </tr>
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">EU Political Ads</td>
                          <td class="px-6 py-1 text-sm">
                            <span id="displayAdServerEuPolitical" class="text-gray-800 break-words">—</span>
                            <select id="inputAdServerEuPolitical" class="hidden adgroup-details-input" aria-label="EU Political Ads" title="EU Political Ads">
                              <option value="">-- Select --</option>
                              <option value="Yes">Yes</option>
                              <option value="No">No</option>
                            </select>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </section>
              </div>
            </div>

          </div>

          <!-- Campaigns Section (Full Width) -->
          <div class="px-6 py-6 border-b border-gray-200">
            <section>
              <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-semibold text-gray-900 mx-2">CAMPAIGNS</h2>
              </div>
              <div class="overflow-x-auto border border-default rounded-md">
                <table id="campaignTable" class="min-w-full table-fixed rounded-md overflow-hidden tbl tbl-row-hover tbl-row-alt">
                  <colgroup>
                    <col style="width: 15%;">
                    <col style="width: 25%;">
                    <col style="width: 10%;">
                    <col style="width: 20%;">
                    <col style="width: 20%;">
                    <col style="width: 10%;">
                  </colgroup>
                  <thead class="tbl-head">
                    <tr>
                      <th scope="col" class="text-sm font-medium text-gray-700 uppercase tracking-wider border-r border-gray-200">
                        <button type="button" class="sort-btn flex w-full items-center px-6 py-2 space-x-2" data-sort-key="id">
                          <span>ID</span>
                        </button>
                      </th>
                      <th scope="col" class="text-sm font-medium text-gray-700 uppercase tracking-wider border-r border-gray-200">
                        <button type="button" class="sort-btn flex w-full items-center px-6 py-2 space-x-2" data-sort-key="name" aria-label="Sort by Name">
                          <span>Name</span>
                          <span class="sort-indicator text-xs text-gray-400" aria-hidden="true"></span>
                        </button>
                      </th>
                      <th scope="col" class="text-sm font-medium text-gray-700 uppercase tracking-wider border-r border-gray-200">
                        <button type="button" class="sort-btn flex w-full items-center px-6 py-2 space-x-2" data-sort-key="state" aria-label="Sort by State">
                          <span>State</span>
                          <span class="sort-indicator text-xs text-gray-400" aria-hidden="true"></span>
                        </button>
                      </th>
                      <th scope="col" class="text-sm font-medium text-gray-700 uppercase tracking-wider border-r border-gray-200">
                        <button type="button" class="sort-btn flex w-full items-center px-6 py-2 space-x-2" data-sort-key="dsp" aria-label="Sort by DSP">
                          <span>DSP</span>
                          <span class="sort-indicator text-xs text-gray-400" aria-hidden="true"></span>
                        </button>
                      </th>
                      <th scope="col" class="text-sm font-medium text-gray-700 uppercase tracking-wider border-r border-gray-200">
                        <button type="button" class="sort-btn flex w-full items-center px-6 py-2 space-x-2" data-sort-key="adServer" aria-label="Sort by Ad Server">
                          <span>Ad Server</span>
                          <span class="sort-indicator text-xs text-gray-400" aria-hidden="true"></span>
                        </button>
                      </th>
                      <th scope="col" class="text-sm font-medium text-gray-700 uppercase tracking-wider">
                        <button type="button" class="sort-btn flex w-full items-center px-6 py-2 space-x-2" data-sort-key="adGroups" aria-label="Sort by Ad Groups">
                          <span>Ad Groups</span>
                          <span class="sort-indicator text-xs text-gray-400" aria-hidden="true"></span>
                        </button>
                      </th>
                    </tr>
                  </thead>
                  <tbody id="campaignTableBody" class="divide-y">
                    <!-- Campaign rows will be populated by JavaScript -->
                  </tbody>
                </table>
              </div>
            </section>
          </div>

          <!-- Ad Groups Section (Full Width) -->
          <div class="px-6 py-6">
            <section>
              <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-semibold text-gray-900 mx-2">AD GROUPS</h2>
              </div>
              <div class="overflow-x-auto border border-default rounded-md">
                <table id="adGroupTable" class="min-w-full table-fixed rounded-md overflow-hidden tbl tbl-row-hover tbl-row-alt">
                  <colgroup>
                    <col style="width: 12%;">
                    <col style="width: 25%;">
                    <col style="width: 15%;">
                    <col style="width: 15%;">
                    <col style="width: 15%;">
                    <col style="width: 18%;">
                  </colgroup>
                  <thead class="tbl-head">
                    <tr>
                      <th scope="col" class="text-sm font-medium text-gray-700 uppercase tracking-wider border-r border-gray-200">
                        <button type="button" class="sort-btn flex w-full items-center px-6 py-2 space-x-2" data-sort-key="id">
                          <span>ID</span>
                        </button>
                      </th>
                      <th scope="col" class="text-sm font-medium text-gray-700 uppercase tracking-wider border-r border-gray-200">
                        <button type="button" class="sort-btn flex w-full items-center px-6 py-2 space-x-2" data-sort-key="name">
                          <span>Name</span>
                        </button>
                      </th>
                      <th scope="col" class="text-sm font-medium text-gray-700 uppercase tracking-wider border-r border-gray-200">
                        <button type="button" class="sort-btn flex w-full items-center px-6 py-2 space-x-2" data-sort-key="dsp">
                          <span>DSP</span>
                        </button>
                      </th>
                      <th scope="col" class="text-sm font-medium text-gray-700 uppercase tracking-wider border-r border-gray-200">
                        <button type="button" class="sort-btn flex w-full items-center px-6 py-2 space-x-2" data-sort-key="adServer">
                          <span>Ad Server</span>
                        </button>
                      </th>
                      <th scope="col" class="text-sm font-medium text-gray-700 uppercase tracking-wider border-r border-gray-200">
                        <button type="button" class="sort-btn flex w-full items-center px-6 py-2 space-x-2" data-sort-key="classification">
                          <span>Classification</span>
                        </button>
                      </th>
                      <th scope="col" class="text-sm font-medium text-gray-700 uppercase tracking-wider">
                        <button type="button" class="sort-btn flex w-full items-center px-6 py-2 space-x-2" data-sort-key="campaign">
                          <span>Campaign</span>
                        </button>
                      </th>
                    </tr>
                  </thead>
                  <tbody id="adGroupTableBody" class="divide-y">
                    <!-- Ad group rows will be populated by JavaScript -->
                  </tbody>
                </table>
              </div>
            </section>
          </div>

        </div>
      </main>
    </div>
  </div>

  <!-- Waffle menu toggle -->
  <script>
    const menuButton = document.getElementById('menuButton');
    const menuDropdown = document.getElementById('menuDropdown');
    if (menuButton && menuDropdown) {
      menuButton.addEventListener('click', (e) => {
        e.stopPropagation();
        menuDropdown.classList.toggle('hidden');
      });
      document.addEventListener('click', (event) => {
        if (!menuButton.contains(event.target) && !menuDropdown.contains(event.target)) {
          menuDropdown.classList.add('hidden');
        }
      });
    }
  </script>

  <!-- Details page data-binding -->
  <script>
    (function() {
      const STORAGE_KEY_DATA = 'adv_list_data';

      function loadAdvertisersFromStorage() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY_DATA);
          return raw ? JSON.parse(raw) : [];
        } catch { return []; }
      }

      function getNestedValue(obj, path, fallback = '—') {
        if (!obj || !path) return fallback;
        const keys = path.split('.');
        let value = obj;
        for (const key of keys) {
          if (value && typeof value === 'object' && key in value) {
            value = value[key];
          } else {
            return fallback;
          }
        }
        return (value != null && String(value).trim() !== '') ? value : fallback;
      }

      function formatAttributionWindow(data) {
        if (!data || typeof data !== 'object') return '—';
        const value = data.value || '';
        const unit = data.unit || 'Days';
        return value ? `${value} ${unit}` : '—';
      }

      function bindAll(key, value, fallback = '—') {
        const nodes = document.querySelectorAll(`[data-bind="${key}"]`);
        let text = (value != null && String(value).trim() !== '') ? value : fallback;
        
        // Special formatting for attribution windows
        if (key.includes('attributionWindows')) {
          text = formatAttributionWindow(value);
        }
        
        nodes.forEach(el => {
          if (el.tagName === 'INPUT' || el.tagName === 'SELECT') {
            el.value = text;
            el.setAttribute('data-original', text);
          } else {
            el.textContent = text;
            if (key === 'adv.account') {
              const accountDisplay = document.getElementById('accountDisplay');
              const accountLookupBtn = document.getElementById('accountLookupBtn');
              if (accountDisplay && accountLookupBtn) {
                if (text && text !== '—' && text !== 'N/A') {
                  accountDisplay.classList.remove('hidden');
                  accountLookupBtn.classList.add('hidden');
                } else {
                  accountDisplay.classList.add('hidden');
                  accountLookupBtn.classList.remove('hidden');
                }
              }
            }
          }
        });
      }

      document.addEventListener('DOMContentLoaded', () => {
        console.log('[DATA BINDING SCRIPT] Starting at:', new Date().toISOString());
        let adv = null;
        try {
          const rawObj = localStorage.getItem('adv_selected_data');
          console.log('[DATA BINDING] Raw adv_selected_data:', rawObj);
          if (rawObj) adv = JSON.parse(rawObj);
          console.log('[DATA BINDING] Parsed advertiser:', adv?.name, 'ID:', adv?.id);
          console.log('[DATA BINDING] DSP data:', adv?.dsp);
          console.log('[DATA BINDING] Ad Server data:', adv?.adServer);
        } catch (e) {
          console.error('[DATA BINDING] Error parsing adv_selected_data:', e);
        }

        const selectedId = localStorage.getItem('adv_selected_id');
        if (!adv && selectedId) {
          const advertisers = loadAdvertisersFromStorage();
          adv = advertisers.find(a => String(a.id) === String(selectedId)) || null;
          console.log('Loaded advertiser from list by ID:', adv);
        }
        if (!adv) {
          const advertisers = loadAdvertisersFromStorage();
          adv = (advertisers && advertisers.length) ? advertisers[0] : null;
          console.log('Fallback to first advertiser:', adv);
        }

        // Populate breadcrumb
        if (adv) {
          const breadcrumbAdvertiser = document.getElementById('breadcrumbAdvertiser');
          if (breadcrumbAdvertiser) {
            breadcrumbAdvertiser.textContent = `Advertiser: ${adv.name || 'Unknown'}`;
          }
        }

        if (adv) {
          // MIGRATION: Handle both 'status' and 'state' fields for backward compatibility
          if (adv.status && !adv.state) {
            adv.state = adv.status;
          }
          
          // Bind Beacon fields
          bindAll('adv.name', adv.name, 'No advertiser found');
          bindAll('adv.id', adv.id, '');
          bindAll('adv.account', adv.account, 'N/A');
          bindAll('adv.state', adv.state, 'N/A');
          
          // Generate and persist mock DSP/Ad Server IDs if they don't exist
          let needsUpdate = false;
          if (!adv.deliveryId) {
            adv.deliveryId = 'DLV-' + Math.random().toString(36).substr(2, 8).toUpperCase();
            needsUpdate = true;
          }
          if (!adv.reportingId) {
            adv.reportingId = 'RPT-' + Math.random().toString(36).substr(2, 8).toUpperCase();
            needsUpdate = true;
          }
          
          // Save back to localStorage if IDs were generated
          if (needsUpdate) {
            localStorage.setItem('adv_selected_data', JSON.stringify(adv));
            // Also update in the advertisers list
            const advertisers = loadAdvertisersFromStorage();
            const idx = advertisers.findIndex(a => String(a.id) === String(adv.id));
            if (idx !== -1) {
              advertisers[idx] = adv;
              localStorage.setItem('adv_list_data', JSON.stringify(advertisers));
            }
          }
          
          bindAll('adv.deliveryId', adv.deliveryId, '—');
          bindAll('adv.reportingId', adv.reportingId, '—');
          
          // Bind DSP fields if they exist
          console.log('Checking DSP data to bind:', adv.dsp);
          if (adv.dsp) {
            console.log('DSP data exists, populating fields...');
            // Populate DSP display spans directly
            const dspName = document.getElementById('displayDspName');
            console.log('displayDspName element:', dspName);
            console.log('displayDspName current content:', dspName?.textContent);
            if (dspName) {
              dspName.textContent = adv.dsp.name || '—';
              console.log('displayDspName set to:', dspName.textContent);
              
              // Watch for changes to this span
              const nameObserver = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                  console.log('[DSP NAME WATCHER] Content changed to:', dspName.textContent);
                  console.trace('[DSP NAME WATCHER] Stack trace:');
                });
              });
              nameObserver.observe(dspName, { childList: true, characterData: true, subtree: true });
            }
            
            const dspPartner = document.getElementById('displayDspPartner');
            if (dspPartner) dspPartner.textContent = adv.dsp.partner || '—';
            
            const dspDomain = document.getElementById('displayDspDomain');
            if (dspDomain) dspDomain.textContent = adv.dsp.domain || '—';
            
            const dspCountry = document.getElementById('displayDspCountry');
            if (dspCountry) dspCountry.textContent = adv.dsp.country || '—';
            
            const dspEuTargeting = document.getElementById('displayDspEuTargeting');
            if (dspEuTargeting) dspEuTargeting.textContent = adv.dsp.euTargeting || '—';
            
            const dspIndustry = document.getElementById('displayDspIndustry');
            if (dspIndustry) dspIndustry.textContent = adv.dsp.industry || '—';
            
            // Format attribution windows
            const dspAttrClick = document.getElementById('displayDspAttrClick');
            if (dspAttrClick) {
              if (adv.dsp.attributionWindows && adv.dsp.attributionWindows.click) {
                const click = adv.dsp.attributionWindows.click;
                dspAttrClick.textContent = click.value ? `${click.value} ${click.unit || 'Days'}` : '—';
              } else {
                dspAttrClick.textContent = '—';
              }
            }
            
            const dspAttrImpression = document.getElementById('displayDspAttrImpression');
            if (dspAttrImpression) {
              if (adv.dsp.attributionWindows && adv.dsp.attributionWindows.impression) {
                const impression = adv.dsp.attributionWindows.impression;
                dspAttrImpression.textContent = impression.value ? `${impression.value} ${impression.unit || 'Days'}` : '—';
              } else {
                dspAttrImpression.textContent = '—';
              }
            }
            
            // Format deduplication windows
            const dspDedupClick = document.getElementById('displayDspDedupClick');
            if (dspDedupClick) {
              const dedupClick = adv.dsp.deduplicationWindows?.click;
              dspDedupClick.textContent = dedupClick ? `${dedupClick} Seconds` : '—';
            }
            
            const dspDedupConversion = document.getElementById('displayDspDedupConversion');
            if (dspDedupConversion) {
              const dedupConv = adv.dsp.deduplicationWindows?.conversion;
              dspDedupConversion.textContent = dedupConv ? `${dedupConv} Seconds` : '—';
            }
            
            const dspYahoo = document.getElementById('displayDspYahoo');
            if (dspYahoo) dspYahoo.textContent = adv.dsp.yahooIntegration || '—';
            
            // Show DSP section
            const dspSection = document.getElementById('dspFieldsSection');
            console.log('[DATA BINDING] DSP section element:', dspSection);
            console.log('[DATA BINDING] DSP section classList before:', dspSection?.classList.toString());
            if (dspSection) {
              dspSection.classList.remove('hidden');
              console.log('[DATA BINDING] DSP section classList after:', dspSection.classList.toString());
              
              // DEBUG: Monitor for changes to this element
              const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                  if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    console.log('[DSP WATCHER] Class changed to:', dspSection.classList.toString());
                    console.trace('[DSP WATCHER] Stack trace:');
                  }
                });
              });
              observer.observe(dspSection, { attributes: true });
            }
          }
          
          // Bind Ad Server fields if they exist
          if (adv.adServer) {
            // Populate Ad Server display spans directly
            const adServerName = document.getElementById('displayAdServerName');
            if (adServerName) adServerName.textContent = adv.adServer.advertiserName || '—';
            
            const adServerVertical = document.getElementById('displayAdServerVertical');
            if (adServerVertical) adServerVertical.textContent = adv.adServer.vertical || '—';
            
            const adServerEuPolitical = document.getElementById('displayAdServerEuPolitical');
            if (adServerEuPolitical) {
              adServerEuPolitical.textContent = adv.adServer.declarations?.euPoliticalAds || '—';
            }
            
            // Show Ad Server section
            const adServerSection = document.getElementById('adServerFieldsSection');
            if (adServerSection) adServerSection.classList.remove('hidden');
          }
        } else {
          bindAll('adv.name', 'No advertiser found', 'No advertiser found');
          bindAll('adv.id', '', '');
          bindAll('adv.account', 'N/A', 'N/A');
          bindAll('adv.state', 'N/A', 'N/A');
          bindAll('adv.deliveryId', '—', '—');
          bindAll('adv.reportingId', '—', '—');
        }

        // Expose for other modules if needed
        window.bindAll = bindAll;
        window.currentAdvertiser = adv;
      });
    })();
  </script>

  <!-- Team filter -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const chip = document.getElementById('teamStateChip');
      const menu = document.getElementById('teamStateMenu');
      const label = document.getElementById('teamStateChipLabel');
      const tbody = document.getElementById('teamTableBody');
      if (!chip || !menu || !label || !tbody) return;

      const closeMenu = () => { menu.classList.add('hidden'); chip.setAttribute('aria-expanded', 'false'); };

      chip.addEventListener('click', (e) => {
        e.stopPropagation();
        const open = menu.classList.toggle('hidden');
        chip.setAttribute('aria-expanded', String(!open));
        if (!open) { menu.setAttribute('tabindex','-1'); menu.focus(); }
      });

      document.addEventListener('click', closeMenu);

      menu.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') { closeMenu(); chip.focus(); }
      });

      menu.addEventListener('click', (e) => {
        const btn = e.target.closest('button'); if (!btn) return;
        const value = btn.dataset.value;
        label.textContent = value;

        tbody.querySelectorAll('tr').forEach(row => {
          const rowState = (row.getAttribute('data-state') || '').toLowerCase().trim();
          let show = true;
          if (value === 'Active') show = rowState === 'active';
          else if (value === 'Inactive') show = rowState === 'inactive';
          else show = true;
          row.style.display = show ? '' : 'none';
        });

        closeMenu();
      });

      // Default view = Active
      label.textContent = 'Active';
      tbody.querySelectorAll('tr').forEach(row => {
        const rowState = (row.getAttribute('data-state') || '').toLowerCase().trim();
        row.style.display = rowState === 'active' ? '' : 'none';
      });
    });
  </script>

  <!-- Account # display toggle -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const accountDisplay = document.getElementById('accountDisplay');
      const accountLookupBtn = document.getElementById('accountLookupBtn');
      if (!accountDisplay || !accountLookupBtn) return;

      function updateAccountDisplay() {
        const val = (accountDisplay.textContent || '').trim();
        const has = !!val && val !== '—' && val !== 'N/A';
        accountDisplay.classList.toggle('hidden', !has);
        accountLookupBtn.classList.toggle('hidden', has);
      }

      // initialize after bind
      setTimeout(updateAccountDisplay, 100);
      const obs = new MutationObserver(updateAccountDisplay);
      obs.observe(accountDisplay, { childList: true, subtree: true });
    });
  </script>



  <!-- General Edit/Save/Cancel behavior -->
  <script>
    (function () {
      const STORAGE_KEY_DATA = 'adv_list_data';
      const SELECTED_ID_KEY  = 'adv_selected_id';
      const SELECTED_DATA_KEY= 'adv_selected_data';

      // Pairs of span/input elements for inline editing - Beacon Fields
      const beaconPairs = [
        { span: 'displayAdvertiserName', input: 'inputAdvertiserName' },
        { span: 'displayState', input: 'inputState' }
      ];

      // DSP Fields pairs
      const dspPairs = [
        { span: 'displayDspName', input: 'inputDspName' },
        { span: 'displayDspPartner', input: 'inputDspPartner' },
        { span: 'displayDspDomain', input: 'inputDspDomain' },
        { span: 'displayDspCountry', input: 'inputDspCountry' },
        { span: 'displayDspEuTargeting', input: 'inputDspEuTargeting' },
        { span: 'displayDspIndustry', input: 'inputDspIndustry' },
        { span: 'displayDspAttrClick', input: 'inputDspAttrClick' },
        { span: 'displayDspAttrImpression', input: 'inputDspAttrImpression' },
        { span: 'displayDspDedupClick', input: 'inputDspDedupClick' },
        { span: 'displayDspDedupConversion', input: 'inputDspDedupConversion' },
        { span: 'displayDspYahoo', input: 'inputDspYahoo' }
      ];

      // Ad Server Fields pairs
      const adServerPairs = [
        { span: 'displayAdServerName', input: 'inputAdServerName' },
        { span: 'displayAdServerVertical', input: 'inputAdServerVertical' },
        { span: 'displayAdServerEuPolitical', input: 'inputAdServerEuPolitical' }
      ];

      // All pairs combined
      const pairs = [...beaconPairs, ...dspPairs, ...adServerPairs];

      const btnEdit   = document.getElementById('editGeneralBtn');
      const btnSave   = document.getElementById('saveGeneralBtn');
      const btnCancel = document.getElementById('cancelGeneralBtn');
      const ellipsisBtn = document.getElementById('ellipsisBtn');
      const ellipsisMenu = document.getElementById('ellipsisMenu');
      const deleteBtn = document.getElementById('deleteAdvertiserBtn');
      const ellipsisDropdown = document.querySelector('.ellipsis-dropdown');

      let editing = false;
      let snapshot = null;

      // Ellipsis dropdown toggle
      ellipsisBtn?.addEventListener('click', (e) => {
        e.stopPropagation();
        const isOpen = ellipsisMenu.classList.contains('open');
        ellipsisMenu.classList.toggle('open', !isOpen);
        ellipsisBtn.setAttribute('aria-expanded', !isOpen);
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (ellipsisDropdown && !ellipsisDropdown.contains(e.target)) {
          ellipsisMenu?.classList.remove('open');
          ellipsisBtn?.setAttribute('aria-expanded', 'false');
        }
      });

      // Delete advertiser functionality
      deleteBtn?.addEventListener('click', () => {
        const advId = localStorage.getItem('adv_selected_id');
        if (!advId) {
          if (typeof showToast === 'function') {
            showToast('No advertiser selected.', 2000);
          }
          return;
        }

        const advertisers = JSON.parse(localStorage.getItem('adv_list_data') || '[]');
        const adv = advertisers.find(a => String(a.id) === String(advId));
        
        if (!adv) {
          if (typeof showToast === 'function') {
            showToast('Advertiser not found.', 2000);
          }
          return;
        }
        
        const confirmMsg = 'Are you sure you want to delete "' + adv.name + '"?';
        if (!confirm(confirmMsg)) {
          ellipsisMenu?.classList.remove('open');
          return;
        }
        
        const updatedAdvertisers = advertisers.filter(a => String(a.id) !== String(advId));
        localStorage.setItem('adv_list_data', JSON.stringify(updatedAdvertisers));
        
        // Clear selected data
        localStorage.removeItem('adv_selected_id');
        localStorage.removeItem('adv_selected_data');
        
        if (typeof showToast === 'function') {
          showToast('Advertiser "' + adv.name + '" deleted successfully.', 2500);
        }
        
        // Redirect back to list page
        setTimeout(() => {
          window.location.href = './index.html';
        }, 500);
      });

      function showSpans() {
        pairs.forEach(p => {
          const span = document.getElementById(p.span);
          const input = document.getElementById(p.input);
          if (!span || !input) return;
          
          // Update span with input value
          let displayValue = input.value.trim();
          if (!displayValue || displayValue === '') {
            displayValue = '—';
          }
          
          span.textContent = displayValue;
          input.classList.add('hidden');
          span.classList.remove('hidden');
        });
      }

      function showInputs() {
        pairs.forEach(p => {
          const span = document.getElementById(p.span);
          const input = document.getElementById(p.input);
          if (!span || !input) return;
          
          input.classList.remove('hidden');
          span.classList.add('hidden');
          
          // Set input/select value from span
          let value = span.textContent.trim();
          if (value === '—' || value === 'N/A') {
            value = '';
          }
          
          // Special handling for SELECT elements
          if (input.tagName === 'SELECT') {
            const options = Array.from(input.options);
            const match = options.find(opt => opt.value.toLowerCase() === value.toLowerCase());
            input.value = match ? match.value : '';
          } else {
            input.value = value;
          }
        });
      }

      function currentValues() {
        const obj = {};
        pairs.forEach(p => {
          const input = document.getElementById(p.input);
          if (input) obj[p.input] = input.value.trim();
        });
        return obj;
      }

      function shallowEqual(a,b){
        const ka = Object.keys(a), kb = Object.keys(b);
        if (ka.length !== kb.length) return false;
        for (const k of ka) if (a[k] !== b[k]) return false;
        return true;
      }

      btnEdit?.addEventListener('click', () => {
        editing = true;
        snapshot = currentValues();
        showInputs();
        
        // Hide ellipsis dropdown and show save/cancel buttons
        ellipsisDropdown?.classList.add('hidden');
        ellipsisMenu?.classList.remove('open');
        btnSave.classList.remove('hidden');
        btnCancel.classList.remove('hidden');
        
        // Auto-focus first editable field
        const firstInput = document.getElementById('inputAdvertiserName');
        if (firstInput) {
          setTimeout(() => firstInput.focus(), 50);
        }
      });

      btnCancel?.addEventListener('click', () => {
        if (!editing) return;
        
        // Revert to snapshot
        pairs.forEach(p => {
          const input = document.getElementById(p.input);
          if (input && snapshot && snapshot[p.input] != null) {
            input.value = snapshot[p.input];
          }
        });
        
        showSpans();
        editing = false;
        snapshot = null;
        
        // Show ellipsis dropdown and hide save/cancel buttons
        ellipsisDropdown?.classList.remove('hidden');
        btnSave.classList.add('hidden');
        btnCancel.classList.add('hidden');
      });

      btnSave?.addEventListener('click', () => {
        if (!editing) return;
        const now = currentValues();
        
        if (snapshot && shallowEqual(snapshot, now)) {
          // No changes
          showSpans();
          editing = false;
          snapshot = null;
          ellipsisDropdown?.classList.remove('hidden');
          btnSave.classList.add('hidden');
          btnCancel.classList.add('hidden');
          return;
        }

        // Save changes
        const selectedId = localStorage.getItem(SELECTED_ID_KEY);
        if (!selectedId) {
          showToast({ message: 'No advertiser selected.', type: 'error' });
          return;
        }

        try {
          const advertisers = JSON.parse(localStorage.getItem(STORAGE_KEY_DATA) || '[]');
          const idx = advertisers.findIndex(a => String(a.id) === String(selectedId));
          if (idx === -1) {
            showToast({ message: 'Advertiser not found in storage.', type: 'error' });
            return;
          }

          // Update Beacon fields
          advertisers[idx].name = now.inputAdvertiserName?.trim() || '';
          advertisers[idx].state = now.inputState?.trim() || '';

          // Update DSP fields if they exist
          if (!advertisers[idx].dsp) advertisers[idx].dsp = {};
          advertisers[idx].dsp.name = now.inputDspName?.trim() || '';
          advertisers[idx].dsp.partner = now.inputDspPartner?.trim() || '';
          advertisers[idx].dsp.domain = now.inputDspDomain?.trim() || '';
          advertisers[idx].dsp.country = now.inputDspCountry?.trim() || '';
          advertisers[idx].dsp.euTargeting = now.inputDspEuTargeting?.trim() || '';
          advertisers[idx].dsp.industry = now.inputDspIndustry?.trim() || '';
          advertisers[idx].dsp.yahooIntegration = now.inputDspYahoo?.trim() || '';

          // Attribution windows (parse from "value unit" format back to object structure)
          if (!advertisers[idx].dsp.attributionWindows) advertisers[idx].dsp.attributionWindows = {};
          
          // Parse click attribution (e.g., "90 Days" -> {value: "90", unit: "Days"})
          const clickStr = now.inputDspAttrClick?.trim() || '';
          if (clickStr && clickStr !== '—') {
            const clickParts = clickStr.split(' ');
            const clickValue = clickParts[0] || '';
            const clickUnit = clickParts.slice(1).join(' ') || 'Days';
            advertisers[idx].dsp.attributionWindows.click = {
              value: clickValue,
              unit: clickUnit
            };
          } else {
            advertisers[idx].dsp.attributionWindows.click = { value: '', unit: 'Days' };
          }
          
          // Parse impression attribution (e.g., "90 Days" -> {value: "90", unit: "Days"})
          const impressionStr = now.inputDspAttrImpression?.trim() || '';
          if (impressionStr && impressionStr !== '—') {
            const impressionParts = impressionStr.split(' ');
            const impressionValue = impressionParts[0] || '';
            const impressionUnit = impressionParts.slice(1).join(' ') || 'Days';
            advertisers[idx].dsp.attributionWindows.impression = {
              value: impressionValue,
              unit: impressionUnit
            };
          } else {
            advertisers[idx].dsp.attributionWindows.impression = { value: '', unit: 'Days' };
          }

          // Deduplication windows (remove "Seconds" suffix if present)
          if (!advertisers[idx].dsp.deduplicationWindows) advertisers[idx].dsp.deduplicationWindows = {};
          advertisers[idx].dsp.deduplicationWindows.click = (now.inputDspDedupClick?.trim() || '').replace(' Seconds', '');
          advertisers[idx].dsp.deduplicationWindows.conversion = (now.inputDspDedupConversion?.trim() || '').replace(' Seconds', '');

          // Update Ad Server fields if they exist
          if (!advertisers[idx].adServer) advertisers[idx].adServer = {};
          advertisers[idx].adServer.advertiserName = now.inputAdServerName?.trim() || '';
          advertisers[idx].adServer.vertical = now.inputAdServerVertical?.trim() || '';
          
          if (!advertisers[idx].adServer.declarations) advertisers[idx].adServer.declarations = {};
          advertisers[idx].adServer.declarations.euPoliticalAds = now.inputAdServerEuPolitical?.trim() || '';

          localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(advertisers));
          localStorage.setItem(SELECTED_DATA_KEY, JSON.stringify(advertisers[idx]));

          showSpans();
          editing = false;
          snapshot = null;
          
          ellipsisDropdown?.classList.remove('hidden');
          btnSave.classList.add('hidden');
          btnCancel.classList.add('hidden');
          
          showToast({ message: 'Data saved successfully.', type: 'success' });
        } catch (e) {
          console.error(e);
          showToast({ message: 'Save failed. Check console.', type: 'error' });
        }
      });

      // Simple toast function for compatibility
      function showToast(options) {
        const message = typeof options === 'string' ? options : options.message;
        const type = options.type || 'info';
        
        if (window.toast && typeof window.toast.success === 'function') {
          if (type === 'success') window.toast.success(message);
          else if (type === 'error') window.toast.error(message);
          else if (type === 'warning') window.toast.warning(message);
          else window.toast.info(message);
        } else {
          console.log('TOAST:', type.toUpperCase(), message);
        }
      }

      // Initialize to view mode (spans visible) - DON'T call showSpans here
      // as it would overwrite values already set by data binding
      document.addEventListener('DOMContentLoaded', () => {
        // Just ensure inputs are hidden and spans are visible, without overwriting content
        setTimeout(() => {
          pairs.forEach(p => {
            const span = document.getElementById(p.span);
            const input = document.getElementById(p.input);
            if (!span || !input) return;
            
            // Only hide inputs and show spans - don't change content
            input.classList.add('hidden');
            span.classList.remove('hidden');
          });
        }, 100);
      });
    })();
  </script>

  <!-- Account Lookup Modal -->
  <div id="accountLookupModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-60">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[80vh] overflow-auto">
      <div class="flex items-center justify-between p-4 border-b border-gray-200">
        <h2 class="text-lg font-semibold text-gray-900">Account Lookup</h2>
        <button type="button" id="closeLookupX" class="text-gray-400 hover:text-gray-600 transition-colors" title="Close">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <div class="p-4">
        <div class="mb-4">
          <input type="text" id="lookupSearch" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Search by account number or name...">
        </div>
        
        <div class="max-h-96 overflow-y-auto">
          <table class="w-full text-sm">
            <thead class="bg-gray-50 sticky top-0">
              <tr>
                <th class="text-left py-2 px-4 font-medium text-gray-700">Account #</th>
                <th class="text-left py-2 px-4 font-medium text-gray-700">Account Name</th>
              </tr>
            </thead>
            <tbody id="lookupResults" class="divide-y divide-gray-200">
              <!-- Results populated by JS -->
            </tbody>
          </table>
        </div>
      </div>

      <div class="flex items-center justify-end space-x-3 p-4 border-t border-gray-200">
        <button type="button" id="cancelLookupBtn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
        <button type="button" id="selectAccountBtn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 disabled:opacity-50" disabled>Select</button>
      </div>
    </div>
  </div>

  <!-- Account Lookup Logic -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // Sample CRM accounts (same as other pages)
    const SAMPLE_CRM_ACCOUNTS = [
      { accountNumber: '12345', accountName: 'Acme Corporation' },
      { accountNumber: '67890', accountName: 'Global Tech Solutions' },
      { accountNumber: '11111', accountName: 'Sunrise Marketing' },
      { accountNumber: '22222', accountName: 'Metro Retail Group' },
      { accountNumber: '33333', accountName: 'Advanced Systems Inc' }
    ];

    const accountLookupBtn = document.getElementById('accountLookupBtn');
    const accountLookupModal = document.getElementById('accountLookupModal');
    const closeLookupX = document.getElementById('closeLookupX');
    const cancelLookupBtn = document.getElementById('cancelLookupBtn');
    const lookupSearch = document.getElementById('lookupSearch');
    const lookupResults = document.getElementById('lookupResults');
    const selectAccountBtn = document.getElementById('selectAccountBtn');

    if (!accountLookupBtn || !accountLookupModal) return;

    function closeLookupModal() {
      accountLookupModal.classList.add('hidden');
      document.body.style.overflow = 'auto';
      if (lookupSearch) lookupSearch.value = '';
      if (selectAccountBtn) selectAccountBtn.disabled = true;
    }

    function renderResults(accounts) {
      if (!lookupResults) return;
      lookupResults.innerHTML = '';
      
      accounts.forEach(account => {
        const tr = document.createElement('tr');
        tr.className = 'cursor-pointer hover:bg-gray-50';
        tr.dataset.accountNumber = account.accountNumber;
        tr.dataset.accountName = account.accountName;
        tr.innerHTML = `
          <td class="py-2 px-4">${account.accountNumber}</td>
          <td class="py-2 px-4">${account.accountName}</td>
        `;
        
        tr.addEventListener('click', function() {
          const prev = lookupResults.querySelector('tr.selected');
          if (prev) prev.classList.remove('bg-blue-50', 'selected');
          tr.classList.add('bg-blue-50', 'selected');
          if (selectAccountBtn) selectAccountBtn.disabled = false;
        });
        
        lookupResults.appendChild(tr);
      });
    }

    // Open modal
    accountLookupBtn.addEventListener('click', (e) => {
      e.preventDefault();
      accountLookupModal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      renderResults(SAMPLE_CRM_ACCOUNTS);
      if (lookupSearch) lookupSearch.focus();
    });

    // Close modal handlers
    if (closeLookupX) closeLookupX.addEventListener('click', closeLookupModal);
    if (cancelLookupBtn) cancelLookupBtn.addEventListener('click', closeLookupModal);

    // Search functionality
    if (lookupSearch) {
      lookupSearch.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        const filtered = SAMPLE_CRM_ACCOUNTS.filter(account => 
          account.accountNumber.toLowerCase().includes(query) ||
          account.accountName.toLowerCase().includes(query)
        );
        renderResults(filtered);
      });
    }

    // Select account
    if (selectAccountBtn) {
      selectAccountBtn.addEventListener('click', function() {
        const selected = lookupResults ? lookupResults.querySelector('tr.selected') : null;
        if (!selected) return;

        const accountNumber = selected.dataset.accountNumber;
        const accountName = selected.dataset.accountName;

        // Update the display
        const accountDisplay = document.getElementById('accountDisplay');
        if (accountDisplay) {
          accountDisplay.textContent = accountNumber;
          accountDisplay.classList.remove('hidden');
        }
        
        if (accountLookupBtn) {
          accountLookupBtn.classList.add('hidden');
        }

        // Update the data in localStorage
        try {
          const selectedId = localStorage.getItem('adv_selected_id');
          if (selectedId) {
            const advertisers = JSON.parse(localStorage.getItem('adv_list_data') || '[]');
            const advIndex = advertisers.findIndex(a => String(a.id) === String(selectedId));
            
            if (advIndex !== -1) {
              advertisers[advIndex].account = accountNumber;
              localStorage.setItem('adv_list_data', JSON.stringify(advertisers));
              localStorage.setItem('adv_selected_data', JSON.stringify(advertisers[advIndex]));
              
              // Update data binding if available
              if (typeof window.bindAll === 'function') {
                window.bindAll('adv.account', accountNumber, 'N/A');
              }
            }
          }
        } catch (e) {
          console.error('Error updating account in storage:', e);
        }

        closeLookupModal();
        
        // Show success toast if available
        if (window.toast && typeof window.toast.success === 'function') {
          window.toast.success('Account updated successfully');
        }
      });
    }

    // Close on outside click
    accountLookupModal.addEventListener('click', function(e) {
      if (e.target === accountLookupModal) {
        closeLookupModal();
      }
    });

    // Close on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && !accountLookupModal.classList.contains('hidden')) {
        closeLookupModal();
      }
    });
  });
  </script>

  <!-- Populate Campaigns and Ad Groups Tables -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    console.log('[CAMPAIGNS SCRIPT] Starting at:', new Date().toISOString());
    // Get current advertiser
    let adv = null;
    try {
      const rawObj = localStorage.getItem('adv_selected_data');
      console.log('[CAMPAIGNS] Raw adv_selected_data:', rawObj);
      if (rawObj) adv = JSON.parse(rawObj);
    } catch {}

    if (!adv) {
      console.log('[CAMPAIGNS] No advertiser selected');
      return;
    }

    console.log('[CAMPAIGNS] Loading data for advertiser:', adv?.name, 'ID:', adv?.id);

    // Load and populate campaigns
    // Get live ad group count for a campaign
    function getAdGroupCount(campaignId, campaignName) {
      try {
        const adGroups = JSON.parse(localStorage.getItem('adgroups_data_v1') || '[]');
        return adGroups.filter(ag => {
          // Check multiple possible campaign reference formats
          const agCampaignId = ag.campaignId || ag.campaign;
          
          // Direct match by ID
          if (agCampaignId === campaignId) return true;
          
          // Match by campaign name
          if (agCampaignId === campaignName) return true;
          
          return false;
        }).length;
      } catch (e) {
        console.warn('Failed to count ad groups:', e);
        return 0;
      }
    }

    function loadCampaigns() {
      const campaignTableBody = document.getElementById('campaignTableBody');
      if (!campaignTableBody) return;

      try {
        const campaignsData = localStorage.getItem('campaign_tree_groups');
        if (!campaignsData) {
          campaignTableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No campaigns found</td></tr>';
          return;
        }

        const data = JSON.parse(campaignsData);
        
        // Flatten all campaigns from the data structure
        let allCampaigns = [];
        
        // Add campaigns from top-level campaigns array
        if (data.campaigns && Array.isArray(data.campaigns)) {
          allCampaigns = allCampaigns.concat(data.campaigns);
        }
        
        // Add campaigns from groups
        if (data.groups && Array.isArray(data.groups)) {
          data.groups.forEach(group => {
            if (group.campaigns && Array.isArray(group.campaigns)) {
              allCampaigns = allCampaigns.concat(group.campaigns);
            }
          });
        }
        
        // Filter campaigns for this advertiser
        const campaigns = allCampaigns.filter(c => String(c.advertiserId) === String(adv.id));

        console.log('Found campaigns:', campaigns.length);

        if (campaigns.length === 0) {
          campaignTableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No campaigns for this advertiser</td></tr>';
          return;
        }

        campaignTableBody.innerHTML = '';
        campaigns.forEach(c => {
          // Calculate live ad group count
          const adGroupCount = getAdGroupCount(c.id, c.beaconCampaignName || c.name);
          
          const tr = document.createElement('tr');
          tr.className = 'hover:bg-gray-50 campaign-row';
          tr.dataset.campaignId = c.id;
          tr.innerHTML = `
            <td class="px-6 py-1 whitespace-nowrap text-sm border-r border-default">${c.beaconCampaignId || c.id || ''}</td>
            <td class="px-6 py-1 whitespace-nowrap text-sm font-medium border-r border-default">
              <a href="./CampaignDetails.html?campaignId=${encodeURIComponent(c.id)}&campaignName=${encodeURIComponent(c.beaconCampaignName || c.name)}" class="text-blue-600 hover:underline">
                ${c.beaconCampaignName || c.name || ''}
              </a>
            </td>
            <td class="px-6 py-1 whitespace-nowrap text-sm border-r border-default">${c.state || ''}</td>
            <td class="px-6 py-1 whitespace-nowrap text-sm border-r border-default">${c.dsp || ''}</td>
            <td class="px-6 py-1 whitespace-nowrap text-sm border-r border-default">${c.adServer || ''}</td>
            <td class="px-6 py-1 whitespace-nowrap text-sm text-right tabular-nums">${adGroupCount}</td>
          `;
          campaignTableBody.appendChild(tr);
        });
      } catch (e) {
        console.error('Error loading campaigns:', e);
        campaignTableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Error loading campaigns</td></tr>';
      }
    }

    // Load and populate ad groups
    function loadAdGroups() {
      const adGroupTableBody = document.getElementById('adGroupTableBody');
      if (!adGroupTableBody) return;

      try {
        const adGroupsData = localStorage.getItem('adgroups_data_v1');
        if (!adGroupsData) {
          adGroupTableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No ad groups found</td></tr>';
          return;
        }

        const allAdGroups = JSON.parse(adGroupsData);
        // Filter ad groups for this advertiser
        const adGroups = allAdGroups.filter(ag => String(ag.advertiserId) === String(adv.id));

        console.log('Found ad groups:', adGroups.length);

        if (adGroups.length === 0) {
          adGroupTableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No ad groups for this advertiser</td></tr>';
          return;
        }

        adGroupTableBody.innerHTML = '';
        adGroups.forEach(ag => {
          const tr = document.createElement('tr');
          tr.className = 'hover:bg-gray-50';
          tr.innerHTML = `
            <td class="px-6 py-1 whitespace-nowrap text-sm text-gray-900 border-r border-gray-200">${ag.id || ''}</td>
            <td class="px-6 py-1 whitespace-nowrap text-sm font-medium text-gray-900 border-r border-gray-200">
              <a href="./AdGroupDetails.html?id=${encodeURIComponent(ag.id)}&campaignId=${encodeURIComponent(ag.campaign || '')}" class="text-blue-600 hover:underline">
                ${ag.name || ''}
              </a>
            </td>
            <td class="px-6 py-1 whitespace-nowrap text-sm text-gray-900 border-r border-gray-200">${(ag.connectors && ag.connectors.dsp) || ''}</td>
            <td class="px-6 py-1 whitespace-nowrap text-sm text-gray-900 border-r border-gray-200">${(ag.connectors && ag.connectors.adServer) || ''}</td>
            <td class="px-6 py-1 whitespace-nowrap text-sm text-gray-900 border-r border-gray-200">${ag.classification || ag.multiviewClassification || ''}</td>
            <td class="px-6 py-1 whitespace-nowrap text-sm text-gray-900">${ag.campaign || ''}</td>
          `;
          adGroupTableBody.appendChild(tr);
        });
      } catch (e) {
        console.error('Error loading ad groups:', e);
        adGroupTableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Error loading ad groups</td></tr>';
      }
    }

    // Initialize tables
    loadCampaigns();
    loadAdGroups();

    // Listen for storage changes to update tables when data changes
    window.addEventListener('storage', (e) => {
      if (e.key === 'campaign_tree_groups') {
        console.log('Campaign data changed, reloading campaigns table...');
        loadCampaigns();
      }
      if (e.key === 'adgroups_data_v1') {
        console.log('Ad group data changed, reloading ad groups table...');
        loadAdGroups();
      }
    });

    // Also expose functions globally so they can be called from other scripts
    window.refreshCampaignsTable = loadCampaigns;
    window.refreshAdGroupsTable = loadAdGroups;

    // Poll for changes every 2 seconds (for same-window updates)
    let lastCampaignData = localStorage.getItem('campaign_tree_groups');
    let lastAdGroupData = localStorage.getItem('adgroups_data_v1');
    
    setInterval(() => {
      const currentCampaignData = localStorage.getItem('campaign_tree_groups');
      const currentAdGroupData = localStorage.getItem('adgroups_data_v1');
      
      if (currentCampaignData !== lastCampaignData) {
        console.log('Campaign data changed (polling), reloading...');
        lastCampaignData = currentCampaignData;
        loadCampaigns();
      }
      
      if (currentAdGroupData !== lastAdGroupData) {
        console.log('Ad group data changed (polling), reloading...');
        lastAdGroupData = currentAdGroupData;
        loadAdGroups();
      }
    }, 2000);
  });
  </script>

<!-- Change Order Picker Modal -->
<div id="coPickerModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-lg mx-4 overflow-hidden">
    
    <!-- Modal Header -->
    <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
      <h2 class="text-lg font-semibold text-gray-900">Add to Change Order</h2>
      <button id="coPickerCloseBtn" class="text-gray-400 hover:text-gray-600 transition-colors" 
        onclick="document.getElementById('coPickerModal').classList.add('hidden')" aria-label="Close">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    
    <!-- Modal Body -->
    <div class="px-6 py-4 max-h-[60vh] overflow-y-auto">
      <p class="text-sm text-gray-500 mb-4">Select an existing Change Order or create a new one.</p>
      
      <!-- Create New Option -->
      <div class="flex items-center gap-3 p-3 border-2 border-dashed border-green-400 rounded-lg mb-3 cursor-pointer hover:bg-green-50 transition-colors"
        onclick="document.getElementById('coPickerModal').classList.add('hidden'); document.getElementById('entitySelectModal').classList.remove('hidden');">
        <div class="w-8 h-8 flex items-center justify-center rounded-full bg-green-100 text-green-600 font-bold text-lg">+</div>
        <div>
          <div class="text-sm font-semibold text-green-700">Create New Change Order</div>
          <div class="text-xs text-gray-500">Start a blank Change Order for this advertiser</div>
        </div>
      </div>
      
      <!-- Existing CO: Draft -->
      <div class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg mb-2 cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-colors co-pick-item">
        <input type="radio" name="coPickerRadio" class="w-4 h-4 text-blue-600 accent-blue-600">
        <div class="flex-1">
          <div class="text-sm font-semibold text-gray-800">Q2 Strategy A</div>
          <div class="text-xs text-gray-500">CO-A8X2K1 · Draft · Feb 20, 2026 · 1C / 3AG</div>
        </div>
        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Draft</span>
      </div>
      
      <!-- Existing CO: Draft -->
      <div class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg mb-2 cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-colors co-pick-item">
        <input type="radio" name="coPickerRadio" class="w-4 h-4 text-blue-600 accent-blue-600">
        <div class="flex-1">
          <div class="text-sm font-semibold text-gray-800">Q2 Strategy B</div>
          <div class="text-xs text-gray-500">CO-B3Y7M2 · Draft · Feb 20, 2026 · 2C / 5AG</div>
        </div>
        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Draft</span>
      </div>
    </div>
    
    <!-- Modal Footer -->
    <div class="flex justify-end gap-2 px-6 py-3 bg-gray-50 border-t border-gray-200">
      <button class="px-4 py-2 text-sm text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50"
        onclick="document.getElementById('coPickerModal').classList.add('hidden')">Cancel</button>
      <button class="px-4 py-2 text-sm text-white bg-blue-600 border border-blue-600 rounded-md hover:bg-blue-700"
        onclick="document.getElementById('coPickerModal').classList.add('hidden'); document.getElementById('entitySelectModal').classList.remove('hidden');">Continue →</button>
    </div>
  </div>
</div>

<!-- Entity Selection Modal -->
<div id="entitySelectModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-xl mx-4 overflow-hidden">
    
    <!-- Modal Header -->
    <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
      <h2 class="text-lg font-semibold text-gray-900">Select Records to Include</h2>
      <button class="text-gray-400 hover:text-gray-600 transition-colors"
        onclick="document.getElementById('entitySelectModal').classList.add('hidden')" aria-label="Close">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    
    <!-- Modal Body -->
    <div class="px-6 py-4 max-h-[60vh] overflow-y-auto">
      <p class="text-sm text-gray-500 mb-4">Choose which Campaigns and Ad Groups to include in this Change Order. The Advertiser is always included.</p>
      
      <!-- Entity Tree -->
      <ul class="space-y-1">
        <!-- Advertiser (locked/always included) -->
        <li class="flex items-center gap-2 px-2 py-1.5 rounded-md opacity-60">
          <input type="checkbox" checked disabled class="w-4 h-4 accent-blue-600">
          <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide bg-blue-100 text-blue-900">ADV</span>
          <span class="text-sm font-semibold text-gray-800">Goldmine Software Solutions</span>
          <span class="text-[10px] text-gray-400 ml-1">always included</span>
        </li>
        
        <!-- Campaign 1 with Ad Groups -->
        <li class="ml-5">
          <div class="flex items-center gap-2 px-2 py-1.5 rounded-md hover:bg-gray-50">
            <input type="checkbox" checked class="w-4 h-4 accent-blue-600 entity-cam-check" data-children="cam1-children">
            <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide bg-purple-100 text-purple-800">CAM</span>
            <span class="text-sm text-gray-800">Tuscaloosa AL - Prog. Display</span>
          </div>
          <div id="cam1-children" class="ml-8 space-y-0.5">
            <div class="flex items-center gap-2 px-2 py-1 rounded-md hover:bg-gray-50">
              <input type="checkbox" checked class="w-4 h-4 accent-blue-600">
              <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide bg-orange-100 text-orange-800">AG</span>
              <span class="text-xs text-gray-600">Local Consumers_Persona</span>
            </div>
            <div class="flex items-center gap-2 px-2 py-1 rounded-md hover:bg-gray-50">
              <input type="checkbox" checked class="w-4 h-4 accent-blue-600">
              <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide bg-orange-100 text-orange-800">AG</span>
              <span class="text-xs text-gray-600">Local Site Visitors_Retargeting</span>
            </div>
            <div class="flex items-center gap-2 px-2 py-1 rounded-md hover:bg-gray-50">
              <input type="checkbox" checked class="w-4 h-4 accent-blue-600">
              <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide bg-orange-100 text-orange-800">AG</span>
              <span class="text-xs text-gray-600">Local Consumers_Location Targeting</span>
            </div>
          </div>
        </li>
        
        <!-- Campaign 2 with Ad Groups -->
        <li class="ml-5">
          <div class="flex items-center gap-2 px-2 py-1.5 rounded-md hover:bg-gray-50">
            <input type="checkbox" class="w-4 h-4 accent-blue-600 entity-cam-check" data-children="cam2-children">
            <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide bg-purple-100 text-purple-800">CAM</span>
            <span class="text-sm text-gray-800">Tuscaloosa AL - Prog. Video</span>
          </div>
          <div id="cam2-children" class="ml-8 space-y-0.5">
            <div class="flex items-center gap-2 px-2 py-1 rounded-md hover:bg-gray-50">
              <input type="checkbox" class="w-4 h-4 accent-blue-600">
              <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide bg-orange-100 text-orange-800">AG</span>
              <span class="text-xs text-gray-600">Video_Persona</span>
            </div>
            <div class="flex items-center gap-2 px-2 py-1 rounded-md hover:bg-gray-50">
              <input type="checkbox" class="w-4 h-4 accent-blue-600">
              <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide bg-orange-100 text-orange-800">AG</span>
              <span class="text-xs text-gray-600">Video_Retargeting</span>
            </div>
          </div>
        </li>
        
        <!-- Campaign 3 (no ad groups) -->
        <li class="ml-5">
          <div class="flex items-center gap-2 px-2 py-1.5 rounded-md hover:bg-gray-50">
            <input type="checkbox" class="w-4 h-4 accent-blue-600 entity-cam-check" data-children="cam3-children">
            <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide bg-purple-100 text-purple-800">CAM</span>
            <span class="text-sm text-gray-800">Tuscaloosa AL - Audio</span>
          </div>
          <div id="cam3-children" class="ml-8">
            <div class="px-2 py-1 text-xs text-gray-400 italic">No ad groups</div>
          </div>
        </li>
      </ul>
    </div>
    
    <!-- Modal Footer -->
    <div class="flex justify-end gap-2 px-6 py-3 bg-gray-50 border-t border-gray-200">
      <button class="px-4 py-2 text-sm text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50"
        onclick="document.getElementById('entitySelectModal').classList.add('hidden')">Cancel</button>
      <button class="px-4 py-2 text-sm text-white bg-green-600 border border-green-600 rounded-md hover:bg-green-700"
        onclick="document.getElementById('entitySelectModal').classList.add('hidden'); window.location.href='./ChangeOrderDetails.html';">Create Change Order</button>
    </div>
  </div>
</div>

<script>
// Campaign checkbox toggles all child AG checkboxes
document.querySelectorAll('.entity-cam-check').forEach(cb => {
  cb.addEventListener('change', function() {
    const childrenId = this.getAttribute('data-children');
    if (childrenId) {
      document.querySelectorAll('#' + childrenId + ' input[type="checkbox"]').forEach(c => c.checked = this.checked);
    }
  });
});
</script>

  <script src="./assets/sidebar.js" defer></script>
</body>
</html>