<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <title>Beacon - Details</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Toast assets (single source of truth) -->
  <link rel="stylesheet" href="./assets/toast.css">
  <script src="./assets/toast.js" defer></script>
  
  <!-- Theme CSS for platform styling -->
  <link rel="stylesheet" href="./assets/theme.css">

  <!-- REMOVE OR COMMENT OUT THIS LINE: -->
  <script src="./assets/notifications.js"></script>
  <script src="./assets/audit.js" defer></script>
  <link rel="stylesheet" href="./assets/loading.css">
  <script src="./assets/loading.js" defer></script>

  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Inter, Arial, sans-serif; }
    .table-fixed { table-layout: fixed; } td, th { white-space: nowrap; }

    /* Fixed table row height to prevent resizing during edit mode */
    .adgroup-details-table tbody tr {
      height: 2rem; /* Fixed height for consistent table dimensions */
    }
    
    .adgroup-details-table tbody td {
      vertical-align: middle;
      padding-top: 0.25rem !important;
      padding-bottom: 0.25rem !important;
    }

    /* Seamless input styling to match spans */
    .adgroup-details-input {
      background: white !important;
      border: 1px solid #d1d5db !important;
      outline: none !important;
      box-shadow: none !important;
      padding: 0.125rem 0.5rem !important;
      margin: 0 !important;
      height: auto !important;
      line-height: 1.25rem;
      font-size: 0.875rem;
      color: #374151;
      width: 100% !important;
      box-sizing: border-box;
      border-radius: 0.25rem;
    }
    
    /* Enhanced focus state for better UX */
    .adgroup-details-input:focus {
      border: 1px solid #3b82f6 !important;
      box-shadow: 0 0 0 1px #3b82f6 !important;
    }

    /* Read-only inputs look like text */
    input[aria-readonly="true"] {
      border: none !important;
      outline: none !important;
      box-shadow: none !important;
      background: transparent !important;
      caret-color: transparent;
    }
    input[aria-readonly="true"]:focus { border: none !important; outline: none !important; box-shadow: none !important; }
    input[aria-readonly="true"]::-moz-focus-inner { border: 0 !important; }
    
    /* Read-only select styling */
    select[aria-readonly="true"] {
      border: none !important;
      outline: none !important;
      box-shadow: none !important;
      background: transparent !important;
      caret-color: transparent;
      appearance: none;
      pointer-events: none;
    }
    select[aria-readonly="true"]:focus { border: none !important; outline: none !important; box-shadow: none !important; }
  </style>
</head>

<body class="bg-gray-100">
  <div class="flex h-screen flex-col">
    <!-- Header -->
    <header class="border-b border-gray-200 shadow-sm" style="background-color: #004E8B;">
      <div class="flex items-center justify-between px-4 py-2">
        <div class="flex items-center gap-3">
          <img src="./assets/BeaconLogo.png" alt="Beacon Logo" class="h-9 w-auto" />
        </div>

        <nav class="flex items-center gap-3 ml-auto">
            <a href="./index.html" class="text-base text-white hover:text-blue-100" style="font-size: 1.5rem; padding-right: 15px;" onmouseover="this.style.color='#48A9FE'" onmouseout="this.style.color='white'">
            Advertisers
            </a>
          <span class="text-white select-none">|</span>

          <!-- Notifications -->
          <div class="relative">
            <button id="notificationButton" class="p-2 rounded-md  text-white relative" title="Notifications" aria-label="View notifications" onmouseover="this.style.backgroundColor=''" onmouseout="this.style.backgroundColor=''" >
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
              </svg>
              <span id="notificationDot" class="absolute top-2 right-2 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></span>
            </button>

            <!-- Dropdown -->
            <div id="notificationDropdown" class="hidden absolute right-0 mt-2 w-80 bg-white border border-gray-200 rounded-md shadow-lg z-50 max-h-96 overflow-hidden">
              <div class="p-3 border-b border-gray-200 bg-gray-50">
                <div class="flex items-center justify-between">
                  <h3 class="text-sm font-semibold text-gray-900">Notifications</h3>
                  <button id="markAllReadBtn" class="text-xs text-blue-600 hover:text-blue-800">Mark all read</button>
                </div>
              </div>

              <div class="max-h-80 overflow-y-auto">
                <div id="notificationList">
                  <!-- Sample items -->
                  <div class="p-3 border-b border-gray-100 hover:bg-gray-50 cursor-pointer notification-item" data-read="false">
                    <div class="flex items-start gap-3">
                      <div class="flex-shrink-0 w-2 h-2 bg-blue-500 rounded-full mt-2"></div>
                      <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900">Campaign Performance Alert</p>
                        <p class="text-xs text-gray-500 mt-1">"Summer Sale" exceeded budget by 15%</p>
                        <p class="text-xs text-gray-400 mt-1">2 minutes ago</p>
                      </div>
                    </div>
                  </div>

                  <div class="p-3 border-b border-gray-100 hover:bg-gray-50 cursor-pointer notification-item" data-read="false">
                    <div class="flex items-start gap-3">
                      <div class="flex-shrink-0 w-2 h-2 bg-green-500 rounded-full mt-2"></div>
                      <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900">New Advertiser Added</p>
                        <p class="text-xs text-gray-500 mt-1">Stallion Services LLC onboarded</p>
                        <p class="text-xs text-gray-400 mt-1">1 hour ago</p>
                      </div>
                    </div>
                  </div>

                  <div class="p-3 border-b border-gray-100 hover:bg-gray-50 cursor-pointer notification-item" data-read="true">
                    <div class="flex items-start gap-3">
                      <div class="flex-shrink-0 w-2 h-2 bg-gray-300 rounded-full mt-2"></div>
                      <div class="flex-1 min-w-0">
                        <p class="text-sm text-gray-700">Account Sync Complete</p>
                        <p class="text-xs text-gray-500 mt-1">CRM sync finished for 12 accounts</p>
                        <p class="text-xs text-gray-400 mt-1">3 hours ago</p>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="p-3 text-center border-t border-gray-200">
                  <a href="#" class="text-sm text-blue-600 hover:text-blue-800 font-medium">View all notifications</a>
                </div>
              </div>
            </div>
          </div>

          <!-- Waffle Menu -->
          <div class="relative">
            <button class="p-0 rounded-md text-white" id="menuButton" title="Menu" aria-label="Open navigation menu">
              <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                <path d="M4 4h3v3H4V4zM8.5 4h3v3h-3V4zM13 4h3v3h-3V4zM4 8.5h3v3H4v-3zM8.5 8.5h3v3h-3V8.5zM13 8.5h3v3h-3V8.5zM4 13h3v3H4v-3zM8.5 13h3v3h-3V13zM13 13h3v3h-3V13z"></path>
              </svg>
            </button>
            <div id="menuDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-md shadow-lg">
              <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Advertisers</a>
              <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Profile</a>
              <a href="#" id="menuAdmin" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Admin</a>
              <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Sign Out</a>
            </div>
          </div>
        </nav>
      </div>
    </header>

    <!-- Breadcrumb Bar -->
    <div class="bg-white border-b border-gray-200 px-6 py-2">
      <nav class="flex items-center text-sm text-gray-600" id="breadcrumbNav">
        <a href="./index.html" class="hover:text-blue-600 transition-colors">Advertisers</a>
        <svg class="w-4 h-4 mx-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
        <a href="#" id="breadcrumbAdvertiser" class="hover:text-blue-600 transition-colors">Advertiser: ‚Äî</a>
        <svg class="w-4 h-4 mx-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
        <!-- Dynamic middle section: either "Campaigns > Campaign: X" or just "Ad Groups" -->
        <span id="breadcrumbMiddle"></span>
        <svg class="w-4 h-4 mx-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
        <span class="font-semibold text-gray-900" id="breadcrumbAdGroup">Ad Group: ‚Äî</span>
      </nav>
    </div>

    <!-- Body -->
    <div class="flex flex-1 overflow-hidden">
      <!-- Sidebar -->
      <nav id="sidebar" class="bg-white w-64 p-4 border-r border-gray-200 overflow-y-auto transition-all duration-200 ease-in-out">
  <div class="flex items-center justify-between pb-4 border-b border-gray-200">
    <div class="flex items-center gap-3">
      <img src="./assets/advertiser.png" alt="Advertiser" class="w-9 h-9 rounded-full" data-sidebar-avatar />
      <h2 data-sidebar-header class="text-base text-lg font-semibold text-gray-800">Advertiser</h2>
    </div>
    <button id="sidebarToggle" class="p-1 rounded hover:bg-gray-100" aria-label="Toggle sidebar" aria-expanded="true" title="Collapse/Expand">
      <svg id="iconCollapse" class="w-5 h-5 text-gray-900" viewBox="0 0 26 26" fill="currentColor">
        <path fill="#000000" d="M21.5 11.5h-8.793l3.035-3.035a.5.5 0 10-.707-.707l-3.888 3.888a.518.518 0 00-.109.163.505.505 0 000 .382.518.518 0 00.109.163l3.888 3.888a.5.5 0 00.707-.707L12.707 12.5H21.5a.5.5 0 000-1zM7.5 2h-5a.5.5 0 000 1h5a.5.5 0 000-1zM7.5 7h-5a.5.5 0 000 1h5a.5.5 0 000-1zM7.5 11.5h-5a.5.5 0 000 1h5a.5.5 0 000-1zM7.5 16h-5a.5.5 0 000 1h5a.5.5 0 000-1zM7.5 21h-5a.5.5 0 000 1h5a.5.5 0 000-1z"></path>
      </svg>
      <svg id="iconExpand" class="w-5 h-5 text-gray-900 hidden" viewBox="0 0 26 26" fill="currentColor">
        <path fill="#000000" d="M21.962 12.191a.505.505 0 000-.382.518.518 0 00-.109-.163l-3.888-3.888a.5.5 0 10-.707.707l3.035 3.035H11.5a.5.5 0 000 1h8.793l-3.035 3.035a.5.5 0 10.707.707l3.888-3.888a.518.518 0 00.109-.163zM7.5 2h-5a.5.5 0 000 1h5a.5.5 0 000-1zM7.5 7h-5a.5.5 0 000 1h5a.5.5 0 000-1zM7.5 11.5h-5a.5.5 0 000 1h5a.5.5 0 000-1zM7.5 16h-5a.5.5 0 000 1h5a.5.5 0 000-1zM7.5 21h-5a.5.5 0 000 1h5a.5.5 0 000-1z"></path>
      </svg>
    </button>
  </div>

  <ul class="space-y-1 mt-4">
    <li>
<li>
  <a href="./WFAdvertiserDetails.html" data-nav-link class="flex items-center px-1 py-2 text-sm text-gray-700 hover:bg-blue-50 rounded-md">
        <img src="./assets/svgs/Details.svg" alt="Details" class="w-6 h-6 mr-2" />
        <span data-link-label>Overview</span>
      </a>
    </li>
    <li>
      <a href="./AdvertiserSalesOrder.html" data-nav-link class="flex items-center px-1 py-2 text-sm text-gray-700 hover:bg-blue-50 rounded-md">
        <img src="./assets/svgs/SalesOrderExpense.svg" alt="Sales Orders" class="w-6 h-6 mr-2" />
        <span data-link-label>Sales Orders</span>
      </a>
    </li>
    <li>
      <a href="./WFAdvertiserConnections.html" data-nav-link class="flex items-center px-1 py-2 text-sm text-gray-700 hover:bg-blue-50 rounded-md">
        <img src="./assets/svgs/Blueprint.svg" alt="Connections" class="w-6 h-6 mr-2" />
        <span data-link-label>Connections (P2)</span>
      </a>
    </li>
    <li>
      <a href="./AdvertiserCampaigns.html" data-nav-link class="flex items-center px-1 py-2 text-sm text-gray-700 hover:bg-blue-50 rounded-md">
        <img src="./assets/svgs/CampaignsSchedules.svg" alt="Campaigns" class="w-6 h-6 mr-2" />
        <span data-link-label>Campaigns</span>
      </a>
    </li>
    <li>
      <a href="./AdvertiserAdGroup.html" data-nav-link class="flex items-center px-1 py-2 text-sm text-gray-700 hover:bg-blue-50 rounded-md">
        <img src="./assets/svgs/AdGroups.svg" class="w-6 h-6 mr-2" alt="">
        <span data-link-label>Ad Groups</span>
      </a>
    </li>
    <!-- CAD (added) -->
    <li>
      <a href="./CAD.html" data-nav-link class="flex items-center px-1 py-2 text-sm text-gray-700 hover:bg-blue-50 rounded-md">
        <img src="./assets/svgs/Blueprint.svg" class="w-6 h-6 mr-2" alt="CAD">
        <span data-link-label>CAD</span>
      </a>
    </li>
  </ul>
</nav>

      <!-- Main -->
      <main class="flex-1 overflow-y-auto p-6">
        <div class="bg-white rounded-lg shadow-sm">
          <div class="p-4 border-b border-gray-200">
            <div class="flex items-start gap-4 mb-3">
              <div class="flex-1">
                <h1 id="advertiserHeader" class="md:text-2xl font-semibold text-gray-900">Loading‚Ä¶</h1>

                <div class="flex justify-between items-center">
                  <h3 class="text-sm font-semibold text-gray-600">Account #: <span data-bind="adv.account" class="text-sm text-gray-500">‚Äî</span></h3>
                  <h3 class="text-sm font-semibold text-gray-600">ID: <span data-bind="adv.id" class="text-sm text-gray-500">‚Äî</span></h3>
                </div>
              </div>
            </div>

            <hr class="border-gray-300 mp-4 p-2">

            <!-- Two-column ad group details layout -->
            <section>
              <div class="flex items-center justify-between mb-6">
                <h1 id="adGroupDetailsTitle" class="text-2xl font-semibold text-gray-900 mx-2">AD GROUP DETAILS</h1>
                <div class="flex items-center gap-2">
                  <button id="editGeneralBtn" class="text-sm px-3 py-1 bg-white border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                  <svg viewBox="0 0 24 24" height="16" width="16">
                    <path fill="#454B57" d="M21.53 4.11l-1.64-1.64a1.57 1.57 0 00-2.22 0L4.74 15.4a2.41 2.41 0 00-.55.83L2 21.58a.32.32 0 00.3.43h.11l5.35-2.18a2.41 2.41 0 00.83-.55l4.14-4.14 8.79-8.79a1.56 1.56 0 00.01-2.24zM5 17l2 2-3.43 1.4zm7-2.59l-4.11 4.14-2.44-2.44L16 5.53 18.47 8zm8.79-8.79l-1.62 1.65-2.44-2.44 1.65-1.66a.59.59 0 01.4-.16.58.58 0 01.4.16l1.65 1.65a.58.58 0 01.16.4.59.59 0 01-.16.4z"></path>
                  </svg>
                  Edit
                  </button>
                  <button id="saveGeneralBtn" class="hidden text-sm px-3 py-1 bg-blue-600 text-white border border-blue-600 rounded-md hover:bg-blue-700">Save</button>
                  <button id="cancelGeneralBtn" class="hidden text-sm px-3 py-1 bg-white text-gray-700 border border-gray-300 rounded-md hover:bg-gray-50">Cancel</button>
                </div>
              </div>

              <!-- Two Column Layout -->
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <!-- Common Data Column -->
                <div class="overflow-x-auto border border-default rounded-md self-start">
                  <table class="w-full tbl tbl-row-hover table-fixed adgroup-details-table">
                    <colgroup>
                      <col class="w-1/3">
                      <col class="w-2/3">
                    </colgroup>
                    <thead class="tbl-head">
                      <tr>
                        <th colspan="2" class="px-6 py-2 text-left text-sm font-medium text-gray-700 uppercase tracking-wider">
                          BEACON FIELDS
                        </th>
                      </tr>
                    </thead>
                    <tbody class="divide-y border-default">
                      
                      <!-- ID -->
                      <tr class="border-b border-default">
                        <td class="px-3 py-1 text-sm font-medium border-r border-default">
                          ID
                        </td>
                        <td class="px-6 py-1 text-sm">
                          <span id="displayAdGroupId" class="text-gray-800 break-words">N/A</span>
                        </td>
                      </tr>

                      <!-- Name -->
                      <tr class="border-b border-default">
                        <td class="px-3 py-1 text-sm font-medium border-r border-default">
                          Name
                        </td>
                        <td class="px-6 py-1 text-sm">
                          <span id="displayAdGroupName" class="text-gray-800 break-words">N/A</span>
                          <input id="inputAdGroupName" type="text" class="hidden adgroup-details-input" />
                        </td>
                      </tr>

                      <!-- Campaign -->
                      <tr class="border-b border-default">
                        <td class="px-3 py-1 text-sm font-medium border-r border-default">
                          Campaign
                        </td>
                        <td class="px-6 py-1 text-sm">
                          <span id="displayCampaign" class="text-gray-800 break-words">N/A</span>
                          <select id="inputCampaign" class="hidden adgroup-details-input">
                            <option value="">Select campaign</option>
                          </select>
                        </td>
                      </tr>

                      <!-- Multiview Classification -->
                      <tr class="border-b border-default">
                        <td class="px-3 py-1 text-sm font-medium border-r border-default">
                          Multiview Classification
                        </td>
                        <td class="px-6 py-1 text-sm">
                          <span id="displayMultiviewClassification" class="text-gray-800 break-words">N/A</span>
                          <select id="inputMultiviewClassification" class="hidden adgroup-details-input">
                            <option value="">-- Select --</option>
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                          </select>
                        </td>
                      </tr>

                      <!-- Multiview Tactic -->
                      <tr class="border-b border-default">
                        <td class="px-3 py-1 text-sm font-medium border-r border-default">
                          Multiview Tactic
                        </td>
                        <td class="px-6 py-1 text-sm">
                          <span id="displayMultiviewTactic" class="text-gray-800 break-words">N/A</span>
                          <select id="inputMultiviewTactic" class="hidden adgroup-details-input">
                            <option value="">-- Select --</option>
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                          </select>
                        </td>
                      </tr>

                      <!-- Audience -->
                      <tr class="border-b border-default">
                        <td class="px-3 py-1 text-sm font-medium border-r border-default">
                          Audience
                        </td>
                        <td class="px-6 py-1 text-sm">
                          <span id="displayBeaconAudience" class="text-gray-800 break-words">N/A</span>
                          <input id="inputBeaconAudience" type="text" class="hidden adgroup-details-input" />
                        </td>
                      </tr>

                    </tbody>
                  </table>
                </div>

                <!-- Right Column - DSP and Ad Server Fields -->
                <div class="space-y-6">
                  
                  <!-- DSP Fields Table -->
                  <div class="overflow-x-auto border border-default rounded-md">
                    <table class="w-full tbl tbl-row-hover table-fixed adgroup-details-table">
                      <colgroup>
                        <col class="w-1/3">
                        <col class="w-2/3">
                      </colgroup>
                      <thead style="background-color: #dbeafe;">
                        <tr>
                          <th colspan="2" class="px-6 py-2 text-left text-sm font-medium text-blue-900 uppercase tracking-wider">
                            DSP FIELDS
                          </th>
                        </tr>
                      </thead>
                      <tbody class="divide-y border-default">



                        <!-- Name -->
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">
                            Name
                          </td>
                          <td class="px-6 py-1 text-sm">
                            <span id="displayDspName" class="text-gray-800 break-words">N/A</span>
                            <input id="adGroupNameInput" type="text" class="hidden adgroup-details-input" />
                          </td>
                        </tr>

                        <!-- Funnel Location -->
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">
                            Funnel Location
                          </td>
                          <td class="px-6 py-1 text-sm">
                            <span id="displayFunnelLocation" class="text-gray-800 break-words">N/A</span>
                            <select id="funnelLocationInput" class="hidden adgroup-details-input">
                              <option value="">Select funnel location</option>
                              <option value="Awareness">Awareness</option>
                              <option value="Consideration">Consideration</option>
                              <option value="Conversion">Conversion</option>
                              <option value="Loyalty">Loyalty</option>
                            </select>
                          </td>
                        </tr>

                        <!-- Channel -->
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">
                            Channel
                          </td>
                          <td class="px-6 py-1 text-sm">
                            <span id="displayChannel" class="text-gray-800 break-words">N/A</span>
                            <select id="channelInput" class="hidden adgroup-details-input">
                              <option value="">Select channel</option>
                              <option value="Display">Display</option>
                              <option value="Video">Video</option>
                              <option value="Audio">Audio</option>
                              <option value="Native Display">Native Display</option>
                              <option value="Native Video">Native Video</option>
                              <option value="TV">TV</option>
                              <option value="Out of Home">Out of Home</option>
                            </select>
                          </td>
                        </tr>

                        <!-- Device Types -->
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">
                            Device Types
                          </td>
                          <td class="px-6 py-1 text-sm">
                            <span id="displayDeviceTypes" class="text-gray-800 break-words">N/A</span>
                            <input id="deviceTypesInput" type="text" class="hidden adgroup-details-input" placeholder="Comma-separated values" />
                          </td>
                        </tr>

                        <!-- Ad Environments -->
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">
                            Ad Environments
                          </td>
                          <td class="px-6 py-1 text-sm">
                            <span id="displayAdEnvironments" class="text-gray-800 break-words">N/A</span>
                            <input id="adEnvironmentsInput" type="text" class="hidden adgroup-details-input" placeholder="Comma-separated values" />
                          </td>
                        </tr>

                        <!-- Primary Goal -->
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">
                            Primary Goal
                          </td>
                          <td class="px-6 py-1 text-sm">
                            <span id="displayPrimaryGoal" class="text-gray-800 break-words">N/A</span>
                            <select id="primaryGoalInput" class="hidden adgroup-details-input">
                              <option value="">Select primary goal</option>
                              <option value="Cost per Acquisition (CPA)">Cost per Acquisition (CPA)</option>
                              <option value="Cost Per Mille (CPM)">Cost Per Mille (CPM)</option>
                            </select>
                          </td>
                        </tr>

                        <!-- Target -->
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">
                            Target
                          </td>
                          <td class="px-6 py-1 text-sm">
                            <span id="displayTarget" class="text-gray-800 break-words">N/A</span>
                            <input id="targetInput" type="text" class="hidden adgroup-details-input" placeholder="$0.00" />
                          </td>
                        </tr>

                        <!-- Audience -->
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">
                            Audience
                          </td>
                          <td class="px-6 py-1 text-sm">
                            <span id="displayDspAudience" class="text-gray-800 break-words">N/A</span>
                            <select id="inputDspAudience" class="hidden adgroup-details-input">
                              <option value="">Select audience</option>
                              <option value="Apply a shared audience">Apply a shared audience</option>
                              <option value="Koa Audiences">Koa Audiences</option>
                              <option value="Target Everyone">Target Everyone</option>
                            </select>
                          </td>
                        </tr>

                        <!-- Frequency -->
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">
                            Frequency
                          </td>
                          <td class="px-6 py-1 text-sm">
                            <span id="displayFrequency" class="text-gray-800 break-words">N/A</span>
                            <input id="frequencyInput" type="text" class="hidden adgroup-details-input" placeholder="e.g., 4 ads per 1 day" />
                          </td>
                        </tr>

                        <!-- Geos -->
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">
                            Geos
                          </td>
                          <td class="px-6 py-1 text-sm">
                            <span id="displayGeos" class="text-gray-800 break-words">N/A</span>
                            <select id="geosInput" class="hidden adgroup-details-input">
                              <option value="">Select geos</option>
                              <option value="Specific Locations">Specific Locations</option>
                              <option value="Everywhere">Everywhere</option>
                            </select>
                          </td>
                        </tr>

                        <!-- Base Bid -->
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">
                            Base Bid
                          </td>
                          <td class="px-6 py-1 text-sm">
                            <span id="displayBaseBid" class="text-gray-800 break-words">N/A</span>
                            <input id="baseBidInput" type="text" class="hidden adgroup-details-input" placeholder="$0.00" />
                          </td>
                        </tr>

                        <!-- Max Bid -->
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">
                            Max Bid
                          </td>
                          <td class="px-6 py-1 text-sm">
                            <span id="displayMaxBid" class="text-gray-800 break-words">N/A</span>
                            <input id="maxBidInput" type="text" class="hidden adgroup-details-input" placeholder="$0.00" />
                          </td>
                        </tr>

                      </tbody>
                    </table>
                  </div>

                  <!-- Ad Server Fields Table -->
                  <div class="overflow-x-auto border border-default rounded-md">
                    <table class="w-full tbl tbl-row-hover table-fixed adgroup-details-table">
                      <colgroup>
                        <col class="w-1/3">
                        <col class="w-2/3">
                      </colgroup>
                      <thead style="background-color: #d1fae5;">
                        <tr>
                          <th colspan="2" class="px-6 py-2 text-left text-sm font-medium text-green-900 uppercase tracking-wider">
                            AD SERVER FIELDS
                          </th>
                        </tr>
                      </thead>
                      <tbody class="divide-y border-default">

                        <!-- Name -->
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">
                            Name
                          </td>
                          <td class="px-6 py-1 text-sm">
                            <span id="displayAdServerName" class="text-gray-800 break-words">N/A</span>
                            <input id="adServerNameInput" type="text" class="hidden adgroup-details-input" />
                          </td>
                        </tr>

                        <!-- Status -->
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">
                            Status
                          </td>
                          <td class="px-6 py-1 text-sm">
                            <span id="displayAdServerStatus" class="text-gray-800 break-words">N/A</span>
                            <select id="adServerStatusInput" class="hidden adgroup-details-input">
                              <option value="">Select status</option>
                              <option value="Active">Active</option>
                              <option value="Inactive">Inactive</option>
                            </select>
                          </td>
                        </tr>

                        <!-- Compatibility -->
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">
                            Compatibility
                          </td>
                          <td class="px-6 py-1 text-sm">
                            <span id="displayAdServerCompatibility" class="text-gray-800 break-words">N/A</span>
                            <select id="adServerCompatibilityInput" class="hidden adgroup-details-input">
                              <option value="">Select compatibility</option>
                              <option value="Display">Display</option>
                              <option value="Persona">Persona</option>
                              <option value="Video">Video</option>
                              <option value="Audio">Audio</option>
                            </select>
                          </td>
                        </tr>

                        <!-- Dimensions -->
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">
                            Dimensions
                          </td>
                          <td class="px-6 py-1 text-sm">
                            <span id="displayAdServerDimensions" class="text-gray-800 break-words">N/A</span>
                            <input id="adServerDimensionsInput" type="text" class="hidden adgroup-details-input" placeholder="Comma-separated values" />
                          </td>
                        </tr>

                        <!-- Testing Starts -->
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">
                            Testing Starts
                          </td>
                          <td class="px-6 py-1 text-sm">
                            <span id="displayAdServerTestingStarts" class="text-gray-800 break-words">N/A</span>
                            <input id="adServerTestingStartsInput" type="date" class="hidden adgroup-details-input" />
                          </td>
                        </tr>

                        <!-- Start Date -->
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">
                            Start Date
                          </td>
                          <td class="px-6 py-1 text-sm">
                            <span id="displayAdServerStartDate" class="text-gray-800 break-words">N/A</span>
                            <input id="adServerStartDateInput" type="date" class="hidden adgroup-details-input" />
                          </td>
                        </tr>

                        <!-- End Date -->
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">
                            End Date
                          </td>
                          <td class="px-6 py-1 text-sm">
                            <span id="displayAdServerEndDate" class="text-gray-800 break-words">N/A</span>
                            <input id="adServerEndDateInput" type="date" class="hidden adgroup-details-input" />
                          </td>
                        </tr>

                        <!-- Cost Structure -->
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">
                            Cost Structure
                          </td>
                          <td class="px-6 py-1 text-sm">
                            <span id="displayAdServerCostStructure" class="text-gray-800 break-words">N/A</span>
                            <select id="adServerCostStructureInput" class="hidden adgroup-details-input">
                              <option value="">Select cost structure</option>
                              <option value="Cost Per Mille (CPM)">Cost Per Mille (CPM)</option>
                              <option value="Click-Through Rate (CTR)">Click-Through Rate (CTR)</option>
                            </select>
                          </td>
                        </tr>

                        <!-- Cap Cost -->
                        <tr class="border-b border-default">
                          <td class="px-3 py-1 text-sm font-medium border-r border-default">
                            Cap Cost
                          </td>
                          <td class="px-6 py-1 text-sm">
                            <span id="displayAdServerCapCost" class="text-gray-800 break-words">N/A</span>
                            <select id="adServerCapCostInput" class="hidden adgroup-details-input">
                              <option value="">Select cap cost</option>
                              <option value="OFF">OFF</option>
                              <option value="ON">ON</option>
                            </select>
                          </td>
                        </tr>

                      </tbody>
                    </table>
                  </div>

                </div>

              </div>
            </section>

                      <script>
                        (function() {
                        const pairs = [
  // Beacon Fields
  { span: 'displayAdGroupName', input: 'inputAdGroupName' },
  { span: 'displayCampaign', input: 'inputCampaign' },
  { span: 'displayMultiviewClassification', input: 'inputMultiviewClassification' },
  { span: 'displayMultiviewTactic', input: 'inputMultiviewTactic' },
  { span: 'displayBeaconAudience', input: 'inputBeaconAudience' },
  // DSP Fields (these are linked to actual ad group data)
  { span: 'displayDspName', input: 'adGroupNameInput' },
  { span: 'displayFunnelLocation', input: 'funnelLocationInput' },
  { span: 'displayChannel', input: 'channelInput' },
  { span: 'displayDeviceTypes', input: 'deviceTypesInput' },
  { span: 'displayAdEnvironments', input: 'adEnvironmentsInput' },
  { span: 'displayPrimaryGoal', input: 'primaryGoalInput' },
  { span: 'displayTarget', input: 'targetInput' },
  { span: 'displayDspAudience', input: 'inputDspAudience' },
  { span: 'displayFrequency', input: 'frequencyInput' },
  { span: 'displayGeos', input: 'geosInput' },
  { span: 'displayBaseBid', input: 'baseBidInput' },
  { span: 'displayMaxBid', input: 'maxBidInput' },
  // Ad Server Fields
  { span: 'displayAdServerName', input: 'adServerNameInput' },
  { span: 'displayAdServerStatus', input: 'adServerStatusInput' },
  { span: 'displayAdServerCompatibility', input: 'adServerCompatibilityInput' },
  { span: 'displayAdServerDimensions', input: 'adServerDimensionsInput' },
  { span: 'displayAdServerTestingStarts', input: 'adServerTestingStartsInput' },
  { span: 'displayAdServerStartDate', input: 'adServerStartDateInput' },
  { span: 'displayAdServerEndDate', input: 'adServerEndDateInput' },
  { span: 'displayAdServerCostStructure', input: 'adServerCostStructureInput' },
  { span: 'displayAdServerCapCost', input: 'adServerCapCostInput' }
];

                        // Fields that are linked to actual ad group data (excluding Common Data section)
                        const adGroupLinkedFields = [
  // Beacon Fields
  'inputAdGroupName',
  'inputCampaign',
  'inputMultiviewClassification',
  'inputMultiviewTactic',
  'inputBeaconAudience',
  // DSP Fields
  'adGroupNameInput',
  'funnelLocationInput',
  'channelInput',
  'deviceTypesInput',
  'inputDspAudience',
  'adEnvironmentsInput',
  'primaryGoalInput',
  'targetInput',
  'audienceInput',
  'frequencyInput',
  'geosInput',
  'baseBidInput',
  'maxBidInput',
  // Ad Server Fields
  'adServerNameInput',
  'adServerStatusInput',
  'adServerCompatibilityInput',
  'adServerDimensionsInput',
  'adServerTestingStartsInput',
  'adServerStartDateInput',
  'adServerEndDateInput',
  'adServerCostStructureInput',
  'adServerCapCostInput'
];

                        const btnEdit   = document.getElementById('editGeneralBtn');
                        const btnSave   = document.getElementById('saveGeneralBtn');
                        const btnCancel = document.getElementById('cancelGeneralBtn');

                        let snapshot = null;
                        let inlineEditing = false;

                        function showInputs() {
                          pairs.forEach(p => {
                          const span = document.getElementById(p.span);
                          const input = document.getElementById(p.input);
                          if (!span || !input) return;
                          input.classList.remove('hidden');
                          span.classList.add('hidden');
                          
                          let value = span.textContent.trim();
                          
                          // For number inputs (budget fields), extract numeric value or leave empty
                          if (input.type === 'number') {
                            // Remove currency symbols, commas, and extract numbers
                            const numMatch = value.match(/[\d,]+/);
                            if (numMatch && value !== 'N/A' && value !== '‚Äî') {
                              value = numMatch[0].replace(/,/g, '');
                            } else {
                              value = ''; // Leave empty if N/A or no valid number
                            }
                          }
                          
                          input.value = value;
                          });
                        }
                        function showSpans() {
                          pairs.forEach(p => {
                          const span = document.getElementById(p.span);
                          const input = document.getElementById(p.input);
                          if (!span || !input) return;
                          
                          // Update span with input value, handling empty values
                          let displayValue = input.value.trim();
                          if (!displayValue || displayValue === '') {
                            displayValue = 'N/A';
                          }
                          
                          // Format currency for budget fields
                          if (input.type === 'number' && displayValue !== 'N/A') {
                            const numValue = parseFloat(displayValue);
                            if (!isNaN(numValue)) {
                              displayValue = `$${numValue.toLocaleString()}`;
                            }
                          }
                          
                          span.textContent = displayValue;
                          input.classList.add('hidden');
                          span.classList.remove('hidden');
                          });
                        }

                        function currentValues() {
                          const obj = {};
                          pairs.forEach(p => {
                          const input = document.getElementById(p.input);
                          if (input) obj[p.input] = input.value.trim();
                          });
                          return obj;
                        }

                        function currentAdGroupValues() {
                          const obj = {};
                          adGroupLinkedFields.forEach(fieldName => {
                          const input = document.getElementById(fieldName);
                          if (input) obj[fieldName] = input.value.trim();
                          });
                          
                          return obj;
                        }
                        function shallowEqual(a,b){
                          const ka = Object.keys(a), kb = Object.keys(b);
                          if (ka.length !== kb.length) return false;
                          for (const k of ka) if (a[k] !== b[k]) return false;
                          return true;
                        }

                        btnEdit?.addEventListener('click', () => {
                          // Start inline editing for these ad group fields
                          inlineEditing = true;
                          snapshot = currentAdGroupValues(); // Only snapshot ad group-linked fields
                          showInputs();
                          
                          // Auto-focus the first editable field for immediate editing
                          const firstInput = document.getElementById('adGroupNameInput');
                          if (firstInput) {
                            setTimeout(() => firstInput.focus(), 50);
                          }
                        });

                        btnCancel?.addEventListener('click', () => {
                          if (!inlineEditing) return;
                          // Revert only ad group-linked fields
                          adGroupLinkedFields.forEach(fieldName => {
                          const input = document.getElementById(fieldName);
                          if (input && snapshot && snapshot[fieldName] != null) {
                            input.value = snapshot[fieldName];
                          }
                          });
                          showSpans();
                          inlineEditing = false;
                          snapshot = null;
                        });

                        btnSave?.addEventListener('click', () => {
                          if (!inlineEditing) return;
                          const now = currentAdGroupValues(); // Only get ad group-linked values
                          if (snapshot && shallowEqual(snapshot, now)) {
                          // No change
                          showSpans();
                          inlineEditing = false;
                          snapshot = null;
                          return;
                          }

                          // === AUDIT TRACKING ===
                          // Get ad group ID from URL params
                          const urlParams = new URLSearchParams(window.location.search);
                          const adGroupId = urlParams.get('id') || urlParams.get('adGroupId');
                          let campaignId = urlParams.get('campaignId');
                          
                          if (!adGroupId) {
                            alert('Ad Group ID not found in URL');
                            return;
                          }
                          
                          // Load ad group from storage to get campaignId if not in URL
                          try {
                            const adgroups = JSON.parse(localStorage.getItem('adgroups_data_v1') || '[]');
                            const adGroupIndex = adgroups.findIndex(ag => ag.id === adGroupId);
                            
                            if (adGroupIndex === -1) {
                              console.error('Ad group not found with ID:', adGroupId);
                              alert('Error: Ad group not found');
                              return;
                            }
                            
                            const adGroup = adgroups[adGroupIndex];
                            
                            // If campaignId not in URL, try to get it from the ad group's campaign field
                            if (!campaignId && adGroup.campaign) {
                              campaignId = adGroup.campaign;
                              console.log('üìã Using campaignId from ad group data:', campaignId);
                            }
                            
                            // === AUDIT TRACKING ===
                            if (campaignId && snapshot && window.audit) {
                              try {
                                window.audit.recordEdit({
                                  campaignId: campaignId,
                                  entityType: 'adgroup',
                                  entityId: adGroupId,
                                  before: snapshot,
                                  after: now
                                });
                                console.log('‚úèÔ∏è Audit logged for Ad Group edit:', adGroupId, 'Campaign:', campaignId);
                              } catch (e) {
                                console.warn('Failed to record audit edit:', e);
                              }
                            } else {
                              console.warn('‚ö†Ô∏è Audit NOT logged - missing campaignId or audit system');
                              console.log('campaignId:', campaignId, 'snapshot:', !!snapshot, 'window.audit:', !!window.audit);
                            }

                            // === UPDATE AD GROUP DATA ===
                            // Update Beacon Fields
                            if (now.inputAdGroupName !== undefined) adGroup.name = now.inputAdGroupName;
                            if (now.inputCampaign !== undefined) adGroup.campaign = now.inputCampaign;
                            if (now.inputMultiviewClassification !== undefined) adGroup.multiviewClassification = now.inputMultiviewClassification;
                            if (now.inputMultiviewTactic !== undefined) adGroup.multiviewTactic = now.inputMultiviewTactic;
                            if (now.inputBeaconAudience !== undefined) adGroup.beaconAudience = now.inputBeaconAudience;
                            
                            // Update DSP Fields
                            if (now.adGroupNameInput !== undefined) adGroup.dspName = now.adGroupNameInput;
                            if (now.funnelLocationInput !== undefined) adGroup.funnelLocation = now.funnelLocationInput;
                            if (now.channelInput !== undefined) adGroup.channel = now.channelInput;
                            if (now.deviceTypesInput !== undefined) adGroup.deviceTypes = now.deviceTypesInput;
                            if (now.adEnvironmentsInput !== undefined) adGroup.adEnvironments = now.adEnvironmentsInput;
                            if (now.primaryGoalInput !== undefined) adGroup.primaryGoal = now.primaryGoalInput;
                            if (now.targetInput !== undefined) adGroup.target = now.targetInput;
                            if (now.inputDspAudience !== undefined) adGroup.dspAudience = now.inputDspAudience;
                            if (now.frequencyInput !== undefined) adGroup.frequency = now.frequencyInput;
                            if (now.geosInput !== undefined) adGroup.geos = now.geosInput;
                            if (now.baseBidInput !== undefined) adGroup.baseBid = now.baseBidInput;
                            if (now.maxBidInput !== undefined) adGroup.maxBid = now.maxBidInput;
                            
                            // Update Ad Server Fields
                            if (now.adServerNameInput !== undefined) adGroup.adServerName = now.adServerNameInput;
                            if (now.adServerStatusInput !== undefined) adGroup.adServerStatus = now.adServerStatusInput;
                            if (now.adServerCompatibilityInput !== undefined) adGroup.adServerCompatibility = now.adServerCompatibilityInput;
                            if (now.adServerDimensionsInput !== undefined) adGroup.adServerDimensions = now.adServerDimensionsInput;
                            if (now.adServerTestingStartsInput !== undefined) adGroup.adServerTestingStarts = now.adServerTestingStartsInput;
                            if (now.adServerStartDateInput !== undefined) adGroup.adServerStartDate = now.adServerStartDateInput;
                            if (now.adServerEndDateInput !== undefined) adGroup.adServerEndDate = now.adServerEndDateInput;
                            if (now.adServerCostStructureInput !== undefined) adGroup.adServerCostStructure = now.adServerCostStructureInput;
                            if (now.adServerCapCostInput !== undefined) adGroup.adServerCapCost = now.adServerCapCostInput;
                            
                            // Legacy fields
                            if (now.campaignName !== undefined) adGroup.campaign = now.campaignName;
                            if (now.budgetAllocation !== undefined) adGroup.budget = now.budgetAllocation;
                            if (now.bidStrategy !== undefined) adGroup.bidStrategy = now.bidStrategy;
                            if (now.creativeFormat !== undefined) adGroup.creativeFormat = now.creativeFormat;
                            if (now.targetingRefinements !== undefined) adGroup.targetingRefinements = now.targetingRefinements;
                            if (now.placementSettings !== undefined) adGroup.placementSettings = now.placementSettings;
                            if (now.adServerAdGroupName !== undefined) adGroup.adServerAdGroupName = now.adServerAdGroupName;
                            if (now.adServerPlacement !== undefined) adGroup.adServerPlacement = now.adServerPlacement;
                            
                            // Ensure campaignId is stored on the ad group object
                            if (campaignId && !adGroup.campaignId) {
                              adGroup.campaignId = campaignId;
                            }

                            // Save back to localStorage
                            localStorage.setItem('adgroups_data_v1', JSON.stringify(adgroups));
                            console.log('‚úîÔ∏è Ad group saved successfully');
                            
                          } catch (error) {
                            console.error('Error saving ad group:', error);
                            alert('Error saving ad group. Check console for details.');
                            return;
                          }

                          // Commit to spans
                          showSpans();
                          inlineEditing = false;
                          snapshot = null;
                        });
                        })();
                      </script>
                      

                    </section>
                  </div>
                  </div>
                </div>
                </main>
              </div>
              </div>
  <!-- Waffle menu toggle -->
  <script>
    const menuButton = document.getElementById('menuButton');
    const menuDropdown = document.getElementById('menuDropdown');
    if (menuButton && menuDropdown) {
      menuButton.addEventListener('click', (e) => {
        e.stopPropagation();
        menuDropdown.classList.toggle('hidden');
      });
      document.addEventListener('click', (event) => {
        if (!menuButton.contains(event.target) && !menuDropdown.contains(event.target)) {
          menuDropdown.classList.add('hidden');
        }
      });
    }
  </script>

  <!-- Details page data-binding -->
  <script>
    (function() {
      const STORAGE_KEY_DATA = 'adv_list_data';

      function loadAdvertisersFromStorage() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY_DATA);
          return raw ? JSON.parse(raw) : [];
        } catch { return []; }
      }

      function bindAll(key, value, fallback = '‚Äî') {
        const nodes = document.querySelectorAll(`[data-bind="${key}"]`);
        const text = (value != null && String(value).trim() !== '') ? value : fallback;
        nodes.forEach(el => {
          if (el.tagName === 'INPUT' || el.tagName === 'SELECT') {
            el.value = text;
            el.setAttribute('data-original', text);
          } else {
            el.textContent = text;
            if (key === 'adv.account') {
              const accountDisplay = document.getElementById('accountDisplay');
              const accountLookupBtn = document.getElementById('accountLookupBtn');
              if (accountDisplay && accountLookupBtn) {
                if (text && text !== '‚Äî' && text !== 'N/A') {
                  accountDisplay.classList.remove('hidden');
                  accountLookupBtn.classList.add('hidden');
                } else {
                  accountDisplay.classList.add('hidden');
                  accountLookupBtn.classList.remove('hidden');
                }
              }
            }
          }
        });
      }

      document.addEventListener('DOMContentLoaded', () => {
        let adv = null;
        try {
          const rawObj = localStorage.getItem('adv_selected_data');
          if (rawObj) adv = JSON.parse(rawObj);
        } catch {}

        const selectedId = localStorage.getItem('adv_selected_id');
        if (!adv && selectedId) {
          const advertisers = loadAdvertisersFromStorage();
          adv = advertisers.find(a => String(a.id) === String(selectedId)) || null;
        }
        if (!adv) {
          const advertisers = loadAdvertisersFromStorage();
          adv = (advertisers && advertisers.length) ? advertisers[0] : null;
        }

        if (adv) {
          // MIGRATION: Handle both 'status' and 'state' fields for backward compatibility
          if (adv.status && !adv.state) {
            adv.state = adv.status;
          }
          
          bindAll('adv.name', adv.name, 'No advertiser found');
          const advHeader = document.getElementById('advertiserHeader');
if (advHeader) advHeader.textContent = adv.name || 'No advertiser found';

          bindAll('adv.id', adv.id, '');
          bindAll('adv.account', adv.account, 'N/A');
          bindAll('adv.state', adv.state, 'N/A');     // ‚úì use state field
          bindAll('adv.website', adv.website, 'N/A');
        } else {
          bindAll('adv.name', 'No advertiser found', 'No advertiser found');
          bindAll('adv.id', '', '');
          bindAll('adv.account', 'N/A', 'N/A');
          bindAll('adv.state', 'N/A', 'N/A');
          bindAll('adv.website', 'N/A', 'N/A');
        }

        // Expose for other modules if needed
        window.bindAll = bindAll;
      });
    })();
  </script>

  <!-- Team filter -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const chip = document.getElementById('teamStateChip');
      const menu = document.getElementById('teamStateMenu');
      const label = document.getElementById('teamStateChipLabel');
      const tbody = document.getElementById('teamTableBody');
      if (!chip || !menu || !label || !tbody) return;

      const closeMenu = () => { menu.classList.add('hidden'); chip.setAttribute('aria-expanded', 'false'); };

      chip.addEventListener('click', (e) => {
        e.stopPropagation();
        const open = menu.classList.toggle('hidden');
        chip.setAttribute('aria-expanded', String(!open));
        if (!open) { menu.setAttribute('tabindex','-1'); menu.focus(); }
      });

      document.addEventListener('click', closeMenu);

      menu.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') { closeMenu(); chip.focus(); }
      });

      menu.addEventListener('click', (e) => {
        const btn = e.target.closest('button'); if (!btn) return;
        const value = btn.dataset.value;
        label.textContent = value;

        tbody.querySelectorAll('tr').forEach(row => {
          const rowState = (row.getAttribute('data-state') || '').toLowerCase().trim();
          let show = true;
          if (value === 'Active') show = rowState === 'active';
          else if (value === 'Inactive') show = rowState === 'inactive';
          else show = true;
          row.style.display = show ? '' : 'none';
        });

        closeMenu();
      });

      // Default view = Active
      label.textContent = 'Active';
      tbody.querySelectorAll('tr').forEach(row => {
        const rowState = (row.getAttribute('data-state') || '').toLowerCase().trim();
        row.style.display = rowState === 'active' ? '' : 'none';
      });
    });
  </script>

  <!-- Account # display toggle -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const accountDisplay = document.getElementById('accountDisplay');
      const accountLookupBtn = document.getElementById('accountLookupBtn');
      if (!accountDisplay || !accountLookupBtn) return;

      function updateAccountDisplay() {
        const val = (accountDisplay.textContent || '').trim();
        const has = !!val && val !== '‚Äî' && val !== 'N/A';
        accountDisplay.classList.toggle('hidden', !has);
        accountLookupBtn.classList.toggle('hidden', has);
      }

      // initialize after bind
      setTimeout(updateAccountDisplay, 100);
      const obs = new MutationObserver(updateAccountDisplay);
      obs.observe(accountDisplay, { childList: true, subtree: true });
    });
  </script>



  <!-- General Edit/Save/Cancel behavior -->
  <script>
    (function () {
      const STORAGE_KEY_DATA = 'adv_list_data';
      const SELECTED_ID_KEY  = 'adv_selected_id';
      const SELECTED_DATA_KEY= 'adv_selected_data';

const editableSelectors = [
  '#dspNameInput',
  '#campaignName',
  '#budgetAllocation',
  '#bidStrategy',
  '#creativeFormat',
  '#targetingRefinements',
  '#placementSettings',
  '#adServerAdGroupName',
  '#adServerPlacement'
];



      const btnEdit   = document.getElementById('editGeneralBtn');
      const btnSave   = document.getElementById('saveGeneralBtn');
      const btnCancel = document.getElementById('cancelGeneralBtn');

      let editing = false;
      let snapshot = null;
      let dirty = false;

      function qInputs() {
        return editableSelectors.map(s => document.querySelector(s)).filter(Boolean);
      }
      function getValues() {
        const map = {};
        qInputs().forEach(i => { map[i.id] = i.value ?? ''; });
        return map;
      }
      function setValues(vals) {
        qInputs().forEach(i => { if (vals.hasOwnProperty(i.id)) i.value = vals[i.id]; });
      }
      function shallowEqual(a,b){
        const ka = Object.keys(a), kb = Object.keys(b);
        if (ka.length !== kb.length) return false;
        for (const k of ka) if ((a[k] ?? '') !== (b[k] ?? '')) return false;
        return true;
      }

      function applyViewStyle(input) {
        input.readOnly = true;
        input.setAttribute('aria-readonly','true');
        input.tabIndex = -1;
        
        if (input.tagName === 'SELECT') {
          // For select elements in read-only mode
          ['border','rounded','px-3','py-2','focus:outline-none','focus:bg-white','focus:border-blue-300','bg-white','w-full','text-gray-900']
            .forEach(c => input.classList.remove(c));
          ['bg-transparent','border-0','p-0','text-gray-700','leading-tight']
            .forEach(c => input.classList.add(c));
          input.style.pointerEvents = 'none';
          input.style.appearance = 'none';
        } else {
          // For input elements
          ['border','rounded','px-3','py-2','focus:outline-none','focus:bg-white','focus:border-blue-300','bg-white','w-full','text-gray-900']
            .forEach(c => input.classList.remove(c));
          ['bg-transparent','border-0','p-0','text-gray-700','leading-tight']
            .forEach(c => input.classList.add(c));
        }
      }

      function applyEditStyle(input) {
        input.readOnly = false;
        input.removeAttribute('aria-readonly');
        input.tabIndex = 0;
        
        if (input.tagName === 'SELECT') {
          // For select elements in edit mode
          ['bg-transparent','border-0','p-0','text-gray-700','leading-tight'].forEach(c => input.classList.remove(c));
          ['bg-white','border','border-gray-300','rounded','px-3','py-2','text-gray-900','w-full','focus:outline-none','focus:bg-white','focus:border-blue-300'].forEach(c => input.classList.add(c));
          input.style.pointerEvents = '';
          input.style.appearance = '';
        } else {
          // For input elements
          ['bg-transparent','border-0','p-0','text-gray-700','leading-tight'].forEach(c => input.classList.remove(c));
          ['bg-white','border','border-gray-300','rounded','px-3','py-2','text-gray-900','w-full','focus:outline-none','focus:bg-white','focus:border-blue-300'].forEach(c => input.classList.add(c));
        }
      }

      function setMode(isEditing) {
        editing = isEditing;
        const inputs = qInputs();
        inputs.forEach(i => isEditing ? applyEditStyle(i) : applyViewStyle(i));
        btnEdit?.classList.toggle('hidden', isEditing);
        btnSave?.classList.toggle('hidden', !isEditing);
        btnCancel?.classList.toggle('hidden', !isEditing);

        if (isEditing) {
          snapshot = getValues();
          dirty = false;
          inputs.forEach(i => i.addEventListener('input', onDirty));
          inputs.forEach(i => i.addEventListener('change', onDirty)); // For select elements
          inputs[0]?.focus();
        } else {
          snapshot = null;
          dirty = false;
          inputs.forEach(i => i.removeEventListener('input', onDirty));
          inputs.forEach(i => i.removeEventListener('change', onDirty));
        }
      }

      function onDirty() {
        if (!editing || !snapshot) return;
        dirty = !shallowEqual(snapshot, getValues());
      }

      function saveAll() {
        const selectedId = localStorage.getItem(SELECTED_ID_KEY);
        if (!selectedId) {
          showToast({ message: 'No advertiser selected.', type: 'error' });
          return false;
        }
        try {
          const vals = getValues();
          const advertisers = JSON.parse(localStorage.getItem(STORAGE_KEY_DATA) || '[]');
          const idx = advertisers.findIndex(a => String(a.id) === String(selectedId));
          if (idx === -1) {
            showToast({ message: 'Advertiser not found in storage.', type: 'error' });
            return false;
          }

          // Map inputs ‚Üí adv fields
         // advertisers[idx].name    = vals.companyName?.trim() || '';
          advertisers[idx].state   = vals.advertiserState?.trim() || '';   // ‚úì use state field
          advertisers[idx].website = vals.advertiserWebsite?.trim() || '';

          localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(advertisers));
          localStorage.setItem(SELECTED_DATA_KEY, JSON.stringify(advertisers[idx]));

          // Rebind view
          if (typeof window.bindAll === 'function') {
            bindAll('adv.name', advertisers[idx].name, 'No advertiser found');
            bindAll('adv.state', advertisers[idx].state, 'N/A');
            bindAll('adv.website', advertisers[idx].website, 'N/A');
          }

          return true;
        } catch (e) {
          console.error(e);
          showToast({ message: 'Save failed. Check console.', type: 'error' });
          return false;
        }
      }

      function beforeUnloadHandler(e){
        if (dirty) {
          e.preventDefault();
          e.returnValue = '';
          return '';
        }
      }
      function navGuard(e){
        if (!dirty) return;
        const a = e.target.closest('a,button,[role="link"]');
        if (!a) return;
        if (a === btnSave || a === btnCancel || a === btnEdit) return;
        e.preventDefault();
        e.stopPropagation();
        const wantsSave = confirm('You have unsaved changes. Save now?\n\nOK = Save  |  Cancel = Discard');
        if (wantsSave) {
          const ok = saveAll();
          if (ok) {
            dirty = false;
            window.removeEventListener('beforeunload', beforeUnloadHandler);
            document.removeEventListener('click', navGuard, true);
            showToast({ message: 'Saved successfully.', type: 'success' });
            if (a.tagName === 'A' && a.href) window.location.href = a.href; else a.click?.();
          }
        } else {
          setValues(snapshot || {});
          dirty = false;
          window.removeEventListener('beforeunload', beforeUnloadHandler);
          document.removeEventListener('click', navGuard, true);
          if (a.tagName === 'A' && a.href) window.location.href = a.href; else a.click?.();
        }
      }

      // Simple toast function for compatibility
      function showToast(options) {
        const message = typeof options === 'string' ? options : options.message;
        const type = options.type || 'info';
        
        if (window.toast && typeof window.toast.success === 'function') {
          if (type === 'success') window.toast.success(message);
          else if (type === 'error') window.toast.error(message);
          else if (type === 'warning') window.toast.warning(message);
          else window.toast.info(message);
        } else {
          console.log('TOAST:', type.toUpperCase(), message);
        }
      }

      btnEdit?.addEventListener('click', () => {
        setMode(true);
        window.addEventListener('beforeunload', beforeUnloadHandler);
        document.addEventListener('click', navGuard, true);
      });
      btnCancel?.addEventListener('click', () => {
        if (snapshot) setValues(snapshot);
        dirty = false;
        window.removeEventListener('beforeunload', beforeUnloadHandler);
        document.removeEventListener('click', navGuard, true);
        setMode(false);
      });
      btnSave?.addEventListener('click', () => {
        if (!dirty) {
          showToast({ message: 'No changes to save.', type: 'warning' });
          setMode(false);
          window.removeEventListener('beforeunload', beforeUnloadHandler);
          document.removeEventListener('click', navGuard, true);
          return;
        }
        const ok = saveAll();
        if (ok) {
          dirty = false;
          window.removeEventListener('beforeunload', beforeUnloadHandler);
          document.removeEventListener('click', navGuard, true);
          setMode(false);
          showToast({ message: 'Data saved successfully.', type: 'success' });
        }
      });

      // Initialize to view mode
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => { qInputs().forEach(applyViewStyle); }, 50);
      });
    })();
  </script>

  <!-- Account Lookup Modal -->
  <div id="accountLookupModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-60">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[80vh] overflow-auto">
      <div class="flex items-center justify-between p-4 border-b border-gray-200">
        <h2 class="text-lg font-semibold text-gray-900">Account Lookup</h2>
        <button type="button" id="closeLookupX" class="text-gray-400 hover:text-gray-600 transition-colors" title="Close">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <div class="p-4">
        <div class="mb-4">
          <input type="text" id="lookupSearch" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Search by account number or name...">
        </div>
        
        <div class="max-h-96 overflow-y-auto">
          <table class="w-full text-sm">
            <thead class="bg-gray-50 sticky top-0">
              <tr>
                <th class="text-left py-2 px-4 font-medium text-gray-700">Account #</th>
                <th class="text-left py-2 px-4 font-medium text-gray-700">Account Name</th>
              </tr>
            </thead>
            <tbody id="lookupResults" class="divide-y divide-gray-200">
              <!-- Results populated by JS -->
            </tbody>
          </table>
        </div>
      </div>

      <div class="flex items-center justify-end space-x-3 p-4 border-t border-gray-200">
        <button type="button" id="cancelLookupBtn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
        <button type="button" id="selectAccountBtn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 disabled:opacity-50" disabled>Select</button>
      </div>
    </div>
  </div>

  <!-- Account Lookup Logic -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // Sample CRM accounts (same as other pages)
    const SAMPLE_CRM_ACCOUNTS = [
      { accountNumber: '12345', accountName: 'Acme Corporation' },
      { accountNumber: '67890', accountName: 'Global Tech Solutions' },
      { accountNumber: '11111', accountName: 'Sunrise Marketing' },
      { accountNumber: '22222', accountName: 'Metro Retail Group' },
      { accountNumber: '33333', accountName: 'Advanced Systems Inc' }
    ];

    const accountLookupBtn = document.getElementById('accountLookupBtn');
    const accountLookupModal = document.getElementById('accountLookupModal');
    const closeLookupX = document.getElementById('closeLookupX');
    const cancelLookupBtn = document.getElementById('cancelLookupBtn');
    const lookupSearch = document.getElementById('lookupSearch');
    const lookupResults = document.getElementById('lookupResults');
    const selectAccountBtn = document.getElementById('selectAccountBtn');

    if (!accountLookupBtn || !accountLookupModal) return;

    function closeLookupModal() {
      accountLookupModal.classList.add('hidden');
      document.body.style.overflow = 'auto';
      if (lookupSearch) lookupSearch.value = '';
      if (selectAccountBtn) selectAccountBtn.disabled = true;
    }

    function renderResults(accounts) {
      if (!lookupResults) return;
      lookupResults.innerHTML = '';
      
      accounts.forEach(account => {
        const tr = document.createElement('tr');
        tr.className = 'cursor-pointer hover:bg-gray-50';
        tr.dataset.accountNumber = account.accountNumber;
        tr.dataset.accountName = account.accountName;
        tr.innerHTML = `
          <td class="py-2 px-4">${account.accountNumber}</td>
          <td class="py-2 px-4">${account.accountName}</td>
        `;
        
        tr.addEventListener('click', function() {
          const prev = lookupResults.querySelector('tr.selected');
          if (prev) prev.classList.remove('bg-blue-50', 'selected');
          tr.classList.add('bg-blue-50', 'selected');
          if (selectAccountBtn) selectAccountBtn.disabled = false;
        });
        
        lookupResults.appendChild(tr);
      });
    }

    // Open modal
    accountLookupBtn.addEventListener('click', (e) => {
      e.preventDefault();
      accountLookupModal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      renderResults(SAMPLE_CRM_ACCOUNTS);
      if (lookupSearch) lookupSearch.focus();
    });

    // Close modal handlers
    if (closeLookupX) closeLookupX.addEventListener('click', closeLookupModal);
    if (cancelLookupBtn) cancelLookupBtn.addEventListener('click', closeLookupModal);

    // Search functionality
    if (lookupSearch) {
      lookupSearch.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        const filtered = SAMPLE_CRM_ACCOUNTS.filter(account => 
          account.accountNumber.toLowerCase().includes(query) ||
          account.accountName.toLowerCase().includes(query)
        );
        renderResults(filtered);
      });
    }

    // Select account
    if (selectAccountBtn) {
      selectAccountBtn.addEventListener('click', function() {
        const selected = lookupResults ? lookupResults.querySelector('tr.selected') : null;
        if (!selected) return;

        const accountNumber = selected.dataset.accountNumber;
        const accountName = selected.dataset.accountName;

        // Update the display
        const accountDisplay = document.getElementById('accountDisplay');
        if (accountDisplay) {
          accountDisplay.textContent = accountNumber;
          accountDisplay.classList.remove('hidden');
        }
        
        if (accountLookupBtn) {
          accountLookupBtn.classList.add('hidden');
        }

        // Update the data in localStorage
        try {
          const selectedId = localStorage.getItem('adv_selected_id');
          if (selectedId) {
            const advertisers = JSON.parse(localStorage.getItem('adv_list_data') || '[]');
            const advIndex = advertisers.findIndex(a => String(a.id) === String(selectedId));
            
            if (advIndex !== -1) {
              advertisers[advIndex].account = accountNumber;
              localStorage.setItem('adv_list_data', JSON.stringify(advertisers));
              localStorage.setItem('adv_selected_data', JSON.stringify(advertisers[advIndex]));
              
              // Update data binding if available
              if (typeof window.bindAll === 'function') {
                window.bindAll('adv.account', accountNumber, 'N/A');
              }
            }
          }
        } catch (e) {
          console.error('Error updating account in storage:', e);
        }

        closeLookupModal();
        
        // Show success toast if available
        if (window.toast && typeof window.toast.success === 'function') {
          window.toast.success('Account updated successfully');
        }
      });
    }

    // Close on outside click
    accountLookupModal.addEventListener('click', function(e) {
      if (e.target === accountLookupModal) {
        closeLookupModal();
      }
    });

    // Close on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && !accountLookupModal.classList.contains('hidden')) {
        closeLookupModal();
      }
    });
  });



  document.addEventListener('DOMContentLoaded', () => {
    document.body.style.zoom = '100%';
  });


  document.addEventListener('DOMContentLoaded', () => {
    const current = window.location.pathname.split('/').pop();
    document.querySelectorAll('#sidebar a[data-nav-link]').forEach(link => {
      if (link.getAttribute('href') === current) {
        link.classList.add('text-blue-700', 'bg-blue-50', 'font-medium');
      } else {
        link.classList.remove('text-blue-700', 'bg-blue-50', 'font-medium');
      }
    });
  });


  document.addEventListener('DOMContentLoaded', () => {
    const campaignsLink = document.querySelector('#sidebar a[href="./AdvertiserCampaigns.html"]');
    if (campaignsLink) {
      campaignsLink.classList.add('text-blue-700', 'bg-blue-50', 'font-medium');
    }
  });

document.addEventListener('DOMContentLoaded', () => {
  const current = window.location.pathname.split('/').pop();
  document.querySelectorAll('#sidebar a[data-nav-link]').forEach(link => {
    if (link.getAttribute('href') === current) {
      link.classList.add('text-blue-700', 'bg-blue-50', 'font-medium');
    } else {
      link.classList.remove('text-blue-700', 'bg-blue-50', 'font-medium');
    }
  });
});



  document.addEventListener('DOMContentLoaded', () => {
    const params = new URLSearchParams(window.location.search);
    const adGroupName = params.get('name');
    if (adGroupName) {
      document.getElementById('adGroupName').textContent = decodeURIComponent(adGroupName);
    }
  });

document.addEventListener('DOMContentLoaded', function () {
  // Populate campaign dropdown
  function populateCampaignDropdown() {
    const campaignSelect = document.getElementById('commonCampaign');
    if (!campaignSelect) return;

    // Clear existing options (except the default one)
    while (campaignSelect.children.length > 1) {
      campaignSelect.removeChild(campaignSelect.lastChild);
    }

    const stored = localStorage.getItem('campaign_tree_groups');
    let data = stored ? JSON.parse(stored) : { campaigns: [], groups: [] };
    
    // Handle both old and new data structures
    if (Array.isArray(data)) {
      // Old structure - convert to new
      data = { campaigns: [], groups: data };
    }
    
    // Ensure data structure has both arrays
    if (!data.campaigns) data.campaigns = [];
    if (!data.groups) data.groups = [];

    // Add individual campaigns first
    data.campaigns.forEach(campaign => {
      const opt = document.createElement('option');
      opt.value = campaign.id;
      opt.textContent = campaign.beaconCampaignName || campaign.name || campaign.id;
      campaignSelect.appendChild(opt);
    });

    // Add campaigns from groups
    data.groups.forEach(group => {
      group.campaigns.forEach(campaign => {
        const opt = document.createElement('option');
        opt.value = campaign.id;
        opt.textContent = campaign.beaconCampaignName || campaign.name || campaign.id;
        campaignSelect.appendChild(opt);
      });
    });
  }

  // Call the function to populate campaigns
  populateCampaignDropdown();

  const params = new URLSearchParams(window.location.search);
  const id = params.get('id');
  const campaignId = params.get('campaignId');
  const campaignName = params.get('campaignName');

  if (!id) return;

  const adgroups = JSON.parse(localStorage.getItem('adgroups_data_v1') || '[]');
  const adGroup = adgroups.find(ag => ag.id === id);

  if (!adGroup) {
    console.warn('Ad group not found');
    return;
  }

  // Update the page title with ad group name
  const titleElement = document.getElementById('adGroupDetailsTitle');
  if (titleElement && adGroup.name) {
    titleElement.innerHTML = `<span style="color: #0F66A7;">${adGroup.name}</span>: Ad Group Details`;
  }

  // Populate breadcrumbs
  try {
    const selectedData = localStorage.getItem('adv_selected_data');
    const breadcrumbAdvertiser = document.getElementById('breadcrumbAdvertiser');
    const breadcrumbMiddle = document.getElementById('breadcrumbMiddle');
    const breadcrumbAdGroup = document.getElementById('breadcrumbAdGroup');
    
    if (selectedData) {
      const advertiser = JSON.parse(selectedData);
      
      // Update breadcrumb advertiser name and link
      if (breadcrumbAdvertiser) {
        breadcrumbAdvertiser.textContent = `Advertiser: ${advertiser.name || 'Unknown'}`;
        breadcrumbAdvertiser.href = `./WFAdvertiserDetails.html?advertiserId=${advertiser.id}`;
      }
      
      // Always try to find the campaign associated with this ad group
      let relatedCampaignId = campaignId || adGroup.campaign || adGroup.campaignId;
      let relatedCampaignName = campaignName;
      
      // If we have a campaign ID but no name, look it up
      if (relatedCampaignId && !relatedCampaignName) {
        try {
          const campaignData = JSON.parse(localStorage.getItem('campaign_tree_groups') || '{}');
          let campaigns = [];
          
          if (Array.isArray(campaignData)) {
            campaignData.forEach(group => {
              if (group.campaigns) campaigns = campaigns.concat(group.campaigns);
            });
          } else {
            campaigns = Array.isArray(campaignData.campaigns) ? campaignData.campaigns : [];
            if (Array.isArray(campaignData.groups)) {
              campaignData.groups.forEach(group => {
                if (group.campaigns) campaigns = campaigns.concat(group.campaigns);
              });
            }
          }
          
          const campaign = campaigns.find(c => c.id === relatedCampaignId);
          if (campaign) {
            relatedCampaignName = campaign.beaconCampaignName || campaign.name;
          }
        } catch (e) {
          console.warn('Failed to lookup campaign name:', e);
        }
      }
      
      // Build breadcrumb middle section
      if (breadcrumbMiddle) {
        if (relatedCampaignId && relatedCampaignName) {
          // Path: Advertisers > Advertiser > Campaigns > Campaign > Ad Group
          breadcrumbMiddle.innerHTML = `
            <a href="./AdvertiserCampaigns.html?advertiserId=${advertiser.id}" class="hover:text-blue-600 transition-colors">Campaigns</a>
            <svg class="w-4 h-4 mx-2 text-gray-400 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
            <a href="./CampaignDetails.html?campaignId=${relatedCampaignId}&campaignName=${encodeURIComponent(relatedCampaignName)}" class="hover:text-blue-600 transition-colors">Campaign: ${relatedCampaignName}</a>
            <svg class="w-4 h-4 mx-2 text-gray-400 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
            <a href="./AdvertiserAdGroup.html?advertiserId=${advertiser.id}" class="hover:text-blue-600 transition-colors">Ad Groups</a>
          `;
        } else {
          // Path: Advertisers > Advertiser > Ad Groups > Ad Group (no campaign association)
          breadcrumbMiddle.innerHTML = `
            <a href="./AdvertiserAdGroup.html?advertiserId=${advertiser.id}" class="hover:text-blue-600 transition-colors">Ad Groups</a>
          `;
        }
      }
    }
    
    // Update breadcrumb ad group name
    if (breadcrumbAdGroup && adGroup.name) {
      breadcrumbAdGroup.textContent = `Ad Group: ${adGroup.name}`;
    }
  } catch (e) {
    console.warn('Failed to populate breadcrumbs:', e);
  }

  const fields = [
    { dataBindKey: 'adGroupName', adGroupProperty: 'name' },
    { dataBindKey: 'campaign', adGroupProperty: 'campaign' },
    { dataBindKey: 'budget', adGroupProperty: 'budget' },
    { dataBindKey: 'bidStrategy', adGroupProperty: 'bidStrategy' },
    { dataBindKey: 'creativeFormat', adGroupProperty: 'creativeFormat' },
    { dataBindKey: 'targetingRefinements', adGroupProperty: 'targetingRefinements' },
    { dataBindKey: 'placementSettings', adGroupProperty: 'placementSettings' },
    { dataBindKey: 'adServerAdGroupName', adGroupProperty: 'adServerAdGroupName' },
    { dataBindKey: 'adServerPlacement', adGroupProperty: 'adServerPlacement' }
  ];

  // Helper function to safely set text content and input values
  function safeSet(elementId, value) {
    const element = document.getElementById(elementId);
    if (element) {
      element.textContent = value || 'N/A';
    }
  }
  
  function safeInput(elementId, value) {
    const element = document.getElementById(elementId);
    if (element) {
      element.value = value || '';
    }
  }

  // Bind to data-bind attributes for backwards compatibility
  fields.forEach(field => {
    const el = document.querySelector(`[data-bind="${field.dataBindKey}"]`);
    if (el) el.value = adGroup[field.adGroupProperty] || '';
  });
  
  // Populate the display spans for the new two-column layout
  // Beacon Fields section
  safeSet('displayAdGroupId', adGroup.id);
  safeSet('displayAdGroupName', adGroup.name);
  safeSet('displayCampaign', adGroup.campaign);
  safeSet('displayMultiviewClassification', adGroup.multiviewClassification);
  safeSet('displayMultiviewTactic', adGroup.multiviewTactic);
  safeSet('displayBeaconAudience', adGroup.beaconAudience);
  
  // DSP Fields section
  safeSet('displayDspName', adGroup.dspName);
  safeSet('displayCampaignName', adGroup.campaign);
  safeSet('displayFunnelLocation', adGroup.funnelLocation);
  safeSet('displayChannel', adGroup.channel);
  safeSet('displayDeviceTypes', adGroup.deviceTypes);
  safeSet('displayAdEnvironments', adGroup.adEnvironments);
  safeSet('displayPrimaryGoal', adGroup.primaryGoal);
  safeSet('displayTarget', adGroup.target);
  safeSet('displayDspAudience', adGroup.dspAudience);
  safeSet('displayFrequency', adGroup.frequency);
  safeSet('displayGeos', adGroup.geos);
  safeSet('displayBaseBid', adGroup.baseBid);
  safeSet('displayMaxBid', adGroup.maxBid);
  
  // Ad Server Fields section
  safeSet('displayAdServerName', adGroup.adServerName);
  safeSet('displayAdServerStatus', adGroup.adServerStatus);
  safeSet('displayAdServerCompatibility', adGroup.adServerCompatibility);
  safeSet('displayAdServerDimensions', adGroup.adServerDimensions);
  safeSet('displayAdServerTestingStarts', adGroup.adServerTestingStarts);
  safeSet('displayAdServerStartDate', adGroup.adServerStartDate);
  safeSet('displayAdServerEndDate', adGroup.adServerEndDate);
  safeSet('displayAdServerCostStructure', adGroup.adServerCostStructure);
  safeSet('displayAdServerCapCost', adGroup.adServerCapCost);
  
  // Set input values for editing
  // Beacon Fields (ID is read-only, no input needed)
  safeInput('inputAdGroupName', adGroup.name);
  
  // Populate inputCampaign dropdown before setting value
  const inputCampaignSelect = document.getElementById('inputCampaign');
  if (inputCampaignSelect) {
    // Clear existing options except the first one
    while (inputCampaignSelect.children.length > 1) {
      inputCampaignSelect.removeChild(inputCampaignSelect.lastChild);
    }
    
    const stored = localStorage.getItem('campaign_tree_groups');
    let data = stored ? JSON.parse(stored) : { campaigns: [], groups: [] };
    
    // Handle both old and new data structures
    if (Array.isArray(data)) {
      data = { campaigns: [], groups: data };
    }
    
    if (!data.campaigns) data.campaigns = [];
    if (!data.groups) data.groups = [];

    // Add individual campaigns
    data.campaigns.forEach(campaign => {
      const opt = document.createElement('option');
      opt.value = campaign.id;
      opt.textContent = campaign.beaconCampaignName || campaign.name || campaign.id;
      inputCampaignSelect.appendChild(opt);
    });

    // Add campaigns from groups
    data.groups.forEach(group => {
      if (group.campaigns) {
        group.campaigns.forEach(campaign => {
          const opt = document.createElement('option');
          opt.value = campaign.id;
          opt.textContent = campaign.beaconCampaignName || campaign.name || campaign.id;
          inputCampaignSelect.appendChild(opt);
        });
      }
    });
  }
  
  safeInput('inputCampaign', adGroup.campaign);
  safeInput('inputMultiviewClassification', adGroup.multiviewClassification);
  safeInput('inputMultiviewTactic', adGroup.multiviewTactic);
  safeInput('inputBeaconAudience', adGroup.beaconAudience);
  
  // DSP Field inputs
  safeInput('adGroupNameInput', adGroup.dspName);
  safeInput('funnelLocationInput', adGroup.funnelLocation);
  safeInput('channelInput', adGroup.channel);
  safeInput('deviceTypesInput', adGroup.deviceTypes);
  safeInput('adEnvironmentsInput', adGroup.adEnvironments);
  safeInput('primaryGoalInput', adGroup.primaryGoal);
  safeInput('targetInput', adGroup.target);
  safeInput('inputDspAudience', adGroup.dspAudience);
  safeInput('frequencyInput', adGroup.frequency);
  safeInput('geosInput', adGroup.geos);
  safeInput('baseBidInput', adGroup.baseBid);
  safeInput('maxBidInput', adGroup.maxBid);
  
  // Ad Server Field inputs
  safeInput('adServerNameInput', adGroup.adServerName);
  safeInput('adServerStatusInput', adGroup.adServerStatus);
  safeInput('adServerCompatibilityInput', adGroup.adServerCompatibility);
  safeInput('adServerDimensionsInput', adGroup.adServerDimensions);
  safeInput('adServerTestingStartsInput', adGroup.adServerTestingStarts);
  safeInput('adServerStartDateInput', adGroup.adServerStartDate);
  safeInput('adServerEndDateInput', adGroup.adServerEndDate);
  safeInput('adServerCostStructureInput', adGroup.adServerCostStructure);
  safeInput('adServerCapCostInput', adGroup.adServerCapCost);
  });





  
  </script>
  <script src="./assets/sidebar.js" defer></script>
  <script src="./assets/audit.js" defer></script></body>
</html>