<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Beacon - Campaigns</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="./assets/toast.css">
  <script src="./assets/campaignConfig.js" defer></script>
  <script src="./assets/notifications.js"></script>
  <script src="./assets/toast.js" defer></script>
  <script src="./assets/sidebar.js" defer></script>
  <link rel="stylesheet" href="./assets/theme.css">
  <link rel="stylesheet" href="./assets/loading.css">
  <script src="./assets/loading.js" defer></script>
  <style>
    body { font-family: 'apple-system', 'Segoe UI', 'Roboto', 'Inter', sans-serif; }

    /* Search component styles */
    .search-container {
      position: relative;
      display: flex;
      align-items: center;
    }

    .search-wrapper {
      position: relative;
      display: flex;
      align-items: center;
      border-radius: 0.375rem;
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      height: 40px;
      width: 50px;
      overflow: hidden;
    }

    .search-wrapper.expanded {
      width: 300px;
    }

    .search-icon {
      position: absolute;
      left: 5px;
      width: 40px;
      height: 40px;
      cursor: pointer;
      z-index: 2;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.2s ease;
    }

    .search-icon svg {
      width: 20px;
      height: 20px;
      fill: #666;
    }

    .search-input {
      width: 100%;
      height: 100%;
      border: none;
      outline: none;
      background: transparent;
      padding: 8px 40px 8px 40px;
      font-size: 14px;
      color: #333;
      opacity: 0;
      transition: opacity 0.2s ease 0.1s;
    }

    .search-input::placeholder {
      color: #999;
    }

    .search-wrapper.expanded .search-input {
      opacity: 1;
      background-color: white;
      height: 80%;
      border: #c5c4c4 1px solid;
      border-radius: .375rem;
    }

    .clear-button {
      position: absolute;
      right: 10px;
      width: 20px;
      height: 20px;
      cursor: pointer;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      z-index: 2;
    }

    .clear-button svg {
      width: 100%;
      height: 100%;
      fill: #666;
    }

    .clear-button:hover svg {
      fill: #333;
    }

    .clear-button.visible {
      opacity: 1;
      visibility: visible;
    }
  </style>

<script src="./assets/audit.js" defer></script>


</head>

<body class="font-inter"><!-- removed bg-gray-100 -->
  <div class="flex h-screen flex-col">
    <!-- Header -->
    <header class="border-b border-strong shadow-sm app-header">
      <div class="flex items-center justify-between px-4 py-2">
        <div class="flex items-center gap-3">
          <img src="./assets/BeaconLogo.png" alt="Beacon Logo" class="h-9 w-auto" />
        </div>

        <nav class="flex items-center gap-3 ml-auto">
            <a href="./index.html" class="text-base text-white hover:text-blue-100" style="font-size: 1.5rem; padding-right: 15px;" onmouseover="this.style.color='#48A9FE'" onmouseout="this.style.color='white'">
            Advertisers
            </a>
          <span class="text-white select-none">|</span>

          <!-- Notifications -->
          <div class="relative">
            <button id="notificationButton" class="p-2 rounded-md  text-white relative" title="Notifications" aria-label="View notifications" onmouseover="this.style.backgroundColor=''" onmouseout="this.style.backgroundColor=''" >
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
              </svg>
              <span id="notificationDot" class="absolute top-2 right-2 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></span>
            </button>

            <!-- Dropdown -->
            <div id="notificationDropdown" class="hidden absolute right-0 mt-2 w-80 bg-white border border-gray-200 rounded-md shadow-lg z-50 max-h-96 overflow-hidden">
              <div class="p-3 border-b border-gray-200 bg-gray-50">
                <div class="flex items-center justify-between">
                  <h3 class="text-sm font-semibold text-gray-900">Notifications</h3>
                  <button id="markAllReadBtn" class="text-xs text-blue-600 hover:text-blue-800">Mark all read</button>
                </div>
              </div>

              <div class="max-h-80 overflow-y-auto">
                <div id="notificationList">
                  <!-- Sample items -->
                  <div class="p-3 border-b border-gray-100 hover:bg-gray-50 cursor-pointer notification-item" data-read="false">
                    <div class="flex items-start gap-3">
                      <div class="flex-shrink-0 w-2 h-2 bg-blue-500 rounded-full mt-2"></div>
                      <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900">Campaign Performance Alert</p>
                        <p class="text-xs text-gray-500 mt-1">"Summer Sale" exceeded budget by 15%</p>
                        <p class="text-xs text-gray-400 mt-1">2 minutes ago</p>
                      </div>
                    </div>
                  </div>

                  <div class="p-3 border-b border-gray-100 hover:bg-gray-50 cursor-pointer notification-item" data-read="false">
                    <div class="flex items-start gap-3">
                      <div class="flex-shrink-0 w-2 h-2 bg-green-500 rounded-full mt-2"></div>
                      <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900">New Advertiser Added</p>
                        <p class="text-xs text-gray-500 mt-1">Stallion Services LLC onboarded</p>
                        <p class="text-xs text-gray-400 mt-1">1 hour ago</p>
                      </div>
                    </div>
                  </div>

                  <div class="p-3 border-b border-gray-100 hover:bg-gray-50 cursor-pointer notification-item" data-read="true">
                    <div class="flex items-start gap-3">
                      <div class="flex-shrink-0 w-2 h-2 bg-gray-300 rounded-full mt-2"></div>
                      <div class="flex-1 min-w-0">
                        <p class="text-sm text-gray-700">Account Sync Complete</p>
                        <p class="text-xs text-gray-500 mt-1">CRM sync finished for 12 accounts</p>
                        <p class="text-xs text-gray-400 mt-1">3 hours ago</p>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="p-3 text-center border-t border-gray-200">
                  <a href="#" class="text-sm text-blue-600 hover:text-blue-800 font-medium">View all notifications</a>
                </div>
              </div>
            </div>
          </div>

          <!-- Waffle Menu -->
          <div class="relative">
            <button class="p-0 rounded-md text-white" id="menuButton" title="Menu" aria-label="Open navigation menu">
              <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                <path d="M4 4h3v3H4V4zM8.5 4h3v3h-3V4zM13 4h3v3h-3V4zM4 8.5h3v3H4v-3zM8.5 8.5h3v3h-3V8.5zM13 8.5h3v3h-3V8.5zM4 13h3v3H4v-3zM8.5 13h3v3h-3V13zM13 13h3v3h-3V13z"></path>
              </svg>
            </button>
            <div id="menuDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-md shadow-lg">
              <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Advertisers</a>
              <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Profile</a>
              <a href="#" id="menuAdmin" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Admin</a>
              <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Sign Out</a>
            </div>
          </div>
        </nav>
      </div>
    </header>

    <!-- Body -->
    <div class="flex flex-1 overflow-hidden">
      <!-- Sidebar -->
      <nav id="sidebar" class="bg-white w-64 p-4 border-r border-gray-200 overflow-y-auto transition-all duration-200 ease-in-out">
        <div class="flex items-center justify-between pb-4 border-b border-gray-200">
          <div class="flex items-center gap-3">
            <img src="./assets/advertiser.png" alt="Advertiser" class="w-9 h-9 rounded-full" data-sidebar-avatar />
            <h2 data-sidebar-header class="text-base text-lg font-semibold text-gray-800">Advertiser</h2>
          </div>
          <button id="sidebarToggle" class="p-1 rounded hover:bg-gray-100" aria-label="Toggle sidebar" aria-expanded="true" title="Collapse/Expand">
            <!-- Shown when expanded (collapse icon) -->
            <svg id="iconCollapse" class="w-5 h-5 text-gray-900" viewBox="0 0 26 26" fill="currentColor">
              <path fill="#000000" d="M21.5 11.5h-8.793l3.035-3.035a.5.5 0 10-.707-.707l-3.888 3.888a.518.518 0 00-.109.163.505.505 0 000 .382.518.518 0 00.109.163l3.888 3.888a.5.5 0 00.707-.707L12.707 12.5H21.5a.5.5 0 000-1zM7.5 2h-5a.5.5 0 000 1h5a.5.5 0 000-1zM7.5 7h-5a.5.5 0 000 1h5a.5.5 0 000-1zM7.5 11.5h-5a.5.5 0 000 1h5a.5.5 0 000-1zM7.5 16h-5a.5.5 0 000 1h5a.5.5 0 000-1zM7.5 21h-5a.5.5 0 000 1h5a.5.5 0 000-1z">
	            </path>
            </svg>
            <!-- Shown when collapsed (expand icon) -->
            <svg id="iconExpand" class="w-5 h-5 text-gray-900 hidden" viewBox="0 0 26 26" fill="currentColor">
              <path fill="#000000" d="M21.962 12.191a.505.505 0 000-.382.518.518 0 00-.109-.163l-3.888-3.888a.5.5 0 10-.707.707l3.035 3.035H11.5a.5.5 0 000 1h8.793l-3.035 3.035a.5.5 0 10.707.707l3.888-3.888a.518.518 0 00.109-.163zM7.5 2h-5a.5.5 0 000 1h5a.5.5 0 000-1zM7.5 7h-5a.5.5 0 000 1h5a.5.5 0 000-1zM7.5 11.5h-5a.5.5 0 000 1h5a.5.5 0 000-1zM7.5 16h-5a.5.5 0 000 1h5a.5.5 0 000-1zM7.5 21h-5a.5.5 0 000 1h5a.5.5 0 000-1z">
	            </path>
            </svg>
          </button>
        </div>

        <ul class="space-y-1 mt-4">
          <li>
            <a href="./WFAdvertiserDetails.html" data-nav-link
               class="flex items-center px-1 py-2 text-sm text-gray-700 hover:bg-blue-50 rounded-md">
              <img src="./assets/svgs/Details.svg" alt="Details" class="w-6 h-6 mr-2" />
              <span data-link-label>Details</span>
            </a>
          </li>
          <li>
            <a href="./AdvertiserSalesOrder.html" data-nav-link
               class="flex items-center px-1 py-2 text-sm text-gray-700 hover:bg-blue-50 rounded-md">
              <img src="./assets/svgs/SalesOrderExpense.svg" alt="Sales Orders" class="w-6 h-6 mr-2" />
              <span data-link-label>Sales Orders</span>
            </a>
          </li>
          <li>
            <a href="./WFAdvertiserConnections.html" data-nav-link
               class="flex items-center px-1 py-2 text-sm text-gray-700 hover:bg-blue-50 rounded-md">
              <img src="./assets/svgs/Blueprint.svg" alt="Connections" class="w-6 h-6 mr-2" />
              <span data-link-label>Connections (P2)</span>
            </a>
          </li>
          <li>
            <a href="./AdvertiserCampaigns.html" data-nav-link
               class="flex items-center px-1 py-2 text-sm font-medium text-blue-700 bg-blue-50 rounded-md">
              <img src="./assets/svgs/CampaignsSchedules.svg" alt="Campaigns" class="w-6 h-6 mr-2" />
              <span data-link-label>Campaigns</span>
            </a>
          </li>
          <li>
            <a href="./AdvertiserAdGroup.html" data-nav-link class="flex items-center px-1 py-2 text-sm text-gray-700 hover:bg-blue-50 rounded-md">
              <img src="./assets/svgs/AdGroups.svg" class="w-6 h-6 mr-2" alt="">
              <span data-link-label>Ad Groups</span>
            </a>
          </li>
          <!-- CAD (added) -->
          <li>
            <a href="./CAD.html" data-nav-link class="flex items-center px-1 py-2 text-sm text-gray-700 hover:bg-blue-50 rounded-md">
              <img src="./assets/svgs/Blueprint.svg" class="w-6 h-6 mr-2" alt="CAD">
              <span data-link-label>CAD</span>
            </a>
          </li>
        </ul>
      </nav>

      <!-- Main Content -->
      <main class="flex-1 overflow-y-auto p-6">
       <div class="app-card rounded-lg shadow-lg overflow-hidden">
          <!-- Advertiser Header -->
          <div class="px-4 pt-4">
            <div class="flex items-start gap-4 mb-3">
              <div class="flex-1">
                <h1 data-bind="adv.name" class="text-xl md:text-2xl font-semibold text-gray-900">Loading…</h1>
                <div class="flex justify-between items-center">
                  <h3 class="text-sm font-semibold text-gray-600">Account #: <span data-bind="adv.account" class="text-sm text-gray-500">—</span></h3>
                  <h3 class="text-sm font-semibold text-gray-600">ID: <span data-bind="adv.id" class="text-sm text-gray-500">—</span></h3>
                </div>
              </div>
            </div>
            <hr class="app-divider mp-4"><!-- use themed divider -->
          </div>

          <!-- Page Header-->
          <div class="px-4 pt-5">
            <section class="space-y-2">
              <div class="flex items-center justify-between">
                <h1 class="text-2xl font-semibold text-gray-900 mx-2">CAMPAIGNS</h1>
              </div>
            </section>
          </div>

          <!-- Toolbar -->
          <div class="px-6 py-3">
            <div class="mb-4">
              <div class="flex items-center space-x-3 bg-[var(--tbl-head-bg)] border border-gray-300 rounded-md">
                <!-- New Campaign Button -->
                <button id="createBtn" class="flex items-center h-10 px-3 rounded-md hover:bg-gray-50 transition" title="Create New Campaign">
                  <span class="w-6 h-6 flex items-center justify-center rounded-full bg-white border border-gray-400 mr-2">
                  <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                  </svg>
                  </span>
                  <span class="text-sm font-medium text-gray-700">New Campaign</span>
                </button>

                <div class="h-6 border-l border-gray-400 mx-1"></div>
                
                <button id="manageCampaignGroupBtn" class="flex items-center h-10 px-3 rounded-md hover:bg-gray-50 transition" title="Manage Campaign Group">
                  <span class="w-6 h-6 flex items-center justify-center rounded-full bg-white border border-gray-400 mr-2">
                    <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2v0z"></path>
                    </svg>
                  </span>
                  <span class="text-sm font-medium text-gray-700">Manage Campaign Group</span>
                </button>

                <div class="h-6 border-l border-gray-400 mx-1"></div>

                <!-- Filters -->
                <div id="filtersGroup" class="flex items-center space-x-2">
                  <div class="flex items-center px-2 h-10 rounded-md">
                    <svg class="w-5 h-5 text-gray-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2a1 1 0 01.293.707l-6.707 8.707V21l-4-2v-4.586L2.707 6.707A1 1 0 013 6V4z"></path>
                    </svg>
                    
                    <!-- State Filter -->
                    <div class="relative">
                      <button id="stateChip" class="flex items-center h-8 px-3 rounded-md text-sm text-gray-700 hover:bg-gray-50 transition whitespace-nowrap" data-filter="state" title="State filter">
                        <span id="stateChipLabel">All</span>
                        <svg class="w-4 h-4 text-gray-500 ml-2" viewBox="0 0 20 20" fill="currentColor">
                          <path d="M5.23 7.21a.75.75 0 011.06 0L10 10.92l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.23 8.27a.75.75 0 010-1.06z"/>
                        </svg>
                      </button>
                      <div id="stateMenu" class="hidden absolute mt-2 left-0 bg-white border border-gray-200 rounded-md shadow-lg z-20 max-h-56 overflow-auto">
                        <button class="block w-full text-left px-4 py-1 text-sm text-gray-700 hover:bg-gray-100 whitespace-nowrap" data-value="All">All</button>
                        <button class="block w-full text-left px-4 py-1 text-sm text-gray-700 hover:bg-gray-100 whitespace-nowrap" data-value="Active">Active</button>
                        <button class="block w-full text-left px-4 py-1 text-sm text-gray-700 hover:bg-gray-100 whitespace-nowrap" data-value="Inactive">Inactive</button>
                      </div>
                    </div>

                    <!-- DSP Filter -->
                    <div class="relative">
                      <button id="dspChip" class="flex items-center h-8 px-3 rounded-md text-sm text-gray-700 hover:bg-gray-50 transition whitespace-nowrap" data-filter="dsp" title="DSP filter">
                        <span id="dspChipLabel">All</span>
                        <svg class="w-4 h-4 text-gray-500 ml-2 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                          <path d="M5.23 7.21a.75.75 0 011.06 0L10 10.92l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.23 8.27a.75.75 0 010-1.06z"/>
                        </svg>
                      </button>
                      <div id="dspMenu" class="hidden absolute mt-2 left-0 bg-white border border-gray-200 rounded-md shadow-lg z-20 max-h-56 overflow-auto min-w-max">
                        <button class="block w-full text-left px-4 py-1 text-sm text-gray-700 hover:bg-gray-100 whitespace-nowrap" data-value="All">All</button>
                        <button class="block w-full text-left px-4 py-1 text-sm text-gray-700 hover:bg-gray-100 whitespace-nowrap" data-value="Google Campaign Manager">Google Campaign Manager</button>
                        <button class="block w-full text-left px-4 py-1 text-sm text-gray-700 hover:bg-gray-100 whitespace-nowrap" data-value="Trade Desk">Trade Desk</button>
                        <button class="block w-full text-left px-4 py-1 text-sm text-gray-700 hover:bg-gray-100 whitespace-nowrap" data-value="DV360">DV360</button>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="h-6 border-l border-gray-400 mx-1"></div>

                <!-- Search -->
                <div class="relative">
                  <div class="search-container">
                    <div class="search-wrapper" id="searchWrapper" style="height:40px;">
                      <button id="searchToggle" class="search-icon" aria-label="Open search" type="button">
                        <svg viewBox="0 0 24 24">
                          <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                        </svg>
                      </button>
                      <input type="text" id="searchInput" class="search-input" placeholder="Enter ID, DSP, or Campaign Name" autocomplete="off" aria-label="Search campaigns" />
                      <button id="searchClear" class="clear-button" aria-label="Clear search" type="button">
                        <svg viewBox="0 0 24 24">
                          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Table -->
           <div class="overflow-x-auto border border-default rounded-md">
             <table id="campaignTable" class="min-w-full table-fixed rounded-md overflow-hidden tbl tbl-row-hover tbl-row-alt">
               <thead class="tbl-head">
                  <tr>
                    <th scope="col" class="text-sm font-medium text-gray-700 uppercase tracking-wider border-r border-gray-200">
                      <button type="button" class="sort-btn flex w-full items-center px-6 py-2 space-x-2" data-sort-key="id">
                        <span>ID</span>
                      </button>
                    </th>
                    <th scope="col" class="text-sm font-medium text-gray-700 uppercase tracking-wider border-r border-gray-200">
                      <button type="button" class="sort-btn flex w-full items-center px-6 py-2 space-x-2" data-sort-key="name" aria-label="Sort by Name">
                        <span>Name</span>
                        <span class="sort-indicator text-xs text-gray-400" aria-hidden="true"></span>
                      </button>
                    </th>
                    <th scope="col" class="text-sm font-medium text-gray-700 uppercase tracking-wider border-r border-gray-200">
                      <button type="button" class="sort-btn flex w-full items-center px-6 py-2 space-x-2" data-sort-key="state" aria-label="Sort by State">
                        <span>State</span>
                        <span class="sort-indicator text-xs text-gray-400" aria-hidden="true"></span>
                      </button>
                    </th>
                    <th scope="col" class="text-sm font-medium text-gray-700 uppercase tracking-wider border-r border-gray-200">
                      <button type="button" class="sort-btn flex w-full items-center px-6 py-2 space-x-2" data-sort-key="dsp" aria-label="Sort by DSP">
                        <span>DSP</span>
                        <span class="sort-indicator text-xs text-gray-400" aria-hidden="true"></span>
                      </button>
                    </th>
                    <th scope="col" class="text-sm font-medium text-gray-700 uppercase tracking-wider">
                      <button type="button" class="sort-btn flex w-full items-center px-6 py-2 space-x-2" data-sort-key="adGroups" aria-label="Sort by Ad Groups">
                        <span>Ad Groups</span>
                        <span class="sort-indicator text-xs text-gray-400" aria-hidden="true"></span>
                      </button>
                    </th>

                    <th scope="col" class="text-sm font-medium text-gray-700 uppercase tracking-wider">
  <span class="px-6 py-2 block">Actions</span>
</th>

                  </tr>
                </thead>
                <tbody id="campaignTableBody" class="divide-y">
                  <!-- Campaign rows will be populated by JavaScript -->
                </tbody>
              </table>
            </div>

            <!-- Footer -->
            <div class="mt-4 flex items-center justify-between text-xs text-gray-500">
              <span id="recordCount">0 of 0 showing</span>
              <div id="pagination" class="flex space-x-2">
                <!-- Pagination buttons will be populated by JavaScript -->
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Edit Campaign Group Modal -->
<div id="editGroupModal" class="hidden fixed inset-0 bg-black/50 items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
    <div class="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
      <h3 class="text-base font-semibold text-gray-900">Edit Campaign Group</h3>
      <button id="editGroupCloseX" class="p-1 rounded hover:bg-gray-100" aria-label="Close">
        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <div class="p-4">
      <label for="editGroupNameInput" class="block text-sm font-medium text-gray-700 mb-1">Group Name</label>
      <input id="editGroupNameInput" type="text" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter group name"/>
    </div>

    <div class="px-4 py-3 border-t border-gray-200 flex justify-end gap-2">
      <button id="editGroupCancelBtn" class="h-9 px-4 rounded-md border border-gray-300 bg-white text-gray-700 hover:bg-gray-50">Cancel</button>
      <button id="editGroupSaveBtn" class="h-9 px-4 rounded-md bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Save</button>
    </div>
  </div>
</div>

  <!-- Toast Container -->
  <div id="toastContainer" aria-live="polite" aria-atomic="true"></div>


<!-- Create Campaign Modal -->
<div id="createCampaignModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-3xl p-6 relative">
    <button id="closeCampaignModal" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>

    <h2 class="text-xl font-semibold text-gray-900 mb-4">Create New Campaign</h2>

    <form id="createCampaignForm" class="space-y-6 overflow-y-auto max-h-[75vh] pr-2">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div><label class="block text-sm font-medium text-gray-700">Campaign Name<input type="text" id="campaignName" class="mt-1 w-full border border-gray-300 rounded px-3 py-2" required></label></div>
        <div><label class="block text-sm font-medium text-gray-700">Channel<input type="text" id="campaignChannel" class="mt-1 w-full border border-gray-300 rounded px-3 py-2"></label></div>
        <div><label class="block text-sm font-medium text-gray-700">KPI<input type="text" id="campaignKPI" class="mt-1 w-full border border-gray-300 rounded px-3 py-2"></label></div>
        <div><label class="block text-sm font-medium text-gray-700">KPI Target<input type="text" id="campaignKPITarget" class="mt-1 w-full border border-gray-300 rounded px-3 py-2"></label></div>
        <div><label class="block text-sm font-medium text-gray-700">Pacing<input type="text" id="campaignPacing" class="mt-1 w-full border border-gray-300 rounded px-3 py-2"></label></div>
        <div><label class="block text-sm font-medium text-gray-700">Advertiser<input type="text" id="campaignAdvertiser" class="mt-1 w-full border border-gray-300 rounded px-3 py-2"></label></div>
        <div><label class="block text-sm font-medium text-gray-700">Objective<input type="text" id="campaignObjective" class="mt-1 w-full border border-gray-300 rounded px-3 py-2"></label></div>
        <div><label class="block text-sm font-medium text-gray-700">Start Date<input type="date" id="campaignStartDate" class="mt-1 w-full border border-gray-300 rounded px-3 py-2"></label></div>
        <div><label class="block text-sm font-medium text-gray-700">End Date<input type="date" id="campaignEndDate" class="mt-1 w-full border border-gray-300 rounded px-3 py-2"></label></div>
        <div><label class="block text-sm font-medium text-gray-700">Total Budget<input type="number" id="campaignTotalBudget" class="mt-1 w-full border border-gray-300 rounded px-3 py-2"></label></div>
        <div><label class="block text-sm font-medium text-gray-700">Daily Budget<input type="number" id="campaignDailyBudget" class="mt-1 w-full border border-gray-300 rounded px-3 py-2"></label></div>
        <div class="sm:col-span-2"><label class="block text-sm font-medium text-gray-700">Target Audience<input type="text" id="targetAudience" class="mt-1 w-full border border-gray-300 rounded px-3 py-2"></label></div>
        <div><label class="block text-sm font-medium text-gray-700">Geographic Targeting<input type="text" id="geoTargeting" class="mt-1 w-full border border-gray-300 rounded px-3 py-2"></label></div>
        <div><label class="block text-sm font-medium text-gray-700">Device Targeting<input type="text" id="deviceTargeting" class="mt-1 w-full border border-gray-300 rounded px-3 py-2"></label></div>
      </div>

      <div class="flex justify-end gap-3 pt-4">
        <button type="button" id="cancelCampaignModal" class="px-4 py-2 text-sm text-gray-700 border border-gray-300 rounded hover:bg-gray-100">Cancel</button>
        <button type="submit" class="px-4 py-2 text-sm text-white bg-blue-600 rounded hover:bg-blue-700">Create</button>
      </div>
    </form>
  </div>
</div>



<!-- AUDIT DRAWER -->
<div id="auditDrawer" class="fixed right-0 bottom-0 z-50 flex justify-end transition transform translate-x-full bg-black bg-opacity-30" style="top: 56px; left: 0;">
  <div class="relative w-full max-w-2xl bg-white shadow-lg p-6 overflow-y-auto">
    <div class="flex justify-between items-center mb-2">
      <h2 class="text-lg font-semibold text-gray-900" data-audit-context>Manual Entry Log</h2>
      <button data-close-drawer class="text-gray-500 hover:text-gray-700">
        ✕
      </button>
    </div>
    <div class="-mx-2 my-2 border-b border-gray-300"></div>
    <div data-audit-list class="space-y-2 mb-4"></div>

<div class="mt-4">
  <div class="-mx-2 px-4 py-1 mb-2 text-xs font-semibold text-gray-600 uppercase rounded-md" style="background-color: #d1d5db;">
    Custom Instructions
  </div>
  <textarea id="customInstructions" rows="4" data-audit-notes class="block w-full border border-gray-300 rounded-md p-2 text-sm text-gray-900"></textarea>
</div>
    <div class="mt-4 flex justify-between">
      <button data-clear class="bg-red-100 text-red-700 px-4 py-2 text-sm rounded-md hover:bg-red-200">Clear</button>
      <button disabled class="bg-blue-600 text-white px-4 py-2 text-sm rounded-md opacity-80 cursor-not-allowed">Export (Coming Soon)</button>
    </div>
  </div>
</div>


  <script>
    // === CONFIGURATION ===
    const CONFIG = {
      STORAGE_KEYS: {
        DATA: 'campaign_tree_groups', // updated key for groups
        STATE_FILTER: 'campaign_state_filter',
        DSP_FILTER: 'campaign_dsp_filter'
      },
      PAGINATION: {
        DEFAULT_ROWS: 15,
        MAX_ROWS: 200
      }
    };

    // === SAMPLE GROUPED DATA (Tree) ===
    const DEFAULT_GROUPS = [
      {
        id: 'GRP-AUR',
        name: 'Aurora Launch',
        expanded: true,
        campaigns: [
          { id: 'CAM-001', name: 'Aurora Teaser', state: 'Active', dsp: 'DV360', adGroups: 4 },
          { id: 'CAM-002', name: 'Aurora Reveal', state: 'Inactive', dsp: 'Trade Desk', adGroups: 6 }
        ]
      },
      {
        id: 'GRP-HRV',
        name: 'Harvest Promo',
        expanded: true,
        campaigns: [
          { id: 'CAM-003', name: 'Autumn Offers', state: 'Active', dsp: 'Google Campaign Manager', adGroups: 3 },
          { id: 'CAM-004', name: 'Thanksgiving Push', state: 'Active', dsp: 'DV360', adGroups: 5 },
          { id: 'CAM-005', name: 'Weekend Harvest', state: 'Inactive', dsp: 'Trade Desk', adGroups: 2 },
          { id: 'CAM-006', name: 'Last Call Harvest', state: 'Active', dsp: 'Trade Desk', adGroups: 4 }
        ]
      },
      {
        id: 'GRP-LUN',
        name: 'Lunar Brand Lift',
        expanded: false,
        campaigns: [
          { id: 'CAM-007', name: 'Moonlight Social', state: 'Active', dsp: 'Trade Desk', adGroups: 7 },
          { id: 'CAM-008', name: 'Night Sky Video', state: 'Inactive', dsp: 'DV360', adGroups: 6 },
          { id: 'CAM-009', name: 'Crater Display', state: 'Active', dsp: 'Google Campaign Manager', adGroups: 5 },
          { id: 'CAM-010', name: 'Orbit Awareness', state: 'Active', dsp: 'DV360', adGroups: 8 },
          { id: 'CAM-011', name: 'Eclipse Countdown', state: 'Inactive', dsp: 'Trade Desk', adGroups: 3 },
          { id: 'CAM-012', name: 'Tidal Retargeting', state: 'Active', dsp: 'DV360', adGroups: 4 }
        ]
      },
      {
        id: 'GRP-VEL',
        name: 'Velocity Retargeting',
        expanded: true,
        campaigns: [
          { id: 'CAM-013', name: 'Cart Abandoners', state: 'Active', dsp: 'Google Campaign Manager', adGroups: 9 },
          { id: 'CAM-014', name: 'Repeat Buyers', state: 'Active', dsp: 'Trade Desk', adGroups: 6 },
          { id: 'CAM-015', name: 'Lookalike Sprint', state: 'Inactive', dsp: 'DV360', adGroups: 5 },
          { id: 'CAM-016', name: 'Frequency Cap Tune', state: 'Active', dsp: 'Trade Desk', adGroups: 7 },
          { id: 'CAM-017', name: 'Video Retarget', state: 'Active', dsp: 'DV360', adGroups: 8 },
          { id: 'CAM-018', name: 'Search Warmup', state: 'Inactive', dsp: 'Google Campaign Manager', adGroups: 4 },
          { id: 'CAM-019', name: 'Dynamic Creative', state: 'Active', dsp: 'Trade Desk', adGroups: 10 },
          { id: 'CAM-020', name: 'High-Intent Pulse', state: 'Active', dsp: 'DV360', adGroups: 6 }
        ]
      }
    ];

    // === MAIN APPLICATION (Tree Table) ===
    let app = null;

    document.addEventListener('DOMContentLoaded', function() {
      app = {
        groups: [],
        currentPage: 1,
        rowsPerPage: CONFIG.PAGINATION.DEFAULT_ROWS,
        filters: { state: 'All', dsp: 'All' },
        searchQuery: '',
        elements: {},
        searchExpanded: false,
        editingGroupId: null,

        init: function() {
          this.loadGroups();
          this.cacheElements();
          this.loadFilters();
          this.initEventListeners();
          this.applyFiltersAndRender();
        },

        loadGroups: function() {
          try {
            const stored = localStorage.getItem(CONFIG.STORAGE_KEYS.DATA);
            if (stored) {
              this.groups = JSON.parse(stored);
            } else {
              this.groups = JSON.parse(JSON.stringify(DEFAULT_GROUPS));
              this.saveGroups();
            }
          } catch (e) {
            console.warn('Failed to load groups:', e);
            this.groups = JSON.parse(JSON.stringify(DEFAULT_GROUPS));
          }
        },

        saveGroups: function() {
          try {
            localStorage.setItem(CONFIG.STORAGE_KEYS.DATA, JSON.stringify(this.groups));
            try {
const latestGroup = this.groups.at(-1);
const campaign = latestGroup?.campaign; // this is the real campaign object
  if (campaign && campaign.id) {
  audit.recordCreate({
    campaignId: campaign.id,
    entityType: 'campaign',
    entityId: campaign.id,
    data: {
      campaignName: campaign.name,
      campaignChannel: campaign.channel,
      campaignKPI: campaign.kpi,
      campaignKPITarget: campaign.kpiTarget,
      campaignPacing: campaign.pacing,
      campaignAdvertiser: campaign.advertiser,
      campaignObjective: campaign.objective,
      campaignStartDate: campaign.startDate,
      campaignEndDate: campaign.endDate,
      campaignTotalBudget: campaign.totalBudget,
      campaignDailyBudget: campaign.dailyBudget,
      targetAudience: campaign.audience,
      geoTargeting: campaign.geo,
      deviceTargeting: campaign.device
    }
  });

  console.log('✔️ Audit logged for campaign:', campaign.id);
}
} catch (e) {
  console.warn('Failed to log audit creation:', e);
}

          } catch (e) {
            console.warn('Failed to save groups:', e);
          }
        },

        cacheElements: function() {
          const ids = [
            'menuButton','menuDropdown','notificationButton','notificationDropdown',
            'createBtn','stateChip','stateChipLabel','stateMenu',
            'dspChip','dspChipLabel','dspMenu',
            'searchWrapper','searchToggle','searchInput','searchClear','filtersGroup',
            'campaignTableBody','recordCount','pagination',
            // Modal elements
            'editGroupModal','editGroupNameInput','editGroupSaveBtn','editGroupCancelBtn','editGroupCloseX'
          ];
          ids.forEach(id => this.elements[id] = document.getElementById(id));

          // Delegate toggles and edit buttons on the tbody
          if (this.elements.campaignTableBody) {
            this.elements.campaignTableBody.addEventListener('click', (e) => {
              const toggleBtn = e.target.closest('[data-action="toggle-group"]');
              if (toggleBtn) {
                const gid = toggleBtn.getAttribute('data-group-id');
                const g = this.groups.find(x => x.id === gid);
                if (!g) return;
                g.expanded = !g.expanded;
                this.applyFiltersAndRender();
                return;
              }

              const editBtn = e.target.closest('[data-action="edit-group"]');
              if (editBtn) {
                const gid = editBtn.getAttribute('data-group-id');
                this.openEditGroupModal(gid);
              }
            });
          }
        },

        initEventListeners: function() {
          const self = this;

          // Menu dropdown
          if (this.elements.menuButton) {
            this.elements.menuButton.addEventListener('click', function(e) {
              e.stopPropagation();
              self.elements.menuDropdown.classList.toggle('hidden');
            });
          }

          // Create button
if (this.elements.createBtn) {
  this.elements.createBtn.addEventListener('click', () => {
    const modal = document.getElementById('createCampaignModal');
    if (modal) {
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }
  });
}

          // State filter
          if (this.elements.stateChip) {
            this.elements.stateChip.addEventListener('click', function(e) {
              e.stopPropagation();
              self.elements.stateMenu.classList.toggle('hidden');
              if (self.elements.dspMenu) self.elements.dspMenu.classList.add('hidden');
            });
          }
          if (this.elements.stateMenu) {
            this.elements.stateMenu.addEventListener('click', function(e) {
              const btn = e.target.closest('button'); if (!btn) return;
              const value = btn.dataset.value;
              if (self.elements.stateChipLabel) self.elements.stateChipLabel.textContent = value === 'All' ? 'All' : value;
              self.filters.state = value;
              localStorage.setItem(CONFIG.STORAGE_KEYS.STATE_FILTER, value);
              self.currentPage = 1;
              self.closeAllDropdowns();
              self.applyFiltersAndRender();
            });
          }

          // DSP filter
          if (this.elements.dspChip) {
            this.elements.dspChip.addEventListener('click', function(e) {
              e.stopPropagation();
              self.elements.dspMenu.classList.toggle('hidden');
              if (self.elements.stateMenu) self.elements.stateMenu.classList.add('hidden');
            });
          }
          if (this.elements.dspMenu) {
            this.elements.dspMenu.addEventListener('click', function(e) {
              const btn = e.target.closest('button'); if (!btn) return;
              const value = btn.dataset.value;
              if (self.elements.dspChipLabel) self.elements.dspChipLabel.textContent = value === 'All' ? 'All' : value;
              self.filters.dsp = value;
              localStorage.setItem(CONFIG.STORAGE_KEYS.DSP_FILTER, value);
              self.currentPage = 1;
              self.closeAllDropdowns();
              self.applyFiltersAndRender();
            });
          }

          // Search
          if (this.elements.searchToggle) {
            this.elements.searchToggle.addEventListener('click', function(e) {
              e.stopPropagation();
              if (!self.searchExpanded) {
                self.elements.searchWrapper.classList.add('expanded');
                self.searchExpanded = true;
                setTimeout(() => self.elements.searchInput && self.elements.searchInput.focus(), 100);
              }
            });
          }
          if (this.elements.searchInput) {
            this.elements.searchInput.addEventListener('input', function(e) {
              self.searchQuery = e.target.value;
              self.updateSearchState();
              self.currentPage = 1;
              self.applyFiltersAndRender();
            });
            
            // Prevent search from closing when clicking in the input
            this.elements.searchInput.addEventListener('click', function(e) {
              e.stopPropagation();
            });
          }
          if (this.elements.searchClear) {
            this.elements.searchClear.addEventListener('click', function(e) {
              e.stopPropagation();
              if (self.elements.searchInput) self.elements.searchInput.value = '';
              self.searchQuery = '';
              self.updateSearchState();
              self.currentPage = 1;
              self.applyFiltersAndRender();
            });
          }

          // Pagination
          if (this.elements.pagination) {
            this.elements.pagination.addEventListener('click', function(e) {
              const button = e.target.closest('button');
              if (!button || button.disabled) return;
              e.preventDefault();
              const action = button.dataset.action;
              const pageNum = parseInt(button.textContent);
              if (action === 'prev' && self.currentPage > 1) self.currentPage--;
              else if (action === 'next' && self.currentPage < self.getTotalPages()) self.currentPage++;
              else if (!isNaN(pageNum) && pageNum !== self.currentPage) self.currentPage = pageNum;
              self.applyFiltersAndRender();
            });
          }

          // Close on doc click
          document.addEventListener('click', function(e) { 
            // Don't close search if clicking inside search wrapper
            const clickedInsideSearch = self.elements.searchWrapper && self.elements.searchWrapper.contains(e.target);
            
            if (!clickedInsideSearch) {
              self.closeAllDropdowns();
              
              // Collapse search only when clicking outside and no text present
              if (self.searchExpanded && !self.searchQuery.trim()) {
                self.elements.searchWrapper?.classList.remove('expanded');
                self.searchExpanded = false;
                self.updateSearchState();
              }
            }
          });

          // Set initial filter labels
          if (this.elements.stateChipLabel) this.elements.stateChipLabel.textContent = this.filters.state === 'All' ? 'All' : this.filters.state;
          if (this.elements.dspChipLabel) this.elements.dspChipLabel.textContent = this.filters.dsp === 'All' ? 'All' : this.filters.dsp;

          // Modal events
          if (this.elements.editGroupSaveBtn) {
            this.elements.editGroupSaveBtn.addEventListener('click', () => this.saveEditGroupName());
          }
          if (this.elements.editGroupCancelBtn) {
            this.elements.editGroupCancelBtn.addEventListener('click', () => this.closeEditGroupModal());
          }
          if (this.elements.editGroupCloseX) {
            this.elements.editGroupCloseX.addEventListener('click', () => this.closeEditGroupModal());
          }
          if (this.elements.editGroupModal) {
            // Close when clicking overlay (outside the dialog)
            this.elements.editGroupModal.addEventListener('click', (e) => {
              if (e.target === this.elements.editGroupModal) this.closeEditGroupModal();
            });
          }
          if (this.elements.editGroupNameInput) {
            // Enable/disable Save based on changes
            this.elements.editGroupNameInput.addEventListener('input', () => this.updateEditGroupSaveState());
            // Enter to save, Esc to cancel
            this.elements.editGroupNameInput.addEventListener('keydown', (e) => {
              if (e.key === 'Enter') {
                e.preventDefault();
                if (!this.elements.editGroupSaveBtn.disabled) this.saveEditGroupName();
              }
              if (e.key === 'Escape') this.closeEditGroupModal();
            });
          }
        },

        loadFilters: function() {
          this.filters.state = localStorage.getItem(CONFIG.STORAGE_KEYS.STATE_FILTER) || 'All';
          this.filters.dsp = localStorage.getItem(CONFIG.STORAGE_KEYS.DSP_FILTER) || 'All';
        },

        closeAllDropdowns: function() {
          if (this.elements.menuDropdown) this.elements.menuDropdown.classList.add('hidden');
          if (this.elements.stateMenu) this.elements.stateMenu.classList.add('hidden');
          if (this.elements.dspMenu) this.elements.dspMenu.classList.add('hidden');
          if (this.elements.notificationDropdown) this.elements.notificationDropdown.classList.add('hidden');
          
          // Only collapse search if clicking outside AND no text present
          // This will be handled by the document click handler with proper targeting
        },

        updateSearchState: function() {
          const active = this.searchQuery.trim().length > 0;
          this.elements.searchClear?.classList.toggle('visible', active);
          if (this.elements.filtersGroup) {
            this.elements.filtersGroup.classList.toggle('opacity-50', active);
            this.elements.filtersGroup.classList.toggle('pointer-events-none', active);
          }
        },

        // Build visible rows (group headers + children)
        getVisibleRows: function() {
          const q = this.searchQuery.trim().toLowerCase();
          const filterBy = (c) => {
            if (this.filters.state !== 'All' && c.state !== this.filters.state) return false;
            if (this.filters.dsp !== 'All' && c.dsp !== this.filters.dsp) return false;
            if (!q) return true;
            return (
              (c.id && c.id.toLowerCase().includes(q)) ||
              (c.name && c.name.toLowerCase().includes(q)) ||
              (c.dsp && c.dsp.toLowerCase().includes(q))
            );
          };

          const rows = [];
          for (const g of this.groups) {
            const groupMatchesSearch = q && g.name.toLowerCase().includes(q);
            const children = g.campaigns.filter(filterBy);
            const showGroup = groupMatchesSearch || children.length > 0 || !q; // always show when no search

            if (!showGroup) continue;

            rows.push({ type: 'group', groupId: g.id, name: g.name, expanded: g.expanded, childCount: children.length });

            if (g.expanded) {
              for (const c of children) {
                rows.push({ type: 'campaign', groupId: g.id, campaign: c });
              }
            }
          }
          return rows;
        },

        getCounts: function() {
          // total campaigns after filters/search (not paginated)
          const q = this.searchQuery.trim().toLowerCase();
          let total = 0;
          for (const g of this.groups) {
            for (const c of g.campaigns) {
              const matchesState = this.filters.state === 'All' || c.state === this.filters.state;
              const matchesDsp = this.filters.dsp === 'All' || c.dsp === this.filters.dsp;
              const matchesSearch = !q || (c.id?.toLowerCase().includes(q) || c.name?.toLowerCase().includes(q) || c.dsp?.toLowerCase().includes(q) || g.name.toLowerCase().includes(q));
              if (matchesState && matchesDsp && matchesSearch) total++;
            }
          }
          return total;
        },

        getPaginatedData: function() {
          const visible = this.getVisibleRows();
          const start = (this.currentPage - 1) * this.rowsPerPage;
          const end = start + this.rowsPerPage;
          return { data: visible.slice(start, end), totalVisible: visible.length };
        },

        getTotalPages: function() {
          const total = this.getVisibleRows().length;
          return Math.max(1, Math.ceil(total / this.rowsPerPage));
        },

        applyFiltersAndRender: function() {
          const { data, totalVisible } = this.getPaginatedData();
          const totalPages = this.getTotalPages();
          if (this.currentPage > totalPages) this.currentPage = totalPages;
          if (this.currentPage < 1) this.currentPage = 1;

          this.renderTable(data);
          this.updateRecordCount(this.getCounts(), data.filter(r => r.type === 'campaign').length);
          this.renderPagination(totalVisible);
        },

        // Modal controls
        openEditGroupModal: function(groupId) {
          const group = this.groups.find(g => g.id === groupId);
          if (!group) return;

          this.editingGroupId = groupId;
          if (this.elements.editGroupNameInput) {
            this.elements.editGroupNameInput.value = group.name || '';
            this.elements.editGroupNameInput.dataset.original = group.name || '';
          }
          if (this.elements.editGroupModal) {
            this.elements.editGroupModal.classList.remove('hidden');
            this.elements.editGroupModal.classList.add('flex');
          }
          // Focus input
          setTimeout(() => this.elements.editGroupNameInput?.focus(), 50);
          this.updateEditGroupSaveState();
        },

        closeEditGroupModal: function() {
          this.editingGroupId = null;
          if (this.elements.editGroupModal) {
            this.elements.editGroupModal.classList.add('hidden');
            this.elements.editGroupModal.classList.remove('flex');
          }
        },

        updateEditGroupSaveState: function() {
          if (!this.elements.editGroupNameInput || !this.elements.editGroupSaveBtn) return;
          const val = (this.elements.editGroupNameInput.value || '').trim();
          const orig = this.elements.editGroupNameInput.dataset.original || '';
          this.elements.editGroupSaveBtn.disabled = (val.length === 0 || val === orig);
        },

        saveEditGroupName: function() {
          if (!this.editingGroupId || !this.elements.editGroupNameInput) return;
          const newName = this.elements.editGroupNameInput.value.trim();
          if (!newName) return;

          const group = this.groups.find(g => g.id === this.editingGroupId);
          if (!group) return;

          // === Track Edit Audit ===
const originalData = { ...group };
const updatedData = { ...group, name: newName };

try {
  audit.recordEdit({
    campaignId: group.id,
    entityType: 'campaign',
    entityId: group.id,
    before: originalData,
    after: updatedData
  });
} catch (err) {
  console.warn('Audit edit failed:', err);
}

          
          group.name = newName;
          this.saveGroups();
          this.applyFiltersAndRender();
          this.closeEditGroupModal();
          if (typeof showToast === 'function') showToast('Campaign Group name updated');
        },

        renderTable: function(rows) {
          const tbody = this.elements.campaignTableBody;
          if (!tbody) return;
          tbody.innerHTML = '';

          if (rows.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="5" class="px-6 py-4 text-center text-gray-500">No results</td>';
            tbody.appendChild(tr);
            return;
          }

          rows.forEach(r => {
            const tr = document.createElement('tr');

            if (r.type === 'group') {
             tr.innerHTML = `
  <td class="px-3 py-1 text-sm font-semibold border-r border-default bg-gray-100">
    <button data-action="toggle-group" data-group-id="${r.groupId}" class="w-4 h-4 inline-flex items-center justify-center rounded border border-strong bg-white mr-2" title="${r.expanded ? 'Collapse' : 'Expand'}">
      ${r.expanded ? '&minus;' : '+'}
    </button>
  </td>
  <td colspan="4" class="px-3 py-1 text-sm font-semibold border-r border-default bg-gray-100">
    Campaign Group: ${r.name}
    <button class="ml-2 align-middle" title="Edit Group" data-action="edit-group" data-group-id="${r.groupId}">
      <svg class="inline w-4 h-4 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
      </svg>
    </button>
  </td>
  <td class="bg-gray-100 border-default border-r"></td>
`;
;
              tr.className = 'row-group';
            } else {
              const c = r.campaign;

tr.className = 'hover:bg-gray-50';
tr.innerHTML = `
  <td class="px-6 py-1 whitespace-nowrap text-sm border-r border-default">${c.id || ''}</td>
  <td class="px-6 py-1 whitespace-nowrap text-sm font-medium border-r border-default">
    <a href="./CampaignDetails.html?campaignId=${encodeURIComponent(c.id)}&campaignName=${encodeURIComponent(c.name)}" class="text-blue-600 hover:underline">
      ${c.name || ''}
    </a>
  </td>
  <td class="px-6 py-1 whitespace-nowrap text-sm border-r border-default">${c.state || ''}</td>
  <td class="px-6 py-1 whitespace-nowrap text-sm border-r border-default">${c.dsp || ''}</td>
  <td class="px-6 py-1 whitespace-nowrap text-sm text-right tabular-nums border-r border-default">${c.adGroups ?? 0}</td>
`;
const tdActions = document.createElement('td');
tdActions.className = 'px-6 py-1 whitespace-nowrap text-sm text-center flex gap-3 justify-center items-center';

// Create Export link dynamically
const exportLink = document.createElement('a');
exportLink.href = '#';
exportLink.className = 'text-blue-600 hover:underline export-btn';
exportLink.textContent = 'Export';

const advData = JSON.parse(localStorage.getItem('adv_selected_data') || '{}');
exportLink.dataset.export = true;
exportLink.dataset.campaignId = c.id;
exportLink.dataset.advName = advData.name || 'Unknown Advertiser';
exportLink.dataset.advAccount = advData.account || '—';

// Create Delete button
const deleteBtn = document.createElement('button');
deleteBtn.className = 'text-red-600 hover:underline delete-campaign';
deleteBtn.dataset.id = c.id;
deleteBtn.textContent = 'Delete';

// Add both to Actions column
tdActions.appendChild(exportLink);
tdActions.appendChild(deleteBtn);
tr.appendChild(tdActions);
            }

            this.elements.campaignTableBody.appendChild(tr);
          });
        },

        updateRecordCount: function(filteredCampaignsTotal, showingCampaignRows) {
          if (this.elements.recordCount) {
            this.elements.recordCount.textContent = `${showingCampaignRows} of ${filteredCampaignsTotal} campaigns showing`;
          }
        },

        renderPagination: function(totalVisibleRows) {
          const pager = this.elements.pagination;
          if (!pager) return;

          if (totalVisibleRows <= this.rowsPerPage) {
            pager.style.display = 'none';
            return;
          }
          pager.style.display = 'flex';

          const totalPages = this.getTotalPages();
          const buttons = [];
          const prevDisabled = this.currentPage === 1;
          buttons.push(`<button data-action="prev" class="px-2 py-1 text-gray-700 hover:bg-gray-200 rounded-md${prevDisabled ? ' opacity-50 cursor-not-allowed' : ''}" ${prevDisabled ? 'disabled' : ''}>&lt;</button>`);

          const maxButtons = 5;
          let start = Math.max(1, this.currentPage - Math.floor(maxButtons / 2));
          let end = Math.min(totalPages, start + maxButtons - 1);
          if (end - start + 1 < maxButtons) start = Math.max(1, end - maxButtons + 1);

          for (let p = start; p <= end; p++) {
            const active = (p === this.currentPage) ? 'bg-gray-200 font-medium' : '';
            buttons.push(`<button class="px-2 py-1 ${active} text-gray-700 hover:bg-gray-200 rounded-md">${p}</button>`);
          }

          const nextDisabled = this.currentPage === totalPages;
          buttons.push(`<button data-action="next" class="px-2 py-1 text-gray-700 hover:bg-gray-200 rounded-md${nextDisabled ? ' opacity-50 cursor-not-allowed' : ''}" ${nextDisabled ? 'disabled' : ''}>&gt;</button>`);
          pager.innerHTML = buttons.join('');
        }
      };

      app.init();
    });
  </script>

  <!-- Data binding script for advertiser info -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Load advertiser data for the header
      try {
        const selectedData = localStorage.getItem('adv_selected_data');
        if (selectedData) {
          const advertiser = JSON.parse(selectedData);
          
          // Bind advertiser data to header elements
          const nameEl = document.querySelector('[data-bind="adv.name"]');
          const accountEl = document.querySelector('[data-bind="adv.account"]');
          const idEl = document.querySelector('[data-bind="adv.id"]');
          
          if (nameEl) nameEl.textContent = advertiser.name || 'Unknown Advertiser';
          if (accountEl) accountEl.textContent = advertiser.account || '—';
          if (idEl) idEl.textContent = advertiser.id || '—';
        }
      } catch (e) {
        console.warn('Failed to load advertiser data:', e);
      }
    });


// Delete campaign handler
document.addEventListener('click', (e) => {
  const btn = e.target.closest('.delete-campaign');
  if (!btn) return;

  const campaignId = btn.dataset.id;
  if (!campaignId) return;

  if (!confirm(`Are you sure you want to delete Campaign ID "${campaignId}"?`)) return;

  app.groups.forEach(group => {
    group.campaigns = group.campaigns.filter(c => c.id !== campaignId);
  });

  app.saveGroups?.();
  app.applyFiltersAndRender?.();
});

// Show / hide modal handlers
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('createCampaignBtn')?.addEventListener('click', () => {
    document.getElementById('createCampaignModal')?.classList.remove('hidden');
  });

  document.getElementById('closeCampaignModal')?.addEventListener('click', () => {
    document.getElementById('createCampaignModal')?.classList.add('hidden');
  });

  document.getElementById('cancelCampaignModal')?.addEventListener('click', () => {
    document.getElementById('createCampaignModal')?.classList.add('hidden');
  });
});

// Create campaign logic
document.getElementById('createCampaignForm').addEventListener('submit', function (e) {
  e.preventDefault();

  const campaign = {
    id: 'CAM-' + Date.now(),
    name: document.getElementById('campaignName')?.value || '',
    advertiser: document.getElementById('campaignAdvertiser')?.value || '',
    objective: document.getElementById('campaignObjective')?.value || '',
    startDate: document.getElementById('campaignStartDate')?.value || '',
    endDate: document.getElementById('campaignEndDate')?.value || '',
    totalBudget: document.getElementById('campaignTotalBudget')?.value || '0',
    dailyBudget: document.getElementById('campaignDailyBudget')?.value || '0',
    targetAudience: document.getElementById('targetAudience')?.value || '',
    geoTargeting: document.getElementById('geoTargeting')?.value || '',
    deviceTargeting: document.getElementById('deviceTargeting')?.value || '',
    channel: document.getElementById('campaignChannel')?.value || '',
    kpi: document.getElementById('campaignKPI')?.value || '',
    kpiTarget: document.getElementById('campaignKPITarget')?.value || '',
    pacing: document.getElementById('campaignPacing')?.value || '',
    state: 'Active',
    dsp: 'DV360',
    adGroups: 0
  };

  const raw = localStorage.getItem('campaign_tree_groups');
  let groups = raw ? JSON.parse(raw) : [];

  if (!groups.length) {
    groups.push({ id: 'DEFAULT', name: 'Ungrouped', expanded: true, campaigns: [] });
  }

  groups[0].campaigns.unshift(campaign);

// Log creation to audit
audit.recordCreate({
  campaignId: campaign.id,
  entityType: 'campaign',
  entityId: campaign.id,
  data: {
    campaignName: campaign.name,
    campaignChannel: campaign.channel,
    campaignKPI: campaign.kpi,
    campaignKPITarget: campaign.kpiTarget,
    campaignPacing: campaign.pacing,
    campaignAdvertiser: campaign.advertiser,
    campaignObjective: campaign.objective,
    campaignStartDate: campaign.startDate,
    campaignEndDate: campaign.endDate,
    campaignTotalBudget: campaign.totalBudget,
    campaignDailyBudget: campaign.dailyBudget,
    targetAudience: campaign.targetAudience,
    geoTargeting: campaign.geoTargeting,
    deviceTargeting: campaign.deviceTargeting
  }
});
console.log('✔️ Audit log created for:', campaign.id);



  localStorage.setItem('campaign_tree_groups', JSON.stringify(groups));

  app.groups = groups;
  app.saveGroups?.();
  app.applyFiltersAndRender?.();

  this.reset();
  document.getElementById('createCampaignModal')?.classList.add('hidden');
});




document.addEventListener('DOMContentLoaded', function () {
  document.addEventListener('click', function (e) {
    const exportBtn = e.target.closest('[data-export]');
    if (!exportBtn) return;

    e.preventDefault();
    const campaignId = exportBtn.dataset.campaignId;
    const advName = exportBtn.dataset.advName;
    const advAccount = exportBtn.dataset.advAccount;

    if (!campaignId) {
      alert("Missing campaign ID for audit drawer.");
      return;
    }

    audit.openDrawer({
      campaignId,
      advertiserName: advName,
      advertiserAccount: advAccount
    });
  });
});






  </script>
</body>
</html>