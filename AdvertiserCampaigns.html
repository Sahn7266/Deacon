<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Beacon - Campaigns</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="./assets/toast.css">
  <script src="./assets/campaignConfig.js" defer></script>
  <script src="./assets/notifications.js"></script>
  <script src="./assets/toast.js" defer></script>
  <script src="./assets/sidebar.js" defer></script>
  <link rel="stylesheet" href="./assets/theme.css">
  <link rel="stylesheet" href="./assets/loading.css">
  <script src="./assets/loading.js" defer></script>
  <style>
    body { font-family: 'apple-system', 'Segoe UI', 'Roboto', 'Inter', sans-serif; }

    /* Search component styles */
    .search-container {
      position: relative;
      display: flex;
      align-items: center;
    }

    .search-wrapper {
      position: relative;
      display: flex;
      align-items: center;
      border-radius: 0.375rem;
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      height: 40px;
      width: 50px;
      overflow: hidden;
    }

    .search-wrapper.expanded {
      width: 300px;
    }

    .search-icon {
      position: absolute;
      left: 5px;
      width: 40px;
      height: 40px;
      cursor: pointer;
      z-index: 2;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.2s ease;
    }

    .search-icon svg {
      width: 20px;
      height: 20px;
      fill: #666;
    }

    .search-input {
      width: 100%;
      height: 100%;
      border: none;
      outline: none;
      background: transparent;
      padding: 8px 40px 8px 40px;
      font-size: 14px;
      color: #333;
      opacity: 0;
      transition: opacity 0.2s ease 0.1s;
    }

    .search-input::placeholder {
      color: #999;
    }

    .search-wrapper.expanded .search-input {
      opacity: 1;
      background-color: white;
      height: 80%;
      border: #c5c4c4 1px solid;
      border-radius: .375rem;
    }

    .clear-button {
      position: absolute;
      right: 10px;
      width: 20px;
      height: 20px;
      cursor: pointer;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      z-index: 2;
    }

    .clear-button svg {
      width: 100%;
      height: 100%;
      fill: #666;
    }

    .clear-button:hover svg {
      fill: #333;
    }

    .clear-button.visible {
      opacity: 1;
      visibility: visible;
    }
    
    /* Drag and Drop Styles */
    .campaign-row {
      cursor: move;
    }
    
    .campaign-row:hover {
      background-color: #f9fafb !important;
    }
    
    .campaign-row.dragging {
      opacity: 0.5;
    }
    
    .group-drop-zone {
      transition: all 0.2s ease;
    }
    
    .ungrouped-drop-zone {
      transition: all 0.2s ease;
    }
    
    
    .drop-zone {
      position: relative;
    }
    
    .drop-zone::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      transition: all 0.2s ease;
    }
  </style>

<script src="./assets/audit.js" defer></script>


</head>

<body class="font-inter"><!-- removed bg-gray-100 -->
  <div class="flex h-screen flex-col">
    <!-- Header -->
    <header class="border-b border-strong shadow-sm app-header">
      <div class="flex items-center justify-between px-4 py-2">
        <div class="flex items-center gap-3">
          <img src="./assets/BeaconLogo.png" alt="Beacon Logo" class="h-9 w-auto" />
        </div>

        <nav class="flex items-center gap-3 ml-auto">
            <a href="./index.html" class="text-base text-white hover:text-blue-100" style="font-size: 1.5rem; padding-right: 15px;" onmouseover="this.style.color='#48A9FE'" onmouseout="this.style.color='white'">
            Advertisers
            </a>
          <span class="text-white select-none">|</span>

          <!-- Notifications -->
          <div class="relative">
            <button id="notificationButton" class="p-2 rounded-md  text-white relative" title="Notifications" aria-label="View notifications" onmouseover="this.style.backgroundColor=''" onmouseout="this.style.backgroundColor=''" >
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
              </svg>
              <span id="notificationDot" class="absolute top-2 right-2 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></span>
            </button>

            <!-- Dropdown -->
            <div id="notificationDropdown" class="hidden absolute right-0 mt-2 w-80 bg-white border border-gray-200 rounded-md shadow-lg z-50 max-h-96 overflow-hidden">
              <div class="p-3 border-b border-gray-200 bg-gray-50">
                <div class="flex items-center justify-between">
                  <h3 class="text-sm font-semibold text-gray-900">Notifications</h3>
                  <button id="markAllReadBtn" class="text-xs text-blue-600 hover:text-blue-800">Mark all read</button>
                </div>
              </div>

              <div class="max-h-80 overflow-y-auto">
                <div id="notificationList">
                  <!-- Sample items -->
                  <div class="p-3 border-b border-gray-100 hover:bg-gray-50 cursor-pointer notification-item" data-read="false">
                    <div class="flex items-start gap-3">
                      <div class="flex-shrink-0 w-2 h-2 bg-blue-500 rounded-full mt-2"></div>
                      <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900">Campaign Performance Alert</p>
                        <p class="text-xs text-gray-500 mt-1">"Summer Sale" exceeded budget by 15%</p>
                        <p class="text-xs text-gray-400 mt-1">2 minutes ago</p>
                      </div>
                    </div>
                  </div>

                  <div class="p-3 border-b border-gray-100 hover:bg-gray-50 cursor-pointer notification-item" data-read="false">
                    <div class="flex items-start gap-3">
                      <div class="flex-shrink-0 w-2 h-2 bg-green-500 rounded-full mt-2"></div>
                      <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900">New Advertiser Added</p>
                        <p class="text-xs text-gray-500 mt-1">Stallion Services LLC onboarded</p>
                        <p class="text-xs text-gray-400 mt-1">1 hour ago</p>
                      </div>
                    </div>
                  </div>

                  <div class="p-3 border-b border-gray-100 hover:bg-gray-50 cursor-pointer notification-item" data-read="true">
                    <div class="flex items-start gap-3">
                      <div class="flex-shrink-0 w-2 h-2 bg-gray-300 rounded-full mt-2"></div>
                      <div class="flex-1 min-w-0">
                        <p class="text-sm text-gray-700">Account Sync Complete</p>
                        <p class="text-xs text-gray-500 mt-1">CRM sync finished for 12 accounts</p>
                        <p class="text-xs text-gray-400 mt-1">3 hours ago</p>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="p-3 text-center border-t border-gray-200">
                  <a href="#" class="text-sm text-blue-600 hover:text-blue-800 font-medium">View all notifications</a>
                </div>
              </div>
            </div>
          </div>

          <!-- Waffle Menu -->
          <div class="relative">
            <button class="p-0 rounded-md text-white" id="menuButton" title="Menu" aria-label="Open navigation menu">
              <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                <path d="M4 4h3v3H4V4zM8.5 4h3v3h-3V4zM13 4h3v3h-3V4zM4 8.5h3v3H4v-3zM8.5 8.5h3v3h-3V8.5zM13 8.5h3v3h-3V8.5zM4 13h3v3H4v-3zM8.5 13h3v3h-3V13zM13 13h3v3h-3V13z"></path>
              </svg>
            </button>
            <div id="menuDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-md shadow-lg">
              <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Advertisers</a>
              <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Profile</a>
              <a href="#" id="menuAdmin" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Admin</a>
              <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Sign Out</a>
            </div>
          </div>
        </nav>
      </div>
    </header>

    <!-- Breadcrumb Bar -->
    <div class="bg-white border-b border-gray-200 px-6 py-2">
      <nav class="flex items-center text-sm text-gray-600">
        <a href="./index.html" class="hover:text-blue-600 transition-colors">Advertisers</a>
        <svg class="w-4 h-4 mx-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
        <a href="#" id="breadcrumbAdvertiser" class="hover:text-blue-600 transition-colors">—</a>
        <svg class="w-4 h-4 mx-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
        <span class="font-semibold text-gray-900">Campaigns</span>
      </nav>
    </div>

    <!-- Body -->
    <div class="flex flex-1 overflow-hidden">
      <!-- Sidebar -->
      <nav id="sidebar" class="bg-white w-64 p-4 border-r border-gray-200 overflow-y-auto transition-all duration-200 ease-in-out">
        <div class="flex items-center justify-between pb-4 border-b border-gray-200">
          <div class="flex items-center gap-3">
            <img src="./assets/advertiser.png" alt="Advertiser" class="w-9 h-9 rounded-full" data-sidebar-avatar />
            <h2 data-sidebar-header class="text-base text-lg font-semibold text-gray-800">Advertiser</h2>
          </div>
          <button id="sidebarToggle" class="p-1 rounded hover:bg-gray-100" aria-label="Toggle sidebar" aria-expanded="true" title="Collapse/Expand">
            <!-- Shown when expanded (collapse icon) -->
            <svg id="iconCollapse" class="w-5 h-5 text-gray-900" viewBox="0 0 26 26" fill="currentColor">
              <path fill="#000000" d="M21.5 11.5h-8.793l3.035-3.035a.5.5 0 10-.707-.707l-3.888 3.888a.518.518 0 00-.109.163.505.505 0 000 .382.518.518 0 00.109.163l3.888 3.888a.5.5 0 00.707-.707L12.707 12.5H21.5a.5.5 0 000-1zM7.5 2h-5a.5.5 0 000 1h5a.5.5 0 000-1zM7.5 7h-5a.5.5 0 000 1h5a.5.5 0 000-1zM7.5 11.5h-5a.5.5 0 000 1h5a.5.5 0 000-1zM7.5 16h-5a.5.5 0 000 1h5a.5.5 0 000-1zM7.5 21h-5a.5.5 0 000 1h5a.5.5 0 000-1z">
	            </path>
            </svg>
            <!-- Shown when collapsed (expand icon) -->
            <svg id="iconExpand" class="w-5 h-5 text-gray-900 hidden" viewBox="0 0 26 26" fill="currentColor">
              <path fill="#000000" d="M21.962 12.191a.505.505 0 000-.382.518.518 0 00-.109-.163l-3.888-3.888a.5.5 0 10-.707.707l3.035 3.035H11.5a.5.5 0 000 1h8.793l-3.035 3.035a.5.5 0 10.707.707l3.888-3.888a.518.518 0 00.109-.163zM7.5 2h-5a.5.5 0 000 1h5a.5.5 0 000-1zM7.5 7h-5a.5.5 0 000 1h5a.5.5 0 000-1zM7.5 11.5h-5a.5.5 0 000 1h5a.5.5 0 000-1zM7.5 16h-5a.5.5 0 000 1h5a.5.5 0 000-1zM7.5 21h-5a.5.5 0 000 1h5a.5.5 0 000-1z">
	            </path>
            </svg>
          </button>
        </div>

        <ul class="space-y-1 mt-4">
          <li>
            <a href="./WFAdvertiserDetails.html" data-nav-link
               class="flex items-center px-1 py-2 text-sm text-gray-700 hover:bg-blue-50 rounded-md">
              <img src="./assets/svgs/Details.svg" alt="Details" class="w-6 h-6 mr-2" />
              <span data-link-label>Overview</span>
            </a>
          </li>
          <li>
            <a href="./AdvertiserSalesOrder.html" data-nav-link
               class="flex items-center px-1 py-2 text-sm text-gray-700 hover:bg-blue-50 rounded-md">
              <img src="./assets/svgs/SalesOrderExpense.svg" alt="Sales Orders" class="w-6 h-6 mr-2" />
              <span data-link-label>Sales Orders</span>
            </a>
          </li>
          <li>
            <a href="./WFAdvertiserConnections.html" data-nav-link
               class="flex items-center px-1 py-2 text-sm text-gray-700 hover:bg-blue-50 rounded-md">
              <img src="./assets/svgs/Blueprint.svg" alt="Connections" class="w-6 h-6 mr-2" />
              <span data-link-label>Connections (P2)</span>
            </a>
          </li>
          <li>
            <a href="./AdvertiserCampaigns.html" data-nav-link
               class="flex items-center px-1 py-2 text-sm font-medium text-blue-700 bg-blue-50 rounded-md">
              <img src="./assets/svgs/CampaignsSchedules.svg" alt="Campaigns" class="w-6 h-6 mr-2" />
              <span data-link-label>Campaigns</span>
            </a>
          </li>
          <li>
            <a href="./AdvertiserAdGroup.html" data-nav-link class="flex items-center px-1 py-2 text-sm text-gray-700 hover:bg-blue-50 rounded-md">
              <img src="./assets/svgs/AdGroups.svg" class="w-6 h-6 mr-2" alt="">
              <span data-link-label>Ad Groups</span>
            </a>
          </li>
         
        </ul>
      </nav>

      <!-- Main Content -->
      <main class="flex-1 overflow-y-auto p-6">
       <div class="app-card rounded-lg shadow-lg overflow-hidden">
          <!-- Advertiser Header -->
          <div class="px-4 pt-4">
            <div class="flex items-start gap-4 mb-3">
              <div class="flex-1">
                <h1 data-bind="adv.name" class="text-xl md:text-2xl font-semibold text-gray-900">Loading…</h1>
                <div class="flex justify-between items-center">
                  <h3 class="text-sm font-semibold text-gray-600">Account #: <span data-bind="adv.account" class="text-sm text-gray-500">—</span></h3>
                  <h3 class="text-sm font-semibold text-gray-600">ID: <span data-bind="adv.id" class="text-sm text-gray-500">—</span></h3>
                </div>
              </div>
            </div>
            <hr class="app-divider mp-4"><!-- use themed divider -->
          </div>

          <!-- Page Header-->
          <div class="px-4 pt-5">
            <section class="space-y-2">
              <div class="flex items-center justify-between">
                <h1 class="text-2xl font-semibold text-gray-900 mx-2">CAMPAIGNS</h1>
              </div>
            </section>
          </div>

          <!-- Toolbar -->
          <div class="px-6 py-3">
            <div class="mb-4">
              <div class="flex items-center space-x-3 bg-[var(--tbl-head-bg)] border border-gray-300 rounded-md">
                <!-- New Campaign Button -->
                <button id="createBtn" class="flex items-center h-10 px-3 rounded-md hover:bg-gray-50 transition" title="Create New Campaign">
                  <span class="w-6 h-6 flex items-center justify-center rounded-full bg-white border border-gray-400 mr-2">
                  <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                  </svg>
                  </span>
                  <span class="text-sm font-medium text-gray-700">New Campaign</span>
                </button>

                <div class="h-6 border-l border-gray-400 mx-1"></div>
                
                <button id="manageCampaignGroupBtn" class="flex items-center h-10 px-3 rounded-md hover:bg-gray-50 transition" title="Manage Campaign Group">
                  <span class="w-6 h-6 flex items-center justify-center rounded-full bg-white border border-gray-400 mr-2">
                    <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2v0z"></path>
                    </svg>
                  </span>
                  <span class="text-sm font-medium text-gray-700">Manage Campaign Group</span>
                </button>

                <div class="h-6 border-l border-gray-400 mx-1"></div>

                <!-- Filters -->
                <div id="filtersGroup" class="flex items-center space-x-2">
                  <div class="flex items-center px-2 h-10 rounded-md">
                    <svg class="w-5 h-5 text-gray-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2a1 1 0 01.293.707l-6.707 8.707V21l-4-2v-4.586L2.707 6.707A1 1 0 013 6V4z"></path>
                    </svg>
                    
                    <!-- State Filter -->
                    <div class="relative">
                      <button id="stateChip" class="flex items-center h-8 px-3 rounded-md text-sm text-gray-700 hover:bg-gray-50 transition whitespace-nowrap" data-filter="state" title="State filter">
                        <span id="stateChipLabel">All</span>
                        <svg class="w-4 h-4 text-gray-500 ml-2" viewBox="0 0 20 20" fill="currentColor">
                          <path d="M5.23 7.21a.75.75 0 011.06 0L10 10.92l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.23 8.27a.75.75 0 010-1.06z"/>
                        </svg>
                      </button>
                      <div id="stateMenu" class="hidden absolute mt-2 left-0 bg-white border border-gray-200 rounded-md shadow-lg z-20 max-h-56 overflow-auto">
                        <button class="block w-full text-left px-4 py-1 text-sm text-gray-700 hover:bg-gray-100 whitespace-nowrap" data-value="All">All</button>
                        <button class="block w-full text-left px-4 py-1 text-sm text-gray-700 hover:bg-gray-100 whitespace-nowrap" data-value="Active">Active</button>
                        <button class="block w-full text-left px-4 py-1 text-sm text-gray-700 hover:bg-gray-100 whitespace-nowrap" data-value="Inactive">Inactive</button>
                      </div>
                    </div>

                    <!-- Connectors Filter -->
                    <div class="relative">
                      <button id="dspChip" class="flex items-center h-8 px-3 rounded-md text-sm text-gray-700 hover:bg-gray-50 transition whitespace-nowrap" data-filter="dsp" title="Connectors filter">
                        <span id="dspChipLabel">All</span>
                        <svg class="w-4 h-4 text-gray-500 ml-2 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                          <path d="M5.23 7.21a.75.75 0 011.06 0L10 10.92l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.23 8.27a.75.75 0 010-1.06z"/>
                        </svg>
                      </button>
                      <div id="dspMenu" class="hidden absolute mt-2 left-0 bg-white border border-gray-200 rounded-md shadow-lg z-20 max-h-56 overflow-auto min-w-max">
                        <button class="block w-full text-left px-4 py-1 text-sm text-gray-700 hover:bg-gray-100 whitespace-nowrap" data-value="All">All</button>
                        <button class="block w-full text-left px-4 py-1 text-sm text-gray-700 hover:bg-gray-100 whitespace-nowrap" data-value="Google Campaign Manager">Google Campaign Manager</button>
                        <button class="block w-full text-left px-4 py-1 text-sm text-gray-700 hover:bg-gray-100 whitespace-nowrap" data-value="Trade Desk">Trade Desk</button>
                        <button class="block w-full text-left px-4 py-1 text-sm text-gray-700 hover:bg-gray-100 whitespace-nowrap" data-value="DV360">DV360</button>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="h-6 border-l border-gray-400 mx-1"></div>

                <!-- Search -->
                <div class="relative">
                  <div class="search-container">
                    <div class="search-wrapper" id="searchWrapper" style="height:40px;">
                      <button id="searchToggle" class="search-icon" aria-label="Open search" type="button">
                        <svg viewBox="0 0 24 24">
                          <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                        </svg>
                      </button>
                      <input type="text" id="searchInput" class="search-input" placeholder="Enter ID, Connectors, or Campaign Name" autocomplete="off" aria-label="Search campaigns" />
                      <button id="searchClear" class="clear-button" aria-label="Clear search" type="button">
                        <svg viewBox="0 0 24 24">
                          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Table -->
           <div class="overflow-x-auto border border-default rounded-md">
             <table id="campaignTable" class="min-w-full table-fixed rounded-md overflow-hidden tbl tbl-row-hover tbl-row-alt">
               <thead class="tbl-head">
                  <tr>
                    <th scope="col" class="text-sm font-medium text-gray-700 uppercase tracking-wider border-r border-gray-200">
                      <button type="button" class="sort-btn flex w-full items-center px-6 py-2 space-x-2" data-sort-key="id">
                        <span>ID</span>
                      </button>
                    </th>
                    <th scope="col" class="text-sm font-medium text-gray-700 uppercase tracking-wider border-r border-gray-200">
                      <button type="button" class="sort-btn flex w-full items-center px-6 py-2 space-x-2" data-sort-key="name" aria-label="Sort by Name">
                        <span>Name</span>
                        <span class="sort-indicator text-xs text-gray-400" aria-hidden="true"></span>
                      </button>
                    </th>
                    <th scope="col" class="text-sm font-medium text-gray-700 uppercase tracking-wider border-r border-gray-200">
                      <button type="button" class="sort-btn flex w-full items-center px-6 py-2 space-x-2" data-sort-key="state" aria-label="Sort by State">
                        <span>State</span>
                        <span class="sort-indicator text-xs text-gray-400" aria-hidden="true"></span>
                      </button>
                    </th>
                    <th scope="col" class="text-sm font-medium text-gray-700 uppercase tracking-wider border-r border-gray-200">
                      <button type="button" class="sort-btn flex w-full items-center px-6 py-2 space-x-2" data-sort-key="dsp" aria-label="Sort by DSP">
                        <span>DSP</span>
                        <span class="sort-indicator text-xs text-gray-400" aria-hidden="true"></span>
                      </button>
                    </th>
                    <th scope="col" class="text-sm font-medium text-gray-700 uppercase tracking-wider border-r border-gray-200">
                      <button type="button" class="sort-btn flex w-full items-center px-6 py-2 space-x-2" data-sort-key="adServer" aria-label="Sort by Ad Server">
                        <span>Ad Server</span>
                        <span class="sort-indicator text-xs text-gray-400" aria-hidden="true"></span>
                      </button>
                    </th>
                    <th scope="col" class="text-sm font-medium text-gray-700 uppercase tracking-wider">
                      <button type="button" class="sort-btn flex w-full items-center px-6 py-2 space-x-2" data-sort-key="adGroups" aria-label="Sort by Ad Groups">
                        <span>Ad Groups</span>
                        <span class="sort-indicator text-xs text-gray-400" aria-hidden="true"></span>
                      </button>
                    </th>

                    <th scope="col" class="text-sm font-medium text-gray-700 uppercase tracking-wider">
  <span class="px-6 py-2 block">Actions</span>
</th>

                  </tr>
                </thead>
                <tbody id="campaignTableBody" class="divide-y">
                  <!-- Campaign rows will be populated by JavaScript -->
                </tbody>
              </table>
            </div>

            <!-- Footer -->
            <div class="mt-4 flex items-center justify-between text-xs text-gray-500">
              <span id="recordCount">0 of 0 showing</span>
              <div id="pagination" class="flex space-x-2">
                <!-- Pagination buttons will be populated by JavaScript -->
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Edit Campaign Group Modal -->
<div id="editGroupModal" class="hidden fixed inset-0 bg-black/50 items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
    <div class="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
      <h3 class="text-base font-semibold text-gray-900">Edit Campaign Group</h3>
      <button id="editGroupCloseX" class="p-1 rounded hover:bg-gray-100" aria-label="Close">
        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <div class="p-4">
      <label for="editGroupNameInput" class="block text-sm font-medium text-gray-700 mb-1">Group Name</label>
      <input id="editGroupNameInput" type="text" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter group name"/>
    </div>

    <div class="px-4 py-3 border-t border-gray-200 flex justify-end gap-2">
      <button id="editGroupCancelBtn" class="h-9 px-4 rounded-md border border-gray-300 bg-white text-gray-700 hover:bg-gray-50">Cancel</button>
      <button id="editGroupSaveBtn" class="h-9 px-4 rounded-md bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Save</button>
    </div>
  </div>
</div>

  <!-- Toast Container -->
  <div id="toastContainer" aria-live="polite" aria-atomic="true"></div>


<!-- Create Campaign Modal -->
<div id="createCampaignModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-6xl max-h-[90vh] p-6 relative">
    <button id="closeCampaignModal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>

    <h2 class="text-2xl font-bold text-gray-900 mb-4">Create New Campaign</h2>

    <form id="createCampaignForm" class="overflow-y-auto max-h-[75vh] pr-2">
      
      <!-- Beacon Fields Section -->
      <div class="mb-4">
        <h3 class="text-lg font-semibold text-gray-800 mb-3">Beacon Fields</h3>
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ID</label>
              <input type="text" id="beaconCampaignId" class="w-full border border-gray-300 rounded-md px-3 py-2 bg-gray-100 cursor-not-allowed focus:outline-none" readonly>
              <p class="text-xs text-gray-500 mt-1">Auto-generated campaign identifier</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Name *</label>
              <input type="text" id="beaconCampaignName" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
              <p class="text-xs text-gray-500 mt-1">Common identifier across all platforms</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Connectors Section -->
      <div class="mb-4">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-lg font-semibold text-gray-800">Connectors</h3>
          <button type="button" id="connectorsToggle" class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent bg-gray-200 transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" role="switch" aria-checked="false">
            <span aria-hidden="true" class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out translate-x-0"></span>
          </button>
        </div>
        <div id="connectorsContent" class="hidden">
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
              <!-- DSP Options -->
              <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">DSP (Data Service Provider)</label>
                <div class="flex flex-wrap gap-2">
                  <label class="flex items-center space-x-2 bg-white border border-gray-300 rounded-lg px-3 py-2 hover:border-blue-300 cursor-pointer transition-colors">
                    <input type="checkbox" id="dsp-trade-desk" name="dsp" value="trade-desk" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <span class="text-sm font-medium text-gray-700">The Trade Desk</span>
                  </label>
                  <label class="flex items-center space-x-2 bg-white border border-gray-300 rounded-lg px-3 py-2 hover:border-blue-300 cursor-pointer transition-colors">
                    <input type="checkbox" id="dsp-dv360" name="dsp" value="dv360" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <span class="text-sm font-medium text-gray-700">DV360</span>
                  </label>
                  <label class="flex items-center space-x-2 bg-white border border-gray-300 rounded-lg px-3 py-2 hover:border-blue-300 cursor-pointer transition-colors">
                    <input type="checkbox" id="dsp-simplifi" name="dsp" value="simplifi" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <span class="text-sm font-medium text-gray-700">Simplifi</span>
                  </label>
                </div>
              </div>

              <!-- Ad Server Options -->
              <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">Ad Server</label>
                <div class="flex flex-wrap gap-2">
                  <label class="flex items-center space-x-2 bg-white border border-gray-300 rounded-lg px-3 py-2 hover:border-green-300 cursor-pointer transition-colors">
                    <input type="checkbox" id="adserver-gcm" name="adserver" value="google-campaign-manager" class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded">
                    <span class="text-sm font-medium text-gray-700">Google Campaign Manager</span>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- DSP Fields Section (Trade Desk) -->
      <div id="dspFieldsSection" class="hidden mb-3">
        <div class="bg-white border border-blue-200 rounded-lg shadow-sm">
          <div class="bg-gradient-to-r from-blue-50 to-blue-100 px-4 py-3 border-b border-blue-200 rounded-t-lg">
            <h4 class="font-semibold text-blue-900 text-sm uppercase tracking-wide">DSP Fields • The Trade Desk</h4>
          </div>
          <div class="p-4">
            <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Seed</label>
                <select id="campaignSeed" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                  <option value="">-- Select Seed --</option>
                  <option value="Default Seed List">Default Seed List</option>
                </select>
              </div>
              <div class="xl:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">How would you like to organize your campaigns?</label>
                <select id="campaignOrganization" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                  <option value="">-- Select Organization --</option>
                  <option value="Create new campaign group">Create new campaign group</option>
                  <option value="Add campaigns to existing group">Add campaigns to existing group</option>
                  <option value="Do not create campaign group">Do not create campaign group</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Pace Ahead</label>
                <select id="campaignPacing" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                  <option value="">-- Select Pacing --</option>
                  <option value="Pace Ahead">Pace Ahead</option>
                  <option value="Pace Behind">Pace Behind</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Timezone</label>
                <select id="campaignTimezone" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                  <option value="">-- Select Timezone --</option>
                  <option value="UTC">UTC (Coordinated Universal Time)</option>
                  <option value="EST">EST (Eastern Standard Time)</option>
                  <option value="CST">CST (Central Standard Time)</option>
                  <option value="MST">MST (Mountain Standard Time)</option>
                  <option value="PST">PST (Pacific Standard Time)</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Start Date (UTC)</label>
                <input type="date" id="campaignStartDate" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">End Date (UTC)</label>
                <input type="date" id="campaignEndDate" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Campaign Channel</label>
                <select id="campaignChannel" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                  <option value="">-- Select Channel --</option>
                  <option value="Display">Display</option>
                  <option value="Video">Video</option>
                  <option value="Audio">Audio</option>
                  <option value="Native">Native</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Campaign Name</label>
                <select id="campaignName" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                  <option value="">-- Select Campaign Name --</option>
                  <option value="Brand Awareness">Brand Awareness</option>
                  <option value="Persona">Persona</option>
                  <option value="Company Targeting">Company Targeting</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Campaign Budget</label>
                <div class="relative">
                  <span class="absolute left-3 top-2 text-gray-500">$</span>
                  <input type="number" id="campaignBudget" class="w-full border border-gray-300 rounded-md pl-8 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="0.00" step="0.01" min="0">
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Campaign KPI</label>
                <select id="campaignKPI" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                  <option value="">-- Select KPI --</option>
                  <option value="Click-Through Rate (CTR)">Click-Through Rate (CTR)</option>
                  <option value="Cost Per Mille (CPM)">Cost Per Mille (CPM)</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">KPI Target</label>
                <div class="relative">
                  <input type="number" id="campaignKPITarget" class="w-full border border-gray-300 rounded-md pr-8 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="0.00" step="0.01" min="0">
                  <span class="absolute right-3 top-2 text-gray-500">%</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Ad Server Fields Section (Google Campaign Manager) -->
      <div id="adServerFieldsSection" class="hidden mb-3">
        <div class="bg-white border border-green-200 rounded-lg shadow-sm">
          <div class="bg-gradient-to-r from-green-50 to-green-100 px-4 py-3 border-b border-green-200 rounded-t-lg">
            <h4 class="font-semibold text-green-900 text-sm uppercase tracking-wide">Ad Server Fields • Google Campaign Manager</h4>
          </div>
          <div class="p-4">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Campaign Name</label>
                <select id="adServerCampaignName" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-green-500">
                  <option value="">-- Select Campaign Name --</option>
                  <option value="Brandawareness">Brand Awareness</option>
                  <option value="Persona">Persona</option>
                  <option value="Targeting">Targeting</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Schedule</label>
                <input type="date" id="adServerSchedule" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-green-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Landing Page Name</label>
                <input type="text" id="adServerLandingPageName" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="Enter landing page name">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Landing Page URL</label>
                <input type="text" id="adServerLandingPageURL" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="Enter any URL or value">
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="flex justify-end space-x-3 pt-3 border-t border-gray-200">
        <button type="button" id="cancelCampaignModal" class="px-6 py-2 text-sm text-gray-700 border border-gray-300 rounded-md hover:bg-gray-100 transition-colors">Cancel</button>
        <button type="submit" class="px-6 py-2 text-sm text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors">Create Campaign</button>
        <button type="button" id="createAndAddAdGroup" class="px-6 py-2 text-sm text-white bg-green-600 rounded-md hover:bg-green-700 transition-colors">Create & Add Ad Group</button>
      </div>
    </form>
  </div>
</div>



<!-- AUDIT DRAWER -->
<div id="auditDrawer" class="fixed right-0 bottom-0 z-50 flex justify-end transition transform translate-x-full bg-black bg-opacity-30" style="top: 56px; left: 0;">
  <div class="relative w-full max-w-2xl bg-white shadow-lg p-6 overflow-y-auto">
    <div class="flex justify-between items-center mb-2">
      <h2 class="text-lg font-semibold text-gray-900" data-audit-context>Manual Entry Log</h2>
      <button data-close-drawer class="text-gray-500 hover:text-gray-700">
        ✕
      </button>
    </div>
    <div class="-mx-2 my-2 border-b border-gray-300"></div>
    <div data-audit-list class="space-y-2 mb-4"></div>

<div class="mt-4">
  <div class="-mx-2 px-4 py-1 mb-2 text-xs font-semibold text-gray-600 uppercase rounded-md" style="background-color: #d1d5db;">
    Custom Instructions
  </div>
  <textarea id="customInstructions" rows="4" data-audit-notes class="block w-full border border-gray-300 rounded-md p-2 text-sm text-gray-900"></textarea>
</div>
    <div class="mt-4 flex justify-between">
      <button data-clear class="bg-red-100 text-red-700 px-4 py-2 text-sm rounded-md hover:bg-red-200">Clear</button>
      <button disabled class="bg-blue-600 text-white px-4 py-2 text-sm rounded-md opacity-80 cursor-not-allowed">Export (Coming Soon)</button>
    </div>
  </div>
</div>


  <script>
    // === CONFIGURATION ===
    const CONFIG = {
      STORAGE_KEYS: {
        DATA: 'campaign_tree_groups', // updated key for groups
        STATE_FILTER: 'campaign_state_filter',
        DSP_FILTER: 'campaign_dsp_filter'
      },
      PAGINATION: {
        DEFAULT_ROWS: 50,
        MAX_ROWS: 200
      }
    };

    // === SAMPLE GROUPED DATA (Tree) ===
    const DEFAULT_GROUPS = [
      {
        id: 'GRP-AUR',
        name: 'Aurora Launch',
        expanded: true,
        campaigns: [
          { id: 'CAM-001', name: 'Aurora Teaser', state: 'Active', dsp: 'DV360', adGroups: 4 },
          { id: 'CAM-002', name: 'Aurora Reveal', state: 'Inactive', dsp: 'Trade Desk', adGroups: 6 }
        ]
      },
      {
        id: 'GRP-HRV',
        name: 'Harvest Promo',
        expanded: true,
        campaigns: [
          { id: 'CAM-003', name: 'Autumn Offers', state: 'Active', dsp: 'Google Campaign Manager', adGroups: 3 },
          { id: 'CAM-004', name: 'Thanksgiving Push', state: 'Active', dsp: 'DV360', adGroups: 5 },
          { id: 'CAM-005', name: 'Weekend Harvest', state: 'Inactive', dsp: 'Trade Desk', adGroups: 2 },
          { id: 'CAM-006', name: 'Last Call Harvest', state: 'Active', dsp: 'Trade Desk, Google Campaign Manager', adGroups: 4 }
        ]
      }
    ];

    // === MAIN APPLICATION (Tree Table) ===
    let app = null;

    document.addEventListener('DOMContentLoaded', function() {
      app = {
        campaigns: [],
        groups: [],
        ungroupedExpanded: true,  // Track expand/collapse state for ungrouped section
        currentPage: 1,
        rowsPerPage: CONFIG.PAGINATION.DEFAULT_ROWS,
        filters: { state: 'All', dsp: 'All' },
        searchQuery: '',
        elements: {},
        searchExpanded: false,
        editingGroupId: null,

        init: function() {
          this.loadGroups();
          this.loadUngroupedState();
          this.cacheElements();
          this.loadFilters();
          this.initEventListeners();
          this.setupDragAndDrop();
          this.applyFiltersAndRender();
        },

        loadUngroupedState: function() {
          try {
            const stored = localStorage.getItem('ungrouped_expanded_state');
            if (stored !== null) {
              this.ungroupedExpanded = JSON.parse(stored);
            }
          } catch (e) {
            console.warn('Failed to load ungrouped state:', e);
            this.ungroupedExpanded = true; // Default to expanded
          }
        },

        loadGroups: function() {
          try {
            const stored = localStorage.getItem(CONFIG.STORAGE_KEYS.DATA);
            if (stored) {
              const data = JSON.parse(stored);
              // Handle both old and new data structures
              if (Array.isArray(data)) {
                // Old structure - convert to new
                this.campaigns = [];
                this.groups = Array.isArray(data) ? data : [];
              } else {
                // New structure
                this.campaigns = Array.isArray(data.campaigns) ? data.campaigns : [];
                this.groups = Array.isArray(data.groups) ? data.groups : [];
              }
            } else {
              this.campaigns = [];
              this.groups = JSON.parse(JSON.stringify(DEFAULT_GROUPS));
              this.saveGroups();
            }
            
            // Additional safety check to ensure groups is always an array
            if (!Array.isArray(this.groups)) {
              console.warn('Groups was not an array, resetting to default');
              this.groups = JSON.parse(JSON.stringify(DEFAULT_GROUPS));
            }
            if (!Array.isArray(this.campaigns)) {
              console.warn('Campaigns was not an array, resetting to empty');
              this.campaigns = [];
            }
          } catch (e) {
            console.warn('Failed to load groups:', e);
            this.campaigns = [];
            this.groups = JSON.parse(JSON.stringify(DEFAULT_GROUPS));
          }
        },

        saveGroups: function() {
          try {
            const data = {
              campaigns: this.campaigns || [],
              groups: this.groups || []
            };
            localStorage.setItem(CONFIG.STORAGE_KEYS.DATA, JSON.stringify(data));
          } catch (e) {
            console.warn('Failed to save data:', e);
          }
        },

        cacheElements: function() {
          const ids = [
            'menuButton','menuDropdown','notificationButton','notificationDropdown',
            'createBtn','manageCampaignGroupBtn','stateChip','stateChipLabel','stateMenu',
            'dspChip','dspChipLabel','dspMenu',
            'searchWrapper','searchToggle','searchInput','searchClear','filtersGroup',
            'campaignTableBody','recordCount','pagination',
            // Modal elements
            'editGroupModal','editGroupNameInput','editGroupSaveBtn','editGroupCancelBtn','editGroupCloseX'
          ];
          ids.forEach(id => this.elements[id] = document.getElementById(id));

          // Delegate toggles, edit and delete buttons on the tbody
          if (this.elements.campaignTableBody) {
            this.elements.campaignTableBody.addEventListener('click', (e) => {
              const toggleBtn = e.target.closest('[data-action="toggle-group"]');
              if (toggleBtn) {
                const gid = toggleBtn.getAttribute('data-group-id');
                const g = this.groups.find(x => x.id === gid);
                if (!g) return;
                g.expanded = !g.expanded;
                this.saveGroups();
                this.applyFiltersAndRender();
                return;
              }

              const toggleUngroupedBtn = e.target.closest('[data-action="toggle-ungrouped"]');
              if (toggleUngroupedBtn) {
                this.toggleUngrouped();
                return;
              }

              const editBtn = e.target.closest('[data-action="edit-group"]');
              if (editBtn) {
                const gid = editBtn.getAttribute('data-group-id');
                this.openEditGroupModal(gid);
                return;
              }

              const deleteBtn = e.target.closest('[data-action="delete-group"]');
              if (deleteBtn) {
                const gid = deleteBtn.getAttribute('data-group-id');
                this.deleteGroup(gid);
                return;
              }
            });
          }
        },

        initEventListeners: function() {
          const self = this;

          // Menu dropdown
          if (this.elements.menuButton) {
            this.elements.menuButton.addEventListener('click', function(e) {
              e.stopPropagation();
              self.elements.menuDropdown.classList.toggle('hidden');
            });
          }

          // Create button
if (this.elements.createBtn) {
  this.elements.createBtn.addEventListener('click', () => {
    const modal = document.getElementById('createCampaignModal');
    if (modal) {
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      
      // Reset form and state immediately (like ad groups)
      const form = document.getElementById('createCampaignForm');
      if (form) form.reset();
      
      // Reset connectors toggle
      const connectorsContent = document.getElementById('connectorsContent');
      const connectorsToggle = document.getElementById('connectorsToggle');
      
      if (connectorsToggle && connectorsContent) {
        connectorsToggle.classList.remove('bg-blue-600');
        connectorsToggle.classList.add('bg-gray-200');
        connectorsToggle.setAttribute('aria-checked', 'false');
        const toggleSpan = connectorsToggle.querySelector('span');
        if (toggleSpan) {
          toggleSpan.classList.remove('translate-x-5');
          toggleSpan.classList.add('translate-x-0');
        }
        connectorsContent.classList.add('hidden');
      }
      
      // Hide all expanded sections
      const dspFieldsSection = document.getElementById('dspFieldsSection');
      const adServerFieldsSection = document.getElementById('adServerFieldsSection');
      if (dspFieldsSection) dspFieldsSection.classList.add('hidden');
      if (adServerFieldsSection) adServerFieldsSection.classList.add('hidden');
      
      // Clear all checkboxes
      const allCheckboxes = document.querySelectorAll('#createCampaignModal input[type="checkbox"]');
      allCheckboxes.forEach(cb => cb.checked = false);
    }
  });
}

          // Manage Campaign Group button
if (this.elements.manageCampaignGroupBtn) {
  this.elements.manageCampaignGroupBtn.addEventListener('click', () => {
    this.createNewCampaignGroup();
  });
}

          // State filter
          if (this.elements.stateChip) {
            this.elements.stateChip.addEventListener('click', function(e) {
              e.stopPropagation();
              self.elements.stateMenu.classList.toggle('hidden');
              if (self.elements.dspMenu) self.elements.dspMenu.classList.add('hidden');
            });
          }
          if (this.elements.stateMenu) {
            this.elements.stateMenu.addEventListener('click', function(e) {
              const btn = e.target.closest('button'); if (!btn) return;
              const value = btn.dataset.value;
              if (self.elements.stateChipLabel) self.elements.stateChipLabel.textContent = value === 'All' ? 'All' : value;
              self.filters.state = value;
              localStorage.setItem(CONFIG.STORAGE_KEYS.STATE_FILTER, value);
              self.currentPage = 1;
              self.closeAllDropdowns();
              self.applyFiltersAndRender();
            });
          }

          // DSP filter
          if (this.elements.dspChip) {
            this.elements.dspChip.addEventListener('click', function(e) {
              e.stopPropagation();
              self.elements.dspMenu.classList.toggle('hidden');
              if (self.elements.stateMenu) self.elements.stateMenu.classList.add('hidden');
            });
          }
          if (this.elements.dspMenu) {
            this.elements.dspMenu.addEventListener('click', function(e) {
              const btn = e.target.closest('button'); if (!btn) return;
              const value = btn.dataset.value;
              if (self.elements.dspChipLabel) self.elements.dspChipLabel.textContent = value === 'All' ? 'All' : value;
              self.filters.dsp = value;
              localStorage.setItem(CONFIG.STORAGE_KEYS.DSP_FILTER, value);
              self.currentPage = 1;
              self.closeAllDropdowns();
              self.applyFiltersAndRender();
            });
          }

          // Search
          if (this.elements.searchToggle) {
            this.elements.searchToggle.addEventListener('click', function(e) {
              e.stopPropagation();
              if (!self.searchExpanded) {
                self.elements.searchWrapper.classList.add('expanded');
                self.searchExpanded = true;
                setTimeout(() => self.elements.searchInput && self.elements.searchInput.focus(), 100);
              }
            });
          }
          if (this.elements.searchInput) {
            this.elements.searchInput.addEventListener('input', function(e) {
              self.searchQuery = e.target.value;
              self.updateSearchState();
              self.currentPage = 1;
              self.applyFiltersAndRender();
            });
            
            // Prevent search from closing when clicking in the input
            this.elements.searchInput.addEventListener('click', function(e) {
              e.stopPropagation();
            });
          }
          if (this.elements.searchClear) {
            this.elements.searchClear.addEventListener('click', function(e) {
              e.stopPropagation();
              if (self.elements.searchInput) self.elements.searchInput.value = '';
              self.searchQuery = '';
              self.updateSearchState();
              self.currentPage = 1;
              self.applyFiltersAndRender();
            });
          }

          // Pagination
          if (this.elements.pagination) {
            this.elements.pagination.addEventListener('click', function(e) {
              const button = e.target.closest('button');
              if (!button || button.disabled) return;
              e.preventDefault();
              const action = button.dataset.action;
              const pageNum = parseInt(button.textContent);
              if (action === 'prev' && self.currentPage > 1) self.currentPage--;
              else if (action === 'next' && self.currentPage < self.getTotalPages()) self.currentPage++;
              else if (!isNaN(pageNum) && pageNum !== self.currentPage) self.currentPage = pageNum;
              self.applyFiltersAndRender();
            });
          }

          // Close on doc click
          document.addEventListener('click', function(e) { 
            // Don't close search if clicking inside search wrapper
            const clickedInsideSearch = self.elements.searchWrapper && self.elements.searchWrapper.contains(e.target);
            
            if (!clickedInsideSearch) {
              self.closeAllDropdowns();
              
              // Collapse search only when clicking outside and no text present
              if (self.searchExpanded && !self.searchQuery.trim()) {
                self.elements.searchWrapper?.classList.remove('expanded');
                self.searchExpanded = false;
                self.updateSearchState();
              }
            }
          });

          // Set initial filter labels
          if (this.elements.stateChipLabel) this.elements.stateChipLabel.textContent = this.filters.state === 'All' ? 'All' : this.filters.state;
          if (this.elements.dspChipLabel) this.elements.dspChipLabel.textContent = this.filters.dsp === 'All' ? 'All' : this.filters.dsp;

          // Modal events
          if (this.elements.editGroupSaveBtn) {
            this.elements.editGroupSaveBtn.addEventListener('click', () => this.saveEditGroupName());
          }
          if (this.elements.editGroupCancelBtn) {
            this.elements.editGroupCancelBtn.addEventListener('click', () => this.closeEditGroupModal());
          }
          if (this.elements.editGroupCloseX) {
            this.elements.editGroupCloseX.addEventListener('click', () => this.closeEditGroupModal());
          }
          if (this.elements.editGroupModal) {
            // Close when clicking overlay (outside the dialog)
            this.elements.editGroupModal.addEventListener('click', (e) => {
              if (e.target === this.elements.editGroupModal) this.closeEditGroupModal();
            });
          }
          if (this.elements.editGroupNameInput) {
            // Enable/disable Save based on changes
            this.elements.editGroupNameInput.addEventListener('input', () => this.updateEditGroupSaveState());
            // Enter to save, Esc to cancel
            this.elements.editGroupNameInput.addEventListener('keydown', (e) => {
              if (e.key === 'Enter') {
                e.preventDefault();
                if (!this.elements.editGroupSaveBtn.disabled) this.saveEditGroupName();
              }
              if (e.key === 'Escape') this.closeEditGroupModal();
            });
          }
        },

        loadFilters: function() {
          this.filters.state = localStorage.getItem(CONFIG.STORAGE_KEYS.STATE_FILTER) || 'All';
          this.filters.dsp = localStorage.getItem(CONFIG.STORAGE_KEYS.DSP_FILTER) || 'All';
        },

        closeAllDropdowns: function() {
          if (this.elements.menuDropdown) this.elements.menuDropdown.classList.add('hidden');
          if (this.elements.stateMenu) this.elements.stateMenu.classList.add('hidden');
          if (this.elements.dspMenu) this.elements.dspMenu.classList.add('hidden');
          if (this.elements.notificationDropdown) this.elements.notificationDropdown.classList.add('hidden');
          
          // Only collapse search if clicking outside AND no text present
          // This will be handled by the document click handler with proper targeting
        },

        updateSearchState: function() {
          const active = this.searchQuery.trim().length > 0;
          this.elements.searchClear?.classList.toggle('visible', active);
          if (this.elements.filtersGroup) {
            this.elements.filtersGroup.classList.toggle('opacity-50', active);
            this.elements.filtersGroup.classList.toggle('pointer-events-none', active);
          }
        },

        // Get live ad group count for a campaign
        getAdGroupCount: function(campaignId) {
          try {
            const adGroups = JSON.parse(localStorage.getItem('adgroups_data_v1') || '[]');
            return adGroups.filter(ag => {
              // Check multiple possible campaign reference formats
              const agCampaignId = ag.campaignId || ag.campaign;
              
              // Direct match
              if (agCampaignId === campaignId) return true;
              
              // Check if the ad group campaign is a campaign name and we need to match by name
              if (typeof agCampaignId === 'string') {
                // Try to find campaign by name to get the ID
                const campaignData = this.findCampaignByName(agCampaignId);
                if (campaignData && campaignData.id === campaignId) return true;
              }
              
              return false;
            }).length;
          } catch (e) {
            console.warn('Failed to count ad groups:', e);
            return 0;
          }
        },

        // Helper function to find campaign by name
        findCampaignByName: function(campaignName) {
          // Search in individual campaigns
          if (this.campaigns) {
            const found = this.campaigns.find(c => 
              c.beaconCampaignName === campaignName || c.name === campaignName
            );
            if (found) return found;
          }
          
          // Search in grouped campaigns
          for (const group of this.groups) {
            const found = group.campaigns.find(c => 
              c.beaconCampaignName === campaignName || c.name === campaignName
            );
            if (found) return found;
          }
          
          return null;
        },

        // Build visible rows (individual campaigns + group headers + children)
        getVisibleRows: function() {
          const q = this.searchQuery.trim().toLowerCase();
          const filterBy = (c) => {
            if (this.filters.state !== 'All' && c.state !== this.filters.state) return false;
            if (this.filters.dsp !== 'All' && (!c.dsp || !c.dsp.includes(this.filters.dsp))) return false;
            if (!q) return true;
            return (
              (c.id && c.id.toLowerCase().includes(q)) ||
              (c.beaconCampaignName && c.beaconCampaignName.toLowerCase().includes(q)) ||
              (c.name && c.name.toLowerCase().includes(q)) ||
              (c.dsp && c.dsp.toLowerCase().includes(q))
            );
          };

          const rows = [];
          
          // Add individual campaigns first (at the top)
          const individualCampaigns = this.campaigns ? this.campaigns.filter(filterBy) : [];
          
          // Always add ungrouped header, even if there are no campaigns
          rows.push({ 
            type: 'ungrouped-header', 
            name: 'Ungrouped Campaigns',
            campaignCount: individualCampaigns.length,
            expanded: this.ungroupedExpanded
          });
          
          // Only add campaigns if ungrouped section is expanded
          if (this.ungroupedExpanded) {
            for (const c of individualCampaigns) {
              // Update ad group count dynamically
              c.liveAdGroupCount = this.getAdGroupCount(c.id);
              rows.push({ type: 'campaign', groupId: null, campaign: c });
            }
          }
          
          // Then add groups
          for (const g of this.groups) {
            const groupMatchesSearch = q && g.name.toLowerCase().includes(q);
            const children = g.campaigns.filter(filterBy);
            const showGroup = groupMatchesSearch || children.length > 0 || !q; // always show when no search

            if (!showGroup) continue;

            rows.push({ type: 'group', groupId: g.id, name: g.name, expanded: g.expanded, childCount: children.length });

            if (g.expanded) {
              for (const c of children) {
                // Update ad group count dynamically
                c.liveAdGroupCount = this.getAdGroupCount(c.id);
                rows.push({ type: 'campaign', groupId: g.id, campaign: c });
              }
            }
          }
          return rows;
        },

        getCounts: function() {
          // total campaigns after filters/search (not paginated)
          const q = this.searchQuery.trim().toLowerCase();
          let total = 0;
          
          // Count individual campaigns
          if (this.campaigns) {
            for (const c of this.campaigns) {
              const matchesState = this.filters.state === 'All' || c.state === this.filters.state;
              const matchesDsp = this.filters.dsp === 'All' || (c.dsp && c.dsp.includes(this.filters.dsp));
              const matchesSearch = !q || (c.id?.toLowerCase().includes(q) || c.beaconCampaignName?.toLowerCase().includes(q) || c.name?.toLowerCase().includes(q) || c.dsp?.toLowerCase().includes(q));
              if (matchesState && matchesDsp && matchesSearch) total++;
            }
          }
          
          // Count grouped campaigns
          for (const g of this.groups) {
            for (const c of g.campaigns) {
              const matchesState = this.filters.state === 'All' || c.state === this.filters.state;
              const matchesDsp = this.filters.dsp === 'All' || (c.dsp && c.dsp.includes(this.filters.dsp));
              const matchesSearch = !q || (c.id?.toLowerCase().includes(q) || c.beaconCampaignName?.toLowerCase().includes(q) || c.name?.toLowerCase().includes(q) || c.dsp?.toLowerCase().includes(q) || g.name.toLowerCase().includes(q));
              if (matchesState && matchesDsp && matchesSearch) total++;
            }
          }
          return total;
        },

        getPaginatedData: function() {
          const visible = this.getVisibleRows();
          const start = (this.currentPage - 1) * this.rowsPerPage;
          const end = start + this.rowsPerPage;
          return { data: visible.slice(start, end), totalVisible: visible.length };
        },

        getTotalPages: function() {
          const total = this.getVisibleRows().length;
          return Math.max(1, Math.ceil(total / this.rowsPerPage));
        },

        applyFiltersAndRender: function() {
          const { data, totalVisible } = this.getPaginatedData();
          const totalPages = this.getTotalPages();
          if (this.currentPage > totalPages) this.currentPage = totalPages;
          if (this.currentPage < 1) this.currentPage = 1;

          this.renderTable(data);
          this.updateRecordCount(this.getCounts(), data.filter(r => r.type === 'campaign').length);
          this.renderPagination(totalVisible);
        },

        // Modal controls
        openEditGroupModal: function(groupId, isNewGroup = false) {
          const group = this.groups.find(g => g.id === groupId);
          if (!group) return;

          this.editingGroupId = groupId;
          this.isEditingNewGroup = isNewGroup || group.isNewlyCreated;
          
          if (this.elements.editGroupNameInput) {
            this.elements.editGroupNameInput.value = group.name || '';
            this.elements.editGroupNameInput.dataset.original = group.name || '';
          }
          if (this.elements.editGroupModal) {
            this.elements.editGroupModal.classList.remove('hidden');
            this.elements.editGroupModal.classList.add('flex');
          }
          // Focus input and select all text for easy editing
          setTimeout(() => {
            if (this.elements.editGroupNameInput) {
              this.elements.editGroupNameInput.focus();
              this.elements.editGroupNameInput.select();
            }
          }, 50);
          this.updateEditGroupSaveState();
        },

        closeEditGroupModal: function() {
          this.editingGroupId = null;
          this.isEditingNewGroup = false;
          if (this.elements.editGroupModal) {
            this.elements.editGroupModal.classList.add('hidden');
            this.elements.editGroupModal.classList.remove('flex');
          }
        },

        updateEditGroupSaveState: function() {
          if (!this.elements.editGroupNameInput || !this.elements.editGroupSaveBtn) return;
          const val = (this.elements.editGroupNameInput.value || '').trim();
          const orig = this.elements.editGroupNameInput.dataset.original || '';
          
          // For new groups, enable save as long as there's text
          // For existing groups, enable save only if text changed and not empty
          if (this.isEditingNewGroup) {
            this.elements.editGroupSaveBtn.disabled = (val.length === 0);
          } else {
            this.elements.editGroupSaveBtn.disabled = (val.length === 0 || val === orig);
          }
        },

        saveEditGroupName: function() {
          if (!this.editingGroupId || !this.elements.editGroupNameInput) return;
          const newName = this.elements.editGroupNameInput.value.trim();
          if (!newName) return;

          const group = this.groups.find(g => g.id === this.editingGroupId);
          if (!group) return;

          // === Track Edit Audit ===
const originalData = { ...group };
const updatedData = { ...group, name: newName };

try {
  audit.recordEdit({
    campaignId: group.id,
    entityType: 'campaign',
    entityId: group.id,
    before: originalData,
    after: updatedData
  });
} catch (err) {
  console.warn('Audit edit failed:', err);
}

          
          group.name = newName;
          // Clear the newly created flag since it's now been saved
          if (group.isNewlyCreated) {
            delete group.isNewlyCreated;
          }
          
          this.saveGroups();
          this.applyFiltersAndRender();
          this.closeEditGroupModal();
          if (typeof showToast === 'function') {
            const message = this.isEditingNewGroup ? 'Campaign Group created successfully' : 'Campaign Group name updated';
            showToast(message);
          }
        },

        setupDragAndDrop: function() {
          const tbody = this.elements.campaignTableBody;
          if (!tbody) return;

          // Handle drag start for campaign rows
          tbody.addEventListener('dragstart', (e) => {
            if (e.target.classList.contains('campaign-row')) {
              e.target.style.opacity = '0.5';
              e.dataTransfer.effectAllowed = 'move';
              e.dataTransfer.setData('text/plain', JSON.stringify({
                campaignId: e.target.dataset.campaignId,
                sourceGroupId: e.target.dataset.groupId
              }));
              
              // Add visual feedback to drop zones
              document.querySelectorAll('.group-drop-zone, .ungrouped-drop-zone').forEach(zone => {
                zone.style.backgroundColor = '#e0f2fe';
                zone.style.border = '2px dashed #0284c7';
              });
            }
          });

          // Handle drag end
          tbody.addEventListener('dragend', (e) => {
            if (e.target.classList.contains('campaign-row')) {
              e.target.style.opacity = '';
              
              // Remove visual feedback from drop zones
              document.querySelectorAll('.group-drop-zone, .ungrouped-drop-zone').forEach(zone => {
                zone.style.backgroundColor = '';
                zone.style.border = '';
              });
            }
          });

          // Handle drag over for group rows (to allow dropping)
          tbody.addEventListener('dragover', (e) => {
            if (e.target.closest('.group-drop-zone, .ungrouped-drop-zone')) {
              e.preventDefault();
              e.dataTransfer.dropEffect = 'move';
              
              // Add hover effect
              const dropZone = e.target.closest('.group-drop-zone, .ungrouped-drop-zone');
              dropZone.style.backgroundColor = '#bfdbfe';
            }
          });

          // Handle drag leave
          tbody.addEventListener('dragleave', (e) => {
            if (e.target.closest('.group-drop-zone, .ungrouped-drop-zone')) {
              const dropZone = e.target.closest('.group-drop-zone, .ungrouped-drop-zone');
              dropZone.style.backgroundColor = '#e0f2fe';
            }
          });

          // Handle drop
          tbody.addEventListener('drop', (e) => {
            e.preventDefault();
            const dropZone = e.target.closest('.group-drop-zone, .ungrouped-drop-zone');
            if (dropZone) {
              try {
                const dragData = JSON.parse(e.dataTransfer.getData('text/plain'));
                const targetGroupId = dropZone.dataset.groupId;
                
                if (dragData.campaignId && targetGroupId && dragData.sourceGroupId !== targetGroupId) {
                  this.moveCampaignToGroup(dragData.campaignId, dragData.sourceGroupId, targetGroupId);
                }
              } catch (error) {
                console.error('Failed to process drop:', error);
              }
              
              // Reset drop zone styling
              dropZone.style.backgroundColor = '';
              dropZone.style.border = '';
            }
          });
        },

        moveCampaignToGroup: function(campaignId, sourceGroupId, targetGroupId) {
          let campaignToMove = null;
          
          // Find and remove campaign from source location
          if (sourceGroupId === 'ungrouped') {
            // Remove from individual campaigns array
            const index = this.campaigns.findIndex(c => c.id === campaignId);
            if (index !== -1) {
              campaignToMove = this.campaigns.splice(index, 1)[0];
            }
          } else {
            // Remove from source group
            const sourceGroup = this.groups.find(g => g.id === sourceGroupId);
            if (sourceGroup) {
              const index = sourceGroup.campaigns.findIndex(c => c.id === campaignId);
              if (index !== -1) {
                campaignToMove = sourceGroup.campaigns.splice(index, 1)[0];
              }
            }
          }
          
          if (!campaignToMove) {
            console.error('Campaign not found:', campaignId);
            return;
          }
          
          // Add campaign to target location
          if (targetGroupId === 'ungrouped') {
            // Move to ungrouped campaigns
            if (!this.campaigns) this.campaigns = [];
            this.campaigns.unshift(campaignToMove);
            
            // Show success message
            if (typeof showToast === 'function') {
              showToast(`Campaign "${campaignToMove.beaconCampaignName || campaignToMove.name}" moved to ungrouped campaigns`);
            }
          } else {
            // Move to target group
            const targetGroup = this.groups.find(g => g.id === targetGroupId);
            if (targetGroup) {
              targetGroup.campaigns.push(campaignToMove);
              
              // Show success message
              if (typeof showToast === 'function') {
                showToast(`Campaign "${campaignToMove.beaconCampaignName || campaignToMove.name}" moved to "${targetGroup.name}"`);
              }
            } else {
              console.error('Target group not found:', targetGroupId);
              return;
            }
          }
          
          // Save changes
          this.saveGroups();
          
          // Refresh the display
          this.applyFiltersAndRender();
        },

        createNewCampaignGroup: function() {
          // Generate unique ID for new group
          const timestamp = Date.now();
          const newGroup = {
            id: `GRP-${timestamp}`,
            name: 'Campaign Group',
            expanded: true,
            campaigns: [],
            isNewlyCreated: true  // Mark as newly created
          };

          // Add the new group to the groups array
          this.groups.push(newGroup);
          
          // Save to localStorage
          this.saveGroups();
          
          // Re-render the table to show the new group
          this.applyFiltersAndRender();
          
          // Automatically open edit modal for the new group
          setTimeout(() => {
            this.openEditGroupModal(newGroup.id, true);  // Pass true for isNewGroup
          }, 100);
        },

        toggleUngrouped: function() {
          this.ungroupedExpanded = !this.ungroupedExpanded;
          
          // Save state to localStorage
          try {
            localStorage.setItem('ungrouped_expanded_state', JSON.stringify(this.ungroupedExpanded));
          } catch (e) {
            console.warn('Failed to save ungrouped state:', e);
          }
          
          this.applyFiltersAndRender();
        },

        deleteGroup: function(groupId) {
          const group = this.groups.find(g => g.id === groupId);
          if (!group) return;

          const campaignCount = group.campaigns?.length || 0;
          let message = `Are you sure you want to delete the campaign group "${group.name}"?`;
          if (campaignCount > 0) {
            message += `\n\nThis group contains ${campaignCount} campaign(s). The campaigns will be moved to the individual campaigns list (not grouped).`;
          }

          if (!confirm(message)) return;

          // Move campaigns to individual campaigns list
          if (group.campaigns && group.campaigns.length > 0) {
            if (!this.campaigns) this.campaigns = [];
            this.campaigns.unshift(...group.campaigns);
          }

          // Remove the group
          this.groups = this.groups.filter(g => g.id !== groupId);
          
          // Log deletion audit
          try {
            audit.recordDelete({
              entityType: 'campaignGroup',
              entityId: groupId,
              data: { name: group.name, campaignCount }
            });
          } catch (e) {
            console.warn('Failed to log group deletion audit:', e);
          }

          this.saveGroups();
          this.applyFiltersAndRender();
          if (typeof showToast === 'function') {
            showToast(`Campaign Group "${group.name}" deleted. ${campaignCount} campaign(s) moved to individual list.`);
          }
        },

        renderTable: function(rows) {
          const tbody = this.elements.campaignTableBody;
          if (!tbody) return;
          tbody.innerHTML = '';

          if (rows.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="6" class="px-6 py-4 text-center text-gray-500">No results</td>';
            tbody.appendChild(tr);
            return;
          }

          rows.forEach(r => {
            const tr = document.createElement('tr');

            if (r.type === 'ungrouped-header') {
              tr.innerHTML = `
  <td class="px-3 py-1 text-sm font-semibold bg-gray-100">
    <button data-action="toggle-ungrouped" class="w-4 h-4 inline-flex items-center justify-center rounded border border-strong bg-white mr-2" title="${r.expanded ? 'Collapse' : 'Expand'}">
      ${r.expanded ? '&minus;' : '+'}
    </button>
  </td>
  <td colspan="5" class="px-3 py-1 text-sm font-semibold bg-gray-100 drop-zone ungrouped-drop-zone" data-group-id="ungrouped">
    ${r.name} (${r.campaignCount})
  </td>
  <td class="px-6 py-1 text-sm bg-gray-100 text-center">
    <!-- No actions for ungrouped header -->
  </td>
`;
              tr.className = 'row-ungrouped-header ungrouped-drop-zone';
              tr.dataset.groupId = 'ungrouped';
            } else if (r.type === 'group') {
             tr.innerHTML = `
  <td class="px-3 py-1 text-sm font-semibold bg-gray-100">
    <button data-action="toggle-group" data-group-id="${r.groupId}" class="w-4 h-4 inline-flex items-center justify-center rounded border border-strong bg-white mr-2" title="${r.expanded ? 'Collapse' : 'Expand'}">
      ${r.expanded ? '&minus;' : '+'}
    </button>
  </td>
  <td colspan="5" class="px-3 py-1 text-sm font-semibold bg-gray-100 drop-zone" data-group-id="${r.groupId}">
    Campaign Group: ${r.name}
  </td>
  <td class="px-6 py-1 text-sm bg-gray-100 text-center flex gap-3 justify-center items-center">
    <button data-action="edit-group" data-group-id="${r.groupId}" class="text-blue-600 hover:underline" title="Edit Group Name">Edit</button>
    <button data-action="delete-group" data-group-id="${r.groupId}" class="text-red-600 hover:underline" title="Delete Group">Delete</button>
  </td>
`;
;
              tr.className = 'row-group group-drop-zone';
              tr.dataset.groupId = r.groupId;
            } else {
              const c = r.campaign;

tr.className = 'hover:bg-gray-50 campaign-row';
tr.draggable = true;
tr.dataset.campaignId = c.id;
tr.dataset.groupId = r.groupId || 'ungrouped';
tr.innerHTML = `
  <td class="px-6 py-1 whitespace-nowrap text-sm border-r border-default">${c.beaconCampaignId || c.id || ''}</td>
  <td class="px-6 py-1 whitespace-nowrap text-sm font-medium border-r border-default">
    <a href="./CampaignDetails.html?campaignId=${encodeURIComponent(c.id)}&campaignName=${encodeURIComponent(c.beaconCampaignName || c.name)}" class="text-blue-600 hover:underline">
      ${c.beaconCampaignName || c.name || ''}
    </a>
  </td>
  <td class="px-6 py-1 whitespace-nowrap text-sm border-r border-default">${c.state || ''}</td>
  <td class="px-6 py-1 whitespace-nowrap text-sm border-r border-default">${c.dsp || ''}</td>
  <td class="px-6 py-1 whitespace-nowrap text-sm border-r border-default">${c.adServer || ''}</td>
  <td class="px-6 py-1 whitespace-nowrap text-sm text-right tabular-nums border-r border-default">${c.liveAdGroupCount !== undefined ? c.liveAdGroupCount : (c.adGroups ?? 0)}</td>
`;
const tdActions = document.createElement('td');
tdActions.className = 'px-6 py-1 whitespace-nowrap text-sm text-center flex gap-3 justify-center items-center';

// Create Export link dynamically
const exportLink = document.createElement('a');
exportLink.href = '#';
exportLink.className = 'text-blue-600 hover:underline export-btn';
exportLink.textContent = 'Export';

const advData = JSON.parse(localStorage.getItem('adv_selected_data') || '{}');
exportLink.dataset.export = true;
exportLink.dataset.campaignId = c.id;
exportLink.dataset.advName = advData.name || 'Unknown Advertiser';
exportLink.dataset.advAccount = advData.account || '—';

// Create Delete button
const deleteBtn = document.createElement('button');
deleteBtn.className = 'text-red-600 hover:underline delete-campaign';
deleteBtn.dataset.id = c.id;
deleteBtn.textContent = 'Delete';

// Add both to Actions column
tdActions.appendChild(exportLink);
tdActions.appendChild(deleteBtn);
tr.appendChild(tdActions);
            }

            this.elements.campaignTableBody.appendChild(tr);
          });
        },

        updateRecordCount: function(filteredCampaignsTotal, showingCampaignRows) {
          if (this.elements.recordCount) {
            this.elements.recordCount.textContent = `${showingCampaignRows} of ${filteredCampaignsTotal} campaigns showing`;
          }
        },

        renderPagination: function(totalVisibleRows) {
          const pager = this.elements.pagination;
          if (!pager) return;

          if (totalVisibleRows <= this.rowsPerPage) {
            pager.style.display = 'none';
            return;
          }
          pager.style.display = 'flex';

          const totalPages = this.getTotalPages();
          const buttons = [];
          const prevDisabled = this.currentPage === 1;
          buttons.push(`<button data-action="prev" class="px-2 py-1 text-gray-700 hover:bg-gray-200 rounded-md${prevDisabled ? ' opacity-50 cursor-not-allowed' : ''}" ${prevDisabled ? 'disabled' : ''}>&lt;</button>`);

          const maxButtons = 5;
          let start = Math.max(1, this.currentPage - Math.floor(maxButtons / 2));
          let end = Math.min(totalPages, start + maxButtons - 1);
          if (end - start + 1 < maxButtons) start = Math.max(1, end - maxButtons + 1);

          for (let p = start; p <= end; p++) {
            const active = (p === this.currentPage) ? 'bg-gray-200 font-medium' : '';
            buttons.push(`<button class="px-2 py-1 ${active} text-gray-700 hover:bg-gray-200 rounded-md">${p}</button>`);
          }

          const nextDisabled = this.currentPage === totalPages;
          buttons.push(`<button data-action="next" class="px-2 py-1 text-gray-700 hover:bg-gray-200 rounded-md${nextDisabled ? ' opacity-50 cursor-not-allowed' : ''}" ${nextDisabled ? 'disabled' : ''}>&gt;</button>`);
          pager.innerHTML = buttons.join('');
        }
      };

      app.init();
    });
  </script>

  <!-- Data binding script for advertiser info -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Load advertiser data for the header
      try {
        const selectedData = localStorage.getItem('adv_selected_data');
        if (selectedData) {
          const advertiser = JSON.parse(selectedData);
          
          // Bind advertiser data to header elements
          const nameEl = document.querySelector('[data-bind="adv.name"]');
          const accountEl = document.querySelector('[data-bind="adv.account"]');
          const idEl = document.querySelector('[data-bind="adv.id"]');
          
          if (nameEl) nameEl.textContent = advertiser.name || 'Unknown Advertiser';
          if (accountEl) accountEl.textContent = advertiser.account || '—';
          if (idEl) idEl.textContent = advertiser.id || '—';
          
          // Populate breadcrumbs
          const breadcrumbAdvertiser = document.getElementById('breadcrumbAdvertiser');
          if (breadcrumbAdvertiser) {
            breadcrumbAdvertiser.textContent = `Advertiser: ${advertiser.name || 'Unknown'}`;
            breadcrumbAdvertiser.href = `./WFAdvertiserDetails.html?advertiserId=${advertiser.id}`;
          }
        }
      } catch (e) {
        console.warn('Failed to load advertiser data:', e);
      }
    });


// Delete campaign handler
document.addEventListener('click', (e) => {
  const btn = e.target.closest('.delete-campaign');
  if (!btn) return;

  const campaignId = btn.dataset.id;
  if (!campaignId) return;

  if (!confirm(`Are you sure you want to delete Campaign ID "${campaignId}"?`)) return;

  // Delete from individual campaigns list
  if (app.campaigns) {
    app.campaigns = app.campaigns.filter(c => c.id !== campaignId);
  }

  // Delete from grouped campaigns
  app.groups.forEach(group => {
    group.campaigns = group.campaigns.filter(c => c.id !== campaignId);
  });

  app.saveGroups?.();
  app.applyFiltersAndRender?.();
});

// Show / hide modal handlers
document.addEventListener('DOMContentLoaded', () => {
  // Get connector elements
  const connectorsToggle = document.getElementById('connectorsToggle');
  const connectorsContent = document.getElementById('connectorsContent');
  const dspCheckboxes = document.querySelectorAll('input[name="dsp"]');
  const adServerCheckboxes = document.querySelectorAll('input[name="adserver"]');
  
  // Get field sections
  const dspFieldsSection = document.getElementById('dspFieldsSection');
  const adServerFieldsSection = document.getElementById('adServerFieldsSection');

  // Toggle state
  let connectorsEnabled = false;

  // Toggle functionality
  function toggleConnectors() {
    connectorsEnabled = !connectorsEnabled;
    
    // Update toggle appearance
    if (connectorsEnabled) {
      connectorsToggle.classList.remove('bg-gray-200');
      connectorsToggle.classList.add('bg-blue-600');
      connectorsToggle.setAttribute('aria-checked', 'true');
      connectorsToggle.querySelector('span').classList.remove('translate-x-0');
      connectorsToggle.querySelector('span').classList.add('translate-x-5');
      connectorsContent.classList.remove('hidden');
    } else {
      connectorsToggle.classList.remove('bg-blue-600');
      connectorsToggle.classList.add('bg-gray-200');
      connectorsToggle.setAttribute('aria-checked', 'false');
      connectorsToggle.querySelector('span').classList.remove('translate-x-5');
      connectorsToggle.querySelector('span').classList.add('translate-x-0');
      connectorsContent.classList.add('hidden');
      
      // Clear selections and hide fields when toggling off
      dspCheckboxes.forEach(cb => cb.checked = false);
      adServerCheckboxes.forEach(cb => cb.checked = false);
      updateFieldsDisplay();
    }
  }

  function updateFieldsDisplay() {
    const tradeDeskSelected = document.getElementById('dsp-trade-desk')?.checked;
    const gcmSelected = document.getElementById('adserver-gcm')?.checked;

    // Show/hide DSP fields (only for Trade Desk)
    if (tradeDeskSelected) {
      dspFieldsSection?.classList.remove('hidden');
    } else {
      dspFieldsSection?.classList.add('hidden');
    }

    // Show/hide Ad Server fields (only for Google Campaign Manager)
    if (gcmSelected) {
      adServerFieldsSection?.classList.remove('hidden');
    } else {
      adServerFieldsSection?.classList.add('hidden');
    }
  }

  // Event listeners for modal
  connectorsToggle?.addEventListener('click', toggleConnectors);

  // Simple event listeners for opening/closing modal (like ad groups)
  const createBtn = document.getElementById('createBtn');
  if (createBtn && !createBtn.hasCustomListener) {
    createBtn.hasCustomListener = true; // Prevent duplicate listeners
    createBtn.addEventListener('click', () => {
      const modal = document.getElementById('createCampaignModal');
      if (modal) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        
        // Reset immediately inline (no delays, no async)
        const form = document.getElementById('createCampaignForm');
        if (form) form.reset();
        
        // Generate and display Campaign ID
        const campaignIdField = document.getElementById('beaconCampaignId');
        if (campaignIdField) {
          campaignIdField.value = 'CAM-' + Math.random().toString(36).substr(2, 6).toUpperCase();
        }
        
        // Reset connectors
        const connectorsContent = document.getElementById('connectorsContent');
        if (connectorsContent) connectorsContent.classList.add('hidden');
        if (connectorsToggle) {
          connectorsEnabled = false;
          connectorsToggle.classList.remove('bg-blue-600');
          connectorsToggle.classList.add('bg-gray-200');
          connectorsToggle.setAttribute('aria-checked', 'false');
          const toggleSpan = connectorsToggle.querySelector('span');
          if (toggleSpan) {
            toggleSpan.classList.remove('translate-x-5');
            toggleSpan.classList.add('translate-x-0');
          }
        }
        
        // Hide sections
        const dspFieldsSection = document.getElementById('dspFieldsSection');
        const adServerFieldsSection = document.getElementById('adServerFieldsSection');
        if (dspFieldsSection) dspFieldsSection.classList.add('hidden');
        if (adServerFieldsSection) adServerFieldsSection.classList.add('hidden');
        
        // Clear checkboxes
        document.querySelectorAll('#createCampaignModal input[type="checkbox"]').forEach(cb => cb.checked = false);
        
        // Update fields display
        updateFieldsDisplay();
      }
    });
  }

  document.getElementById('closeCampaignModal')?.addEventListener('click', () => {
    document.getElementById('createCampaignModal')?.classList.add('hidden');
    document.getElementById('createCampaignModal')?.classList.remove('flex');
  });

  document.getElementById('cancelCampaignModal')?.addEventListener('click', () => {
    document.getElementById('createCampaignModal')?.classList.add('hidden');
    document.getElementById('createCampaignModal')?.classList.remove('flex');
  });

  // Add event listeners for connector checkboxes
  dspCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', updateFieldsDisplay);
  });
  
  adServerCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', updateFieldsDisplay);
  });

  // Initialize display state
  updateFieldsDisplay();
});

// Add global storage listener to refresh campaign list when ad groups change
window.addEventListener('storage', function(e) {
  if (e.key === 'adgroups_data_v1' && app) {
    console.log('📊 Ad groups data changed, refreshing campaign list...');
    app.applyFiltersAndRender?.();
  }
});

// Add custom event listener for same-tab updates
window.addEventListener('adGroupsUpdated', function(e) {
  if (app) {
    console.log('📊 Ad groups updated in same tab, refreshing campaign list...');
    app.applyFiltersAndRender?.();
  }
});

// Function to trigger ad group update event (for use by other pages)
window.triggerAdGroupUpdate = function() {
  window.dispatchEvent(new CustomEvent('adGroupsUpdated'));
};

// Create campaign logic
document.getElementById('createCampaignForm').addEventListener('submit', function (e) {
  e.preventDefault();
  handleCampaignCreation(false);
});

// Handle "Create & Add Ad Group" button
document.getElementById('createAndAddAdGroup')?.addEventListener('click', function() {
  // Validate the form first
  const form = document.getElementById('createCampaignForm');
  if (!form.checkValidity()) {
    form.reportValidity();
    return;
  }
  handleCampaignCreation(true);
});

// Unified campaign creation handler
function handleCampaignCreation(redirectToAdGroups) {
  // Get selected connectors
  const selectedDSP = Array.from(document.querySelectorAll('input[name="dsp"]:checked')).map(cb => cb.value);
  const selectedAdServer = Array.from(document.querySelectorAll('input[name="adserver"]:checked')).map(cb => cb.value);
  
  // Debug: Log form field values
  console.log('🔍 Form field values during creation:');
  console.log('beaconCampaignName:', document.getElementById('beaconCampaignName')?.value);
  console.log('campaignName:', document.getElementById('campaignName')?.value);
  console.log('campaignSeed:', document.getElementById('campaignSeed')?.value);
  console.log('campaignBudget:', document.getElementById('campaignBudget')?.value);
  
  // Create separate DSP and Ad Server display strings
  const dspLabels = {
    'trade-desk': 'Trade Desk',
    'dv360': 'DV360',
    'simplifi': 'Simplifi'
  };
  const adServerLabels = {
    'google-campaign-manager': 'Google Campaign Manager'
  };
  
  const dspList = [];
  const adServerList = [];
  
  selectedDSP.forEach(dsp => {
    if (dspLabels[dsp]) {
      dspList.push(dspLabels[dsp]);
    }
  });
  selectedAdServer.forEach(adServer => {
    if (adServerLabels[adServer]) {
      adServerList.push(adServerLabels[adServer]);
    }
  });
  
  const dspDisplay = dspList.length > 0 ? dspList.join(', ') : '';
  const adServerDisplay = adServerList.length > 0 ? adServerList.join(', ') : '';
  
  // Get current advertiser ID
  const advData = JSON.parse(localStorage.getItem('adv_selected_data') || '{}');
  const advertiserId = advData.id || null;
  
  const campaign = {
    id: 'CAM-' + Date.now(),
    advertiserId: advertiserId, // Track which advertiser this campaign belongs to
    name: document.getElementById('campaignName')?.value || '',
    seed: document.getElementById('campaignSeed')?.value || '',
    organization: document.getElementById('campaignOrganization')?.value || '',
    pacing: document.getElementById('campaignPacing')?.value || '',
    timezone: document.getElementById('campaignTimezone')?.value || '',
    startDate: document.getElementById('campaignStartDate')?.value || '',
    endDate: document.getElementById('campaignEndDate')?.value || '',
    channel: document.getElementById('campaignChannel')?.value || '',
    budget: document.getElementById('campaignBudget')?.value || '0',
    kpi: document.getElementById('campaignKPI')?.value || '',
    kpiTarget: document.getElementById('campaignKPITarget')?.value || '',
    state: 'Active',
    dsp: dspDisplay, // Only contains DSP selections
    adServer: adServerDisplay, // Only contains Ad Server selections
    adGroups: 0, // Initialize with 0 - will be updated dynamically by live count
    // Beacon Fields mapped to Common Data
    beaconCampaignId: document.getElementById('beaconCampaignId')?.value || '',
    beaconCampaignName: document.getElementById('beaconCampaignName')?.value || '',
    // New Ad Server fields
    adServerCampaignName: document.getElementById('adServerCampaignName')?.value || '',
    adServerSchedule: document.getElementById('adServerSchedule')?.value || '',
    adServerLandingPageName: document.getElementById('adServerLandingPageName')?.value || '',
    adServerLandingPageURL: document.getElementById('adServerLandingPageURL')?.value || '',
    // Connector information
    connectors: {
      dsp: selectedDSP,
      adServer: selectedAdServer
    }
  };

  console.log('🔍 Created campaign object:', campaign);

  const raw = localStorage.getItem('campaign_tree_groups');
  let data = raw ? JSON.parse(raw) : { campaigns: [], groups: [] };

  // Ensure the data structure has both campaigns and groups arrays
  if (!data.campaigns) data.campaigns = [];
  if (!data.groups) data.groups = [];

  // Add campaign directly to the top-level campaigns array
  data.campaigns.unshift(campaign);

  console.log('🔍 Updated campaigns data:', data.campaigns);

  // Log creation to audit
  audit.recordCreate({
    campaignId: campaign.id,
    entityType: 'campaign',
    entityId: campaign.id,
    data: {
      beaconCampaignName: campaign.beaconCampaignName,
      seed: campaign.seed,
      organization: campaign.organization,
      pacing: campaign.pacing,
      timezone: campaign.timezone,
      startDate: campaign.startDate,
      endDate: campaign.endDate,
      channel: campaign.channel,
      campaignName: campaign.name,
      budget: campaign.budget,
      kpi: campaign.kpi,
      kpiTarget: campaign.kpiTarget,
      campaignStartDate: campaign.startDate,
      campaignEndDate: campaign.endDate,
      campaignTotalBudget: campaign.totalBudget,
      campaignDailyBudget: campaign.dailyBudget,
      targetAudience: campaign.targetAudience,
      geoTargeting: campaign.geoTargeting,
      deviceTargeting: campaign.deviceTargeting,
      // Beacon fields
      beaconCampaignId: campaign.beaconCampaignId,
      beaconCampaignName: campaign.beaconCampaignName,
      // Ad Server fields in audit
      adServerCampaignName: campaign.adServerCampaignName,
      adServerSchedule: campaign.adServerSchedule,
      adServerLandingPageName: campaign.adServerLandingPageName,
      adServerLandingPageURL: campaign.adServerLandingPageURL,
      connectors: campaign.connectors
    }
  });
  console.log('✔️ Audit log created for:', campaign.id);

  localStorage.setItem('campaign_tree_groups', JSON.stringify(data));

  // Update app instance to reflect new data
  if (app) {
    app.campaigns = Array.isArray(data.campaigns) ? data.campaigns : [];
    app.groups = Array.isArray(data.groups) ? data.groups : [];
    app.applyFiltersAndRender?.();
  }

  // Close modal first
  const modal = document.getElementById('createCampaignModal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    console.log('✅ Modal closed after campaign creation');
  }

  // If redirecting to ad groups
  if (redirectToAdGroups) {
    window.location.href = `./AdvertiserAdGroup.html?newCampaign=${campaign.id}`;
  }
}

document.addEventListener('DOMContentLoaded', function () {
  document.addEventListener('click', function (e) {
    const exportBtn = e.target.closest('[data-export]');
    if (!exportBtn) return;

    e.preventDefault();
    const campaignId = exportBtn.dataset.campaignId;
    const advName = exportBtn.dataset.advName;
    const advAccount = exportBtn.dataset.advAccount;

    if (!campaignId) {
      alert("Missing campaign ID for audit drawer.");
      return;
    }

    audit.openDrawer({
      campaignId,
      advertiserName: advName,
      advertiserAccount: advAccount
    });
  });
});






  </script>
</body>
</html>